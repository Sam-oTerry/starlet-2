rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.email == 'admin@starletproperties.ug' ||
        request.auth.token.email == 'admin@starlet.co.ug' ||
        request.auth.token.email == 'admin@starletproperties.ug'
      );
    }
    
    // Users collection - More permissive for app functionality
    match /users/{userId} {
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow delete: if isAdmin(); // Only allow deletion through admin panel
      
      // User subcollections - Allow users to access their saved listings
      match /savedListings/{listingId} {
        allow read, write: if isOwner(userId);
      }
      
      match /notifications/{notificationId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Listings collection
    match /listings/{listingId} {
      allow read: if true; // Public read access for listings
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == resource.data.agentId ||
         isAdmin());
      allow delete: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == resource.data.agentId ||
         isAdmin());
    }
    
    // Conversations/Chats collection
    match /conversations/{conversationId} {
      allow read, write: if isAuthenticated() && 
        (request.auth.uid in resource.data.participants || isAdmin());
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read, write: if isAuthenticated() && 
          (request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants || isAdmin());
      }
      
      // Typing subcollection
      match /typing/{userId} {
        allow read, write: if isAuthenticated() && 
          (request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants || isAdmin());
      }
    }
    
    // Chats collection (alternative messaging structure)
    match /chats/{chatId} {
      allow read, write: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read, write: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
      
      // Typing subcollection
      match /typing/{userId} {
        allow read, write: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }
    
    // Inquiries collection
    match /inquiries/{inquiryId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == resource.data.assignedTo);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == resource.data.assignedTo);
      allow delete: if false;
    }
    
    // Stores collection
    match /stores/{storeId} {
      allow read: if true; // Public read access for stores
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (request.auth.uid == resource.data.agentId ||
         isAdmin());
      allow delete: if isAdmin();
    }
    
    // Agent Stores collection
    match /agentStores/{storeId} {
      allow read: if true; // Public read access
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        request.auth.uid == resource.data.agentId;
      allow delete: if false;
    }
    
    // Vehicle data collections
    match /vehicleMakesModels/{docId} {
      allow read: if true;
      allow write: if false; // Only allow through admin panel
    }
    
    match /vehicleMakes/{makeId} {
      allow read: if true;
      allow write: if false; // Only allow through admin panel
      
      match /models/{modelId} {
        allow read: if true;
        allow write: if false; // Only allow through admin panel
      }
    }
    
    match /vehicleModels/{modelId} {
      allow read: if true;
      allow write: if false; // Only allow through admin panel
    }
    
    // Property metadata
    match /propertyMeta/{docId} {
      allow read: if true;
      allow write: if false; // Only allow through admin panel
    }
    
    // Presence collection (for online status)
    match /presence/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read, write: if isAuthenticated() && 
        request.auth.uid == resource.data.userId;
    }
    
    // Resources collection (educational content)
    match /resources/{resourceId} {
      allow read: if true; // Public read access
      allow write: if false; // Only allow through admin panel
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if true; // Public read access
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Messages collection (standalone messages)
    match /messages/{messageId} {
      allow read, write: if isAuthenticated() && 
        (request.auth.uid == resource.data.senderId || 
         request.auth.uid == resource.data.recipientId);
    }
    
    // Admin dashboard access - allow admin to read all documents for statistics
    match /{collection}/{document} {
      allow read: if isAdmin() && (
        collection == 'listings' ||
        collection == 'users' ||
        collection == 'stores' ||
        collection == 'conversations' ||
        collection == 'reviews' ||
        collection == 'inquiries'
      );
    }
    
    // Default rule - deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 