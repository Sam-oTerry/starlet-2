<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxury 4-Bedroom House in Karen | StarLet Marketplace</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            /* Primary Colors */
            --primary-dark: #001F3F;    /* Midnight Blue */
            --primary-main: #007BFF;    /* Electric Blue */
            --accent-gold: #FFD700;      /* Star Gold */
            --accent-cyan: #00FFFF;     /* Neon Cyan */
            --bg-white: #F5F7FA;        /* Ice White */
            --neutral-dark: #2C3E50;     /* Charcoal Gray */
            --neutral-medium: #7F8C8D;
            --neutral-light: #BDC3C7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--neutral-dark);
            background-color: var(--bg-white);
        }

        /* Header */
        header.bg {
            background-color: var(--primary-dark);
            border-bottom: 3px solid var(--accent-gold);
        }

        .navbar-dark .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
        }

        .navbar-dark .navbar-nav .nav-link:hover {
            color: var(--accent-cyan);
        }

        .navbar-dark .navbar-nav .nav-link.active {
            color: var(--accent-gold);
            font-weight: 600;
        }

        /* Product Gallery */
        .product-gallery {
            margin-bottom: 2rem;
        }

        .main-image {
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
            height: 400px;
            background-color: #f8f9fa;
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumbnail-container {
            display: flex;
            gap: 0.75rem;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .thumbnail:hover, .thumbnail.active {
            border-color: var(--primary-main);
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Product Details */
        .product-header {
            margin-bottom: 1.5rem;
        }

        .product-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .product-location {
            color: var(--neutral-medium);
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-main);
            margin-bottom: 1.5rem;
        }

        .product-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .meta-icon {
            color: var(--primary-main);
            font-size: 1.25rem;
        }

        .product-actions {
            margin-bottom: 2rem;
        }

        .btn-primary {
            background-color: var(--primary-main);
            border-color: var(--primary-main);
            font-weight: 600;
            padding: 0.75rem 1.5rem;
        }

        .btn-outline-primary {
            color: var(--primary-main);
            border-color: var(--primary-main);
            font-weight: 600;
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-main);
            color: white;
        }

        .btn-gold {
            background-color: var(--accent-gold);
            color: var(--primary-dark);
            font-weight: 700;
            border: none;
        }

        .btn-gold:hover {
            background-color: #e6c300;
            color: var(--primary-dark);
        }

        /* Product Tabs */
        .product-tabs {
            margin: 3rem 0;
        }

        .nav-tabs .nav-link {
            color: var(--neutral-dark);
            font-weight: 600;
            padding: 1rem 1.5rem;
            border: none;
            position: relative;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-main);
            background-color: transparent;
        }

        .nav-tabs .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-main), var(--accent-cyan));
        }

        .tab-content {
            padding: 2rem 0;
        }

        /* Features List */
        .features-list {
            columns: 2;
            column-gap: 2rem;
        }

        .features-list li {
            margin-bottom: 0.75rem;
            break-inside: avoid;
        }

        /* Agent Card */
        .agent-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .agent-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .agent-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            overflow: hidden;
        }

        .agent-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .agent-info h5 {
            margin-bottom: 0.25rem;
            font-weight: 700;
        }

        .agent-info p {
            color: var(--neutral-medium);
            margin-bottom: 0;
        }

        .agent-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.5rem 1rem;
            background-color: var(--bg-white);
            border-radius: 4px;
        }

        .stat-item h6 {
            font-size: 1.25rem;
            margin-bottom: 0;
            color: var(--primary-main);
        }

        .stat-item p {
            font-size: 0.75rem;
            color: var(--neutral-medium);
            margin-bottom: 0;
        }

        /* Similar Listings */
        .similar-listings {
            margin: 3rem 0;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            position: relative;
            display: inline-block;
        }

        .section-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -8px;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-main), var(--accent-cyan));
            border-radius: 2px;
        }

        .listing-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .listing-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 123, 255, 0.15);
        }

        .card-img-wrapper {
            position: relative;
            overflow: hidden;
            padding-top: 66.67%;
            background: var(--bg-white);
        }

        .card-img-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .listing-card:hover .card-img-top {
            transform: scale(1.05);
        }

        .type-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: var(--primary-main);
            color: white;
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .price-tag {
            position: absolute;
            bottom: 12px;
            left: 12px;
            background: rgba(0, 31, 63, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--primary-dark);
        }

        .location {
            color: var(--neutral-medium);
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .stats {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--neutral-medium);
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .stats span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Footer */
        footer.bg {
            background-color: var(--primary-dark);
            color: white;
            padding: 4rem 0 2rem;
            position: relative;
        }

        footer::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-cyan));
        }

        /* Responsive */
        @media (max-width: 768px) {
            .features-list {
                columns: 1;
            }
            
            .product-meta {
                gap: 1rem;
            }
            
            .main-image {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar (copied from index.html, paths adjusted for /pages/properties/) -->
    <nav class="navbar navbar-expand-lg navbar-custom modern-navbar shadow-sm py-3 sticky-top w-100">
      <div class="d-flex flex-row align-items-center justify-content-between w-100 px-3 px-md-4">
        <!-- Brand Left -->
        <a class="navbar-brand d-flex align-items-center gap-2 me-4 py-0" href="../../index.html">
          <span class="brand-star">Star</span> <span class="brand-let">Let</span>
        </a>
        <!-- Toggler for mobile -->
        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse flex-grow-1" id="navbarNav">
          <ul class="navbar-nav d-flex align-items-center gap-2 ms-auto mb-2 mb-lg-0 w-100 justify-content-end">
            <li class="nav-item">
              <a class="nav-link icon-circle" href="../user/saved.html" title="Saved" aria-label="Saved">
                <i class="bi bi-bookmark"></i>
              </a>
            </li>
            <li class="nav-item position-relative">
              <a class="nav-link icon-circle position-relative" href="../user/messaging.html" title="Messages" aria-label="Messages" id="messagesNavLink">
                <i class="bi bi-chat-dots"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="unreadMessagesBadge">0</span>
              </a>
            </li>
            <li class="nav-item position-relative" id="nav-notification-bell">
              <a class="nav-link icon-circle position-relative" href="../user/notifications.html" title="Notifications" aria-label="Notifications">
                <i class="bi bi-bell"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="notification-badge">0</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link icon-circle" id="myListingsLink" href="../stores/index.html" title="My Listings" aria-label="My Listings">
                <i class="bi bi-card-list"></i>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link icon-circle" id="profileLink" href="#" title="Profile" aria-label="Profile">
                <i class="bi bi-person"></i>
              </a>
            </li>
            <li class="vr mx-3 d-none d-lg-block" style="height: 32px; opacity: 0.15;"></li>
            <li class="nav-item ms-lg-2">
              <a class="btn btn-warning fw-bold px-4 rounded-pill shadow-sm" href="../dashboard/listings/add.html" style="color: #fff;">SELL</a>
            </li>
            <li class="nav-item ms-lg-2" id="authButtonContainer">
              <a class="btn btn-outline-primary fw-bold px-4 rounded-pill shadow-sm" id="authButton" href="../auth/login.html">Login / Signup</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <style>
    .navbar-custom.modern-navbar {
      background: #03254c !important;
      border-bottom: 3px solid #ffd700;
      box-shadow: 0 2px 12px rgba(0,0,0,0.04) !important;
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
      z-index: 1030;
    }
    .navbar-custom .navbar-brand {
      font-weight: 800;
      font-size: 1.7rem;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 0.2em;
      margin-right: 0 !important;
      padding-right: 0 !important;
      padding-top: 0.1rem;
      padding-bottom: 0.1rem;
    }
    .navbar-custom .navbar-nav {
      display: flex;
      align-items: center;
      gap: 0.4rem !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
    }
    .icon-circle {
      background: #fff;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex !important;
      align-items: center;
      justify-content: center;
      font-size: 1.35rem;
      color: #03254c;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      margin: 0 2px;
      transition: background 0.2s, color 0.2s;
      position: relative;
    }
    .icon-circle:hover, .icon-circle:focus {
      background: #e3f0ff;
      color: var(--primary-color);
      text-decoration: none;
      box-shadow: 0 2px 8px rgba(13,110,253,0.08);
    }
    .navbar-custom .btn-warning {
      background: var(--accent-gold) !important;
      border: none;
      color: #fff !important;
      font-weight: 700;
      font-size: 1.1rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      border-radius: 50px;
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }
    .navbar-custom .btn-warning:hover {
      background: #ffd700cc !important;
      color: #03254c !important;
    }
    .navbar-custom .btn-outline-primary {
      border-radius: 50px;
      font-weight: 700;
      font-size: 1.1rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }
    .vr {
      border-left: 2px solid #fff;
      opacity: 0.15;
      height: 32px;
    }
    @media (max-width: 991.98px) {
      .navbar-custom .navbar-brand {
        font-size: 1.4rem;
      }
      .navbar-custom .navbar-nav {
        gap: 0.5rem !important;
      }
      .vr {
        display: none !important;
      }
      .navbar-custom .btn-warning,
      .navbar-custom .btn-outline-primary {
        padding-top: 0.4rem;
        padding-bottom: 0.4rem;
        font-size: 1rem;
      }
      .navbar-custom.modern-navbar {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
    }
    @media (max-width: 575.98px) {
      .navbar-custom .navbar-brand {
        font-size: 1.1rem;
        padding-left: 0.2rem;
      }
      .navbar-custom.modern-navbar {
        padding-left: 0.2rem;
        padding-right: 0.2rem;
      }
    }
    </style>
    <script src="../../js/main.js"></script>
    <script>
    // Enforce authentication on this page
    enforceAuth('../../auth/login.html');
    // Setup My Listings link logic
    document.addEventListener('DOMContentLoaded', function() {
        setupMyListingsLink('#myListingsLink', '../../auth/login.html', '../../stores/agent-stores/dashboard.html', '../../stores/agent-stores/create.html');
    });
    // Example: Replace with your actual agent ID logic
    document.addEventListener('DOMContentLoaded', function() {
        var agentId = window.currentAgentId || localStorage.getItem('agentId'); // Replace with your logic
        if (agentId) {
            var myListings = document.getElementById('myListingsLink');
            var profile = document.getElementById('profileLink');
            if (myListings) myListings.href = '../stores/details.html?agentId=' + encodeURIComponent(agentId);
            if (profile) profile.href = '../agents/profile.html?agentId=' + encodeURIComponent(agentId);
        }
        // Initialize unread messages counter
        initializeUnreadMessagesCounter();
    });
    // Unread messages counter functionality
    let totalUnreadCount = 0;
    let unreadMessagesListener = null;
    function initializeUnreadMessagesCounter() {
        // Check if user is logged in (you can modify this based on your auth system)
        const currentUser = getCurrentUser();
        if (!currentUser) return;
        // Start listening for unread messages
        startUnreadMessagesListener();
        // Add click handler for messages nav link
        const messagesNavLink = document.getElementById('messagesNavLink');
        if (messagesNavLink) {
            messagesNavLink.addEventListener('click', function(e) {
                clearUnreadBadge();
            });
        }
    }
    function getCurrentUser() {
        // Replace this with your actual user authentication logic
        // For now, we'll check if there's a user in localStorage
        const userData = localStorage.getItem('user');
        if (userData) {
            try {
                return JSON.parse(userData);
            } catch (e) {
                return null;
            }
        }
        return null;
    }
    function startUnreadMessagesListener() {
        // This would connect to Firebase to listen for unread messages
        // For now, we'll simulate the functionality
        console.log('Unread messages listener initialized');
        // Simulate checking for unread messages every 30 seconds
        setInterval(() => {
            checkForUnreadMessages();
        }, 30000);
    }
    function checkForUnreadMessages() {
        // This would query Firebase for unread messages
        // For now, we'll simulate with a random number
        const mockUnreadCount = Math.floor(Math.random() * 5); // 0-4 messages
        updateUnreadBadge(mockUnreadCount);
    }
    function updateUnreadBadge(count) {
        const badge = document.getElementById('unreadMessagesBadge');
        if (!badge) return;
        totalUnreadCount = count;
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count.toString();
            badge.classList.remove('d-none');
        } else {
            badge.classList.add('d-none');
        }
    }
    function clearUnreadBadge() {
        updateUnreadBadge(0);
    }
    // Enhanced My Listings logic (updated for agent-stores dashboard)
    document.addEventListener('DOMContentLoaded', function() {
      var myListingsLink = document.getElementById('myListingsLink');
      if (!myListingsLink) return;
      myListingsLink.addEventListener('click', function(e) {
        if (!(window.firebase && firebase.auth && firebase.firestore)) return;
        var user = firebase.auth().currentUser;
        if (!user || user.isAnonymous) {
          // Not logged in, go to login
          window.location.href = '/pages/auth/login.html';
          return;
        }
        e.preventDefault();
        // Check if user has a store or is an agent
        var db = firebase.firestore();
        db.collection('stores').where('ownerId', '==', user.uid).limit(1).get()
          .then(function(querySnapshot) {
            if (!querySnapshot.empty) {
              // User has a store, go to the agent-stores dashboard
              window.location.href = '../stores/agent-stores/dashboard.html';
            } else {
              // Check if user is an agent (in users collection, role: 'agent')
              db.collection('users').doc(user.uid).get().then(function(userDoc) {
                var userData = userDoc.exists ? userDoc.data() : {};
                if (userData.role === 'agent') {
                  // Agent but no store, go to the agent-stores dashboard
                  window.location.href = '../stores/agent-stores/dashboard.html';
                } else {
                  // Not an agent, prompt to become agent and create store
                  if (confirm('To list your properties, you need to create a store and select an agent tier. Would you like to get started?')) {
                    window.location.href = '../stores/agent-stores/dashboard.html';
                  }
                }
              });
            }
          })
          .catch(function(err) {
            alert('Error checking your store status: ' + err.message);
          });
      });
    });
    // Auth button logic
    document.addEventListener('DOMContentLoaded', function() {
      var authButton = document.getElementById('authButton');
      if (!window.firebase || !firebase.auth) return;
      firebase.auth().onAuthStateChanged(function(user) {
        if (user && !user.isAnonymous) {
          authButton.textContent = 'Logout';
          authButton.classList.remove('btn-outline-primary');
          authButton.classList.add('btn-danger');
          authButton.href = '#';
          authButton.onclick = function(e) {
            e.preventDefault();
            firebase.auth().signOut().then(function() {
              window.location.reload();
            });
          };
        } else {
          authButton.textContent = 'Login / Signup';
          authButton.classList.remove('btn-danger');
          authButton.classList.add('btn-outline-primary');
          authButton.href = '/pages/auth/login.html';
          authButton.onclick = null;
        }
      });
    });
    </script>

    <!-- Product Section -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <!-- Product Gallery -->
                <div class="col-lg-7 col-md-12 col-12 mb-4">
                    <div class="product-gallery">
                        <div class="main-image">
                            <img src="https://via.placeholder.com/800x600?text=Loading..." alt="Listing Main Image" id="mainImage">
                        </div>
                        <div class="thumbnail-container" id="thumbnailContainer"></div>
                    </div>

                    <!-- Product Tabs -->
                    <div class="product-tabs">
                        <ul class="nav nav-tabs" id="productTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">Details</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="features-tab" data-bs-toggle="tab" data-bs-target="#features" type="button" role="tab">Features</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location" type="button" role="tab">Location</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab">Contact</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="productTabsContent">
                            <div class="tab-pane fade show active" id="details" role="tabpanel">
                                <div id="detailsTab">Loading details...</div>
                            </div>
                            <div class="tab-pane fade" id="features" role="tabpanel">
                                <ul class="features-list" id="featuresTab"></ul>
                            </div>
                            <div class="tab-pane fade" id="location" role="tabpanel">
                                <div id="locationTab"></div>
                            </div>
                            <div class="tab-pane fade" id="contact" role="tabpanel">
                                <div id="contactTab"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Details -->
                <div class="col-lg-5 col-md-12 col-12">
                    <div class="product-header">
                        <h1 class="product-title" id="productTitle">Loading...</h1>
                        <div class="product-location" id="productLocation">
                            <i class="bi bi-geo-alt-fill"></i> 
                        </div>
                        <div class="product-price" id="productPrice"></div>
                        <div class="product-meta" id="productMeta"></div>
                        
                        <div class="product-actions">
                            <button class="btn btn-primary btn-lg me-2 mb-2">
                                <i class="bi bi-telephone"></i> Contact Agent
                            </button>
                            <button class="btn btn-outline-primary btn-lg mb-2">
                                <i class="bi bi-heart"></i> Save
                            </button>
                        </div>
                        
                        <button class="btn btn-gold btn-lg w-100 mb-4" id="makeOfferBtn">
                            <i class="bi bi-credit-card"></i> Make Offer
                        </button>
                    </div>
                    
                    <!-- Agent Card -->
                    <div class="agent-card">
                        <div class="agent-header">
                            <div class="agent-avatar">
                                <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="Sarah Johnson">
                            </div>
                            <div class="agent-info">
                                <h5><a href="agent.html?id=agent123" class="text-decoration-none">Sarah Johnson</a></h5>
                                <p>Premium Property Agent</p>
                            </div>
                        </div>
                        
                        <div class="agent-stats row">
                            <div class="col-4 stat-item">
                                <h6>142</h6>
                                <p>Properties</p>
                            </div>
                            <div class="col-4 stat-item">
                                <h6>98%</h6>
                                <p>Success Rate</p>
                            </div>
                            <div class="col-4 stat-item">
                                <h6>5</h6>
                                <p>Years</p>
                            </div>
                        </div>
                        
                        <form>
                            <div class="mb-3 d-grid">
                                <button type="button" class="btn btn-primary btn-lg w-100" id="chatWithSellerBtn">
                                    <i class="bi bi-chat-dots"></i> Message or Chat with Seller
                                </button>
                            </div>
                            <a href="agent.html?id=agent123" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-person"></i> View Agent Profile
                            </a>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Similar Listings -->
            <div class="similar-listings mt-5">
                <h3 class="section-title">Similar Properties</h3>
                <div class="row" id="similarListingsContainer">
                    <!-- Similar listings will be loaded here dynamically -->
                </div>
                <div class="text-center mt-4" id="loadMoreContainer" style="display: none;">
                    <button class="btn btn-outline-primary btn-lg" id="loadMoreBtn">
                        <i class="bi bi-arrow-down-circle"></i> Load More Similar Properties
                    </button>
                </div>
                <div class="text-center mt-4" id="noSimilarContainer" style="display: none;">
                    <p class="text-muted">No similar properties found.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg text-white pt-5 pb-3">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-12 col-12 mb-4">
                    <h5>About StarLet</h5>
                    <p style="opacity: 0.8;">
                        Uganda's premier marketplace for premium properties and vehicles, connecting buyers and sellers with trust and excellence.
                    </p>
                    <div class="d-flex gap-3 mt-4">
                        <a href="#" class="text-white" style="font-size: 1.5rem;"><i class="bi bi-facebook"></i></a>
                        <a href="#" class="text-white" style="font-size: 1.5rem;"><i class="bi bi-twitter"></i></a>
                        <a href="#" class="text-white" style="font-size: 1.5rem;"><i class="bi bi-instagram"></i></a>
                        <a href="#" class="text-white" style="font-size: 1.5rem;"><i class="bi bi-linkedin"></i></a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 col-12 mb-4">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="#"><i class="bi bi-chevron-right"></i> Home</a></li>
                        <li><a href="#"><i class="bi bi-chevron-right"></i> Properties</a></li>
                        <li><a href="#"><i class="bi bi-chevron-right"></i> Vehicles</a></li>
                        <li><a href="#"><i class="bi bi-chevron-right"></i> Agents</a></li>
                        <li><a href="#"><i class="bi bi-chevron-right"></i> Dealers</a></li>
                    </ul>
                </div>
                <div class="col-lg-2 col-md-6 col-12 mb-4">
                    <h5>Company</h5>
                    <ul class="list-unstyled">
                        <li><a href="#"><i class="bi bi-chevron-right"></i> About Us</a></li>
                        <li><a href="#"><i class="bi bi-chevron-right"></i> Careers</a></li>
                        <li><a href="#"><i class="bi bi-chevron-right"></i> Blog</a></li>
                        <li><a href="#"><i class="bi bi-chevron-right"></i> Press</a></li>
                        <li><a href="#"><i class="bi bi-chevron-right"></i> Partners</a></li>
                    </ul>
                </div>
                <div class="col-lg-4 col-md-12 col-12 mb-4">
                    <h5>Contact Us</h5>
                    <ul class="list-unstyled">
                        <li><a href="#"><i class="bi bi-geo-alt"></i> laroo Division, gulu</a></li>
                        <li><a href="tel:+254700123456"><i class="bi bi-telephone"></i> +254 700 123456</a></li>
                        <li><a href="mailto:info@starlet.co.ke"><i class="bi bi-envelope"></i> info@starlet.co.ug</a></li>
                    </ul>
                    <div class="mt-4">
                        <h6>Newsletter</h6>
                        <div class="input-group mb-3">
                            <input type="email" class="form-control" placeholder="Your email" style="background: rgba(255,255,255,0.1); border: none; color: white;">
                            <button class="btn btn-primary" type="button">Subscribe</button>
                        </div>
                    </div>
                </div>
            </div>
            <hr class="my-4" style="border-color: rgba(255,255,255,0.1);">
            <div class="row">
                <div class="col-md-6 text-center text-md-start">
                    <p class="mb-0">&copy; 2023 StarLet Marketplace. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <a href="#" class="text-white me-3" style="opacity: 0.7;">Terms</a>
                    <a href="#" class="text-white me-3" style="opacity: 0.7;">Privacy</a>
                    <a href="#" class="text-white" style="opacity: 0.7;">Cookies</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Offer Modal -->
    <div class="modal fade" id="offerModal" tabindex="-1" aria-labelledby="offerModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="offerModalLabel">Make an Offer</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label for="offerAmount" class="form-label">Enter your offer amount (UGX):</label>
            <input type="number" class="form-control" id="offerAmount" min="1" placeholder="e.g. 50000000">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="submitOfferBtn">Send Offer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase & Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="../../assets/js/firebase-config.js"></script>
    
    <!-- Custom JS -->
    <script>
        // Change main image when thumbnail is clicked
        function changeImage(src) {
            document.getElementById('mainImage').src = src;
            
            // Update active thumbnail
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach(thumb => {
                thumb.classList.remove('active');
                if (thumb.onclick.toString().includes(src)) {
                    thumb.classList.add('active');
                }
            });
        }
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // --- Robust Firebase Initialization Waiter ---
        function waitForFirebaseInit(callback, retries = 20) {
            if (window.firebaseDB && window.firebaseAuth) {
                callback();
            } else if (retries > 0) {
                setTimeout(() => waitForFirebaseInit(callback, retries - 1), 200);
            } else {
                document.getElementById('productTitle').textContent = 'Error loading listing';
                document.getElementById('detailsTab').textContent = 'Firebase not initialized. Please refresh the page.';
                console.error('Firebase DB not initialized after waiting.');
            }
        }

        // --- Dynamic Listing Loader ---
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        async function loadListing() {
            const id = getQueryParam('id');
            if (!id) {
                document.getElementById('productTitle').textContent = 'Listing Not Found';
                document.getElementById('detailsTab').textContent = 'No listing ID provided.';
                return;
            }

            // First, try to get the full listing data from localStorage
            let data = null;
            const storedListing = localStorage.getItem('currentListing');
            
            if (storedListing) {
                try {
                    const parsedListing = JSON.parse(storedListing);
                    // Verify it's the same listing by ID
                    if (parsedListing.id === id) {
                        data = parsedListing;
                        console.log('Loaded listing from localStorage:', data);
                    }
                } catch (e) {
                    console.warn('Failed to parse localStorage data:', e);
                }
            }

            // If no data in localStorage, fetch from Firestore
            if (!data) {
                // Check if Firebase is properly initialized
                if (!window.firebaseDB) {
                    console.error('Firebase DB not initialized. Waiting for initialization...');
                    // Wait a bit for Firebase to initialize
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    if (!window.firebaseDB) {
                        document.getElementById('productTitle').textContent = 'Error loading listing';
                        document.getElementById('detailsTab').textContent = 'Firebase not initialized. Please refresh the page.';
                        return;
                    }
                }
                
                try {
                    const doc = await window.firebaseDB.collection('listings').doc(id).get();
                    if (!doc.exists) {
                        document.getElementById('productTitle').textContent = 'Listing Not Found';
                        document.getElementById('detailsTab').textContent = 'This listing does not exist.';
                        return;
                    }
                    data = doc.data();
                    console.log('Loaded listing from Firestore:', data);
                } catch (err) {
                    document.getElementById('productTitle').textContent = 'Error loading listing';
                    document.getElementById('detailsTab').textContent = 'Could not load listing details.';
                    console.error('Error loading listing from Firestore:', err);
                    return;
                }
            }

            // Set currentListingData for similar listings functionality
            currentListingData = data;
            console.log('✅ Set currentListingData for similar listings:', currentListingData);

            // Fetch creator's information (user/agent details)
            let creatorInfo = null;
            if (data.createdBy || data.ownerId) {
                const creatorId = data.createdBy || data.ownerId;
                console.log('Fetching creator info for ID:', creatorId);
                
                try {
                    // Try to fetch from users collection first
                    console.log('Trying users collection...');
                    const userDoc = await window.firebaseDB.collection('users').doc(creatorId).get();
                    if (userDoc.exists) {
                        creatorInfo = userDoc.data();
                        console.log('✅ Loaded creator info from users collection:', creatorInfo);
                    } else {
                        console.log('❌ User not found in users collection, trying agents...');
                        // Try agents collection if not found in users
                        const agentDoc = await window.firebaseDB.collection('agents').doc(creatorId).get();
                        if (agentDoc.exists) {
                            creatorInfo = agentDoc.data();
                            console.log('✅ Loaded creator info from agents collection:', creatorInfo);
                        } else {
                            console.log('❌ Creator not found in either users or agents collection');
                        }
                    }
                } catch (err) {
                    console.error('❌ Error fetching creator info:', err);
                }
            } else {
                console.log('❌ No creator ID found in listing data');
            }

            // Now populate the page with all the listing data
            try {
                // Title
                document.getElementById('productTitle').textContent = data.title || 'No Title';
                
                // Update page title
                document.title = `${data.title || 'Listing'} | StarLet Marketplace`;
                
                // Location
                let loc = '';
                if (data.location) {
                    loc = [data.location.neighborhood, data.location.village, data.location.district].filter(Boolean).join(', ');
                }
                document.getElementById('productLocation').innerHTML = '<i class="bi bi-geo-alt-fill"></i> ' + (loc || 'Location not specified');
                
                // Price
                document.getElementById('productPrice').textContent = data.askingPrice ? 'UGX ' + data.askingPrice.toLocaleString() : 'Price not specified';
                
                // Meta - Enhanced to show more details
                let metaHtml = '';
                
                // Property-specific details
                if (data.bedrooms || (data.houseDetails && data.houseDetails.bedrooms)) {
                    metaHtml += `<div class="meta-item"><div class="meta-icon"><i class="bi bi-house-door"></i></div><div>${data.bedrooms || (data.houseDetails && data.houseDetails.bedrooms)} Bedrooms</div></div>`;
                }
                if (data.bathrooms || (data.houseDetails && data.houseDetails.bathrooms)) {
                    metaHtml += `<div class="meta-item"><div class="meta-icon"><i class="bi bi-droplet"></i></div><div>${data.bathrooms || (data.houseDetails && data.houseDetails.bathrooms)} Bathrooms</div></div>`;
                }
                if (data.surfaceArea || (data.houseDetails && data.houseDetails.totalArea)) {
                    metaHtml += `<div class="meta-item"><div class="meta-icon"><i class="bi bi-rulers"></i></div><div>${data.surfaceArea || (data.houseDetails && data.houseDetails.totalArea)} m²</div></div>`;
                }
                
                // Vehicle-specific details
                if (data.carDetails) {
                    if (data.carDetails.year) {
                        metaHtml += `<div class="meta-item"><div class="meta-icon"><i class="bi bi-calendar-event"></i></div><div>${data.carDetails.year}</div></div>`;
                    }
                    if (data.carDetails.transmission) {
                        metaHtml += `<div class="meta-item"><div class="meta-icon"><i class="bi bi-gear"></i></div><div>${data.carDetails.transmission}</div></div>`;
                    }
                    if (data.carDetails.make) {
                        metaHtml += `<div class="meta-item"><div class="meta-icon"><i class="bi bi-car-front"></i></div><div>${data.carDetails.make}</div></div>`;
                    }
                    if (data.carDetails.model) {
                        metaHtml += `<div class="meta-item"><div class="meta-icon"><i class="bi bi-car-front"></i></div><div>${data.carDetails.model}</div></div>`;
                    }
                }
                
                // Motorcycle-specific details
                if (data.motorcycleDetails) {
                    if (data.motorcycleDetails.year) {
                        metaHtml += `<div class="meta-item"><div class="meta-icon"><i class="bi bi-calendar-event"></i></div><div>${data.motorcycleDetails.year}</div></div>`;
                    }
                    if (data.motorcycleDetails.make) {
                        metaHtml += `<div class="meta-item"><div class="meta-icon"><i class="bi bi-bicycle"></i></div><div>${data.motorcycleDetails.make}</div></div>`;
                    }
                }
                
                // Land-specific details
                if (data.landDetails && data.landDetails.plotSize) {
                    if (data.landDetails.plotSize.acres) {
                        metaHtml += `<div class="meta-item"><div class="meta-icon"><i class="bi bi-rulers"></i></div><div>${data.landDetails.plotSize.acres} Acres</div></div>`;
                    }
                    if (data.landDetails.plotSize.hectares) {
                        metaHtml += `<div class="meta-item"><div class="meta-icon"><i class="bi bi-rulers"></i></div><div>${data.landDetails.plotSize.hectares} Hectares</div></div>`;
                    }
                }
                
                // Views count
                if (data.views || data.viewCount) {
                    metaHtml += `<div class="meta-item"><div class="meta-icon"><i class="bi bi-eye"></i></div><div>${data.views || data.viewCount} Views</div></div>`;
                }
                
                document.getElementById('productMeta').innerHTML = metaHtml;
                
                // Gallery
                const mainImg = document.getElementById('mainImage');
                const thumbContainer = document.getElementById('thumbnailContainer');
                thumbContainer.innerHTML = '';
                let mainUrl = '';
                if (data.media && data.media.length > 0) {
                    mainUrl = data.media[0].url;
                    mainImg.src = mainUrl;
                    data.media.forEach((m, i) => {
                        const thumb = document.createElement('div');
                        thumb.className = 'thumbnail' + (i === 0 ? ' active' : '');
                        thumb.onclick = () => {
                            mainImg.src = m.url;
                            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                            thumb.classList.add('active');
                        };
                        thumb.innerHTML = `<img src="${m.url}" alt="Listing Image ${i+1}">`;
                        thumbContainer.appendChild(thumb);
                    });
                } else {
                    mainImg.src = 'https://via.placeholder.com/800x600?text=No+Image';
                }
                
                // Details Tab - Enhanced with more information
                let detailsHtml = '';
                if (data.description) {
                    detailsHtml += `<p class="mb-3">${data.description}</p>`;
                }
                
                // Add additional details based on listing type
                if (data.listingType && data.listingType.includes('house')) {
                    if (data.houseDetails) {
                        detailsHtml += `<h6>House Details:</h6><ul>`;
                        if (data.houseDetails.bedrooms) detailsHtml += `<li>Bedrooms: ${data.houseDetails.bedrooms}</li>`;
                        if (data.houseDetails.bathrooms) detailsHtml += `<li>Bathrooms: ${data.houseDetails.bathrooms}</li>`;
                        if (data.houseDetails.totalArea) detailsHtml += `<li>Total Area: ${data.houseDetails.totalArea} m²</li>`;
                        if (data.houseDetails.parking) detailsHtml += `<li>Parking: ${data.houseDetails.parking}</li>`;
                        detailsHtml += `</ul>`;
                    }
                } else if (data.listingType && data.listingType.includes('vehicle')) {
                    if (data.carDetails) {
                        detailsHtml += `<h6>Vehicle Details:</h6><ul>`;
                        if (data.carDetails.make) detailsHtml += `<li>Make: ${data.carDetails.make}</li>`;
                        if (data.carDetails.model) detailsHtml += `<li>Model: ${data.carDetails.model}</li>`;
                        if (data.carDetails.year) detailsHtml += `<li>Year: ${data.carDetails.year}</li>`;
                        if (data.carDetails.transmission) detailsHtml += `<li>Transmission: ${data.carDetails.transmission}</li>`;
                        if (data.carDetails.fuelType) detailsHtml += `<li>Fuel Type: ${data.carDetails.fuelType}</li>`;
                        if (data.carDetails.mileage) detailsHtml += `<li>Mileage: ${data.carDetails.mileage} km</li>`;
                        detailsHtml += `</ul>`;
                    }
                }
                
                document.getElementById('detailsTab').innerHTML = detailsHtml || 'No description provided.';
                
                // Features Tab - Enhanced
                const featuresTab = document.getElementById('featuresTab');
                featuresTab.innerHTML = '';
                if (data.features && Array.isArray(data.features)) {
                    data.features.forEach(f => {
                        featuresTab.innerHTML += `<li><i class='bi bi-check-circle-fill text-success me-2'></i> ${f}</li>`;
                    });
                } else {
                    featuresTab.innerHTML = '<li>No features listed.</li>';
                }
                
                // Location Tab - Enhanced
                const locationTab = document.getElementById('locationTab');
                let locationHtml = '';
                if (data.location) {
                    if (data.location.gpsCoordinates && data.location.gpsCoordinates.latitude && data.location.gpsCoordinates.longitude) {
                        const { latitude, longitude } = data.location.gpsCoordinates;
                        locationHtml += `<div class='ratio ratio-16x9 mb-3'><iframe src='https://maps.google.com/maps?q=${latitude},${longitude}&z=15&output=embed' style='border:0;' allowfullscreen='' loading='lazy'></iframe></div>`;
                    }
                    locationHtml += `<h6>Location Details:</h6><ul>`;
                    if (data.location.district) locationHtml += `<li>District: ${data.location.district}</li>`;
                    if (data.location.neighborhood) locationHtml += `<li>Neighborhood: ${data.location.neighborhood}</li>`;
                    if (data.location.village) locationHtml += `<li>Village: ${data.location.village}</li>`;
                    if (data.location.street) locationHtml += `<li>Street: ${data.location.street}</li>`;
                    locationHtml += `</ul>`;
                }
                locationTab.innerHTML = locationHtml || 'Location not specified.';
                
                // Contact Tab - Add owner/agent information if available
                const contactTab = document.getElementById('contactTab');
                let contactHtml = '';
                
                if (creatorInfo) {
                    // Display creator's information
                    contactHtml += `<div class="creator-profile mb-4">`;
                    
                    // Profile picture
                    if (creatorInfo.profilePicture || creatorInfo.photoURL || creatorInfo.avatar) {
                        contactHtml += `<div class="text-center mb-3">
                            <img src="${creatorInfo.profilePicture || creatorInfo.photoURL || creatorInfo.avatar}" alt="Profile" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
                        </div>`;
                    } else {
                        contactHtml += `<div class="text-center mb-3">
                            <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center" style="width: 100px; height: 100px;">
                                <i class="bi bi-person-fill text-white" style="font-size: 2rem;"></i>
                            </div>
                        </div>`;
                    }
                    
                    // Name and type
                    const creatorName = creatorInfo.fullName || creatorInfo.name || 
                                       (creatorInfo.firstName && creatorInfo.lastName ? creatorInfo.firstName + ' ' + creatorInfo.lastName : null) || 
                                       creatorInfo.email || 'Unknown';
                    const creatorType = creatorInfo.role || creatorInfo.userType || creatorInfo.type || 'User';
                    contactHtml += `<h5 class="text-center mb-3">${creatorName}</h5>`;
                    contactHtml += `<p class="text-center text-muted mb-4">${creatorType}</p>`;
                    
                    // Contact information
                    contactHtml += `<div class="contact-details">`;
                    
                    if (creatorInfo.email) {
                        contactHtml += `<div class="d-flex align-items-center mb-3">
                            <i class="bi bi-envelope-fill text-primary me-3"></i>
                            <div>
                                <strong>Email:</strong><br>
                                <a href="mailto:${creatorInfo.email}">${creatorInfo.email}</a>
                            </div>
                        </div>`;
                    }
                    
                    if (creatorInfo.phone || creatorInfo.phoneNumber || creatorInfo.mobile) {
                        const phone = creatorInfo.phone || creatorInfo.phoneNumber || creatorInfo.mobile;
                        contactHtml += `<div class="d-flex align-items-center mb-3">
                            <i class="bi bi-telephone-fill text-primary me-3"></i>
                            <div>
                                <strong>Phone:</strong><br>
                                <a href="tel:${phone}">${phone}</a>
                            </div>
                        </div>`;
                    }
                    
                    if (creatorInfo.whatsapp) {
                        contactHtml += `<div class="d-flex align-items-center mb-3">
                            <i class="bi bi-whatsapp text-success me-3"></i>
                            <div>
                                <strong>WhatsApp:</strong><br>
                                <a href="https://wa.me/${creatorInfo.whatsapp}">${creatorInfo.whatsapp}</a>
                            </div>
                        </div>`;
                    }
                    
                    if (creatorInfo.location) {
                        contactHtml += `<div class="d-flex align-items-center mb-3">
                            <i class="bi bi-geo-alt-fill text-primary me-3"></i>
                            <div>
                                <strong>Location:</strong><br>
                                ${creatorInfo.location}
                            </div>
                        </div>`;
                    }
                    
                    // Agent-specific information
                    if (creatorInfo.licenseNumber) {
                        contactHtml += `<div class="d-flex align-items-center mb-3">
                            <i class="bi bi-award-fill text-warning me-3"></i>
                            <div>
                                <strong>License Number:</strong><br>
                                ${creatorInfo.licenseNumber}
                            </div>
                        </div>`;
                    }
                    
                    if (creatorInfo.company) {
                        contactHtml += `<div class="d-flex align-items-center mb-3">
                            <i class="bi bi-building-fill text-primary me-3"></i>
                            <div>
                                <strong>Company:</strong><br>
                                ${creatorInfo.company}
                            </div>
                        </div>`;
                    }
                    
                    if (creatorInfo.bio || creatorInfo.description) {
                        contactHtml += `<div class="mt-4">
                            <h6>About ${creatorName.split(' ')[0]}:</h6>
                            <p class="text-muted">${creatorInfo.bio || creatorInfo.description || 'No bio available.'}</p>
                        </div>`;
                    }
                    
                    contactHtml += `</div>`;
                    contactHtml += `</div>`;
                    
                    // Contact buttons
                    contactHtml += `<div class="contact-actions text-center">`;
                    if (creatorInfo.phone || creatorInfo.phoneNumber || creatorInfo.mobile) {
                        const phone = creatorInfo.phone || creatorInfo.phoneNumber || creatorInfo.mobile;
                        contactHtml += `<a href="tel:${phone}" class="btn btn-primary me-2 mb-2">
                            <i class="bi bi-telephone"></i> Call Now
                        </a>`;
                    }
                    if (creatorInfo.whatsapp) {
                        contactHtml += `<a href="https://wa.me/${creatorInfo.whatsapp}" class="btn btn-success me-2 mb-2" target="_blank">
                            <i class="bi bi-whatsapp"></i> WhatsApp
                        </a>`;
                    }
                    if (creatorInfo.email) {
                        contactHtml += `<a href="mailto:${creatorInfo.email}" class="btn btn-outline-primary mb-2">
                            <i class="bi bi-envelope"></i> Email
                        </a>`;
                    }
                    contactHtml += `</div>`;
                    
                } else {
                    // Fallback if no creator info available
                    contactHtml += `<div class="text-center">`;
                    contactHtml += `<i class="bi bi-person-x text-muted" style="font-size: 3rem;"></i>`;
                    contactHtml += `<h5 class="mt-3">Contact Information</h5>`;
                    contactHtml += `<p class="text-muted">Contact information for this listing is not available.</p>`;
                    
                    if (data.ownerId || data.createdBy) {
                        contactHtml += `<p class="text-muted">Creator ID: ${data.ownerId || data.createdBy}</p>`;
                    }
                    
                    if (data.status) {
                        contactHtml += `<p><strong>Status:</strong> <span class="badge bg-${data.status === 'approved' ? 'success' : data.status === 'pending' ? 'warning' : 'secondary'}">${data.status}</span></p>`;
                    }
                    contactHtml += `</div>`;
                }
                
                contactTab.innerHTML = contactHtml;
                
                // Update Agent Card with creator information
                if (creatorInfo) {
                    console.log('🎯 Populating agent card with creator info:', creatorInfo);
                    const agentCard = document.querySelector('.agent-card');
                    if (agentCard) {
                        // Update agent avatar
                        const agentAvatar = agentCard.querySelector('.agent-avatar img');
                        if (agentAvatar) {
                            const profilePic = creatorInfo.profilePicture || creatorInfo.photoURL || creatorInfo.avatar || 'https://randomuser.me/api/portraits/men/1.jpg';
                            agentAvatar.src = profilePic;
                            agentAvatar.alt = creatorInfo.fullName || creatorInfo.name || creatorInfo.firstName + ' ' + creatorInfo.lastName || 'Agent';
                            console.log('📸 Updated agent avatar:', profilePic);
                        }
                        
                        // Update agent info
                        const agentInfo = agentCard.querySelector('.agent-info');
                        if (agentInfo) {
                            const creatorName = creatorInfo.fullName || creatorInfo.name || 
                                               (creatorInfo.firstName && creatorInfo.lastName ? creatorInfo.firstName + ' ' + creatorInfo.lastName : null) || 
                                               creatorInfo.email || 'Unknown';
                            const creatorType = creatorInfo.role || creatorInfo.userType || creatorInfo.type || 'User';
                            agentInfo.innerHTML = `
                                <h5>${creatorName}</h5>
                                <p>${creatorType}</p>
                            `;
                            console.log('👤 Updated agent info:', { name: creatorName, type: creatorType });
                        }
                        
                        // Update agent stats (if available)
                        const agentStats = agentCard.querySelector('.agent-stats');
                        if (agentStats) {
                            let statsHtml = '';
                            
                            // Properties count - check multiple possible field names
                            const propertiesCount = creatorInfo.propertiesCount || creatorInfo.listingsCount || creatorInfo.totalProperties || creatorInfo.totalListings;
                            if (propertiesCount) {
                                statsHtml += `<div class="stat-item">
                                    <h6>${propertiesCount}</h6>
                                    <p>Properties</p>
                                </div>`;
                                console.log('📊 Properties count:', propertiesCount);
                            } else {
                                statsHtml += `<div class="stat-item">
                                    <h6>--</h6>
                                    <p>Properties</p>
                                </div>`;
                            }
                            
                            // Success rate - check multiple possible field names
                            const successRate = creatorInfo.successRate || creatorInfo.rating || creatorInfo.satisfactionRate;
                            if (successRate) {
                                statsHtml += `<div class="stat-item">
                                    <h6>${successRate}%</h6>
                                    <p>Success Rate</p>
                                </div>`;
                                console.log('⭐ Success rate:', successRate);
                            } else {
                                statsHtml += `<div class="stat-item">
                                    <h6>--</h6>
                                    <p>Success Rate</p>
                                </div>`;
                            }
                            
                            // Experience years - check multiple possible field names
                            const experienceYears = creatorInfo.experienceYears || creatorInfo.yearsOfExperience || creatorInfo.experience;
                            if (experienceYears) {
                                statsHtml += `<div class="stat-item">
                                    <h6>${experienceYears}</h6>
                                    <p>Years</p>
                                </div>`;
                                console.log('⏰ Experience years:', experienceYears);
                            } else {
                                statsHtml += `<div class="stat-item">
                                    <h6>--</h6>
                                    <p>Years</p>
                                </div>`;
                            }
                            
                            agentStats.innerHTML = statsHtml;
                        }
                        
                        // Update contact button to use creator's phone
                        const contactBtn = document.querySelector('.product-actions .btn-primary');
                        if (contactBtn) {
                            const phone = creatorInfo.phone || creatorInfo.phoneNumber || creatorInfo.mobile;
                            if (phone) {
                                contactBtn.innerHTML = '<i class="bi bi-telephone"></i> Contact Agent';
                                contactBtn.onclick = () => window.open(`tel:${phone}`, '_self');
                                console.log('📞 Updated contact button with phone:', phone);
                            } else {
                                console.log('📞 No phone number found for creator');
                            }
                        }
                        
                        // Update inquiry form to include creator info
                        const inquiryForm = agentCard.querySelector('form');
                        if (inquiryForm) {
                            inquiryForm.onsubmit = (e) => {
                                e.preventDefault();
                                const message = document.getElementById('message').value;
                                if (message.trim()) {
                                    const creatorName = creatorInfo.fullName || creatorInfo.name || creatorInfo.email || 'the agent';
                                    alert(`Inquiry sent to ${creatorName}!`);
                                    document.getElementById('message').value = '';
                                    console.log('💬 Inquiry sent to:', creatorName);
                                }
                            };
                        }
                        
                        console.log('✅ Agent card successfully updated with database data');
                    } else {
                        console.error('❌ Agent card element not found in DOM');
                    }
                } else {
                    console.log('❌ No creator info available, hiding agent card');
                    // Hide agent card if no creator info available
                    const agentCard = document.querySelector('.agent-card');
                    if (agentCard) {
                        agentCard.style.display = 'none';
                    }
                }
            } catch (err) {
                document.getElementById('productTitle').textContent = 'Error loading listing';
                document.getElementById('detailsTab').textContent = 'Could not load listing details.';
                console.error('Error populating listing data:', err);
            }

            // Load similar listings after the main listing is loaded
            if (currentListingData) {
                console.log('🔄 Loading similar listings after main listing loaded');
                setTimeout(() => {
                    loadSimilarListings(true);
                }, 1000); // Small delay to ensure main listing is fully loaded
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            waitForFirebaseInit(loadListing);
        });

        // Similar Listings Functionality
        let similarListings = [];
        let currentSimilarPage = 0;
        const similarListingsPerPage = 6;
        let currentListingData = null;

        async function loadSimilarListings(initialLoad = true) {
            try {
                if (!currentListingData) {
                    console.log('❌ No current listing data available for similar listings');
                    return;
                }

                if (initialLoad) {
                    currentSimilarPage = 0;
                    similarListings = [];
                    document.getElementById('similarListingsContainer').innerHTML = `
                        <div class="col-12 text-center">
                            <div class="loading-container">
                                <div class="star-loading">
                                    <div class="star"></div>
                                    <div class="star"></div>
                                    <div class="star"></div>
                                </div>
                                <div class="loading-text">Loading similar properties...</div>
                            </div>
                        </div>
                    `;
                }

                // --- Professional Similar Listings Query Logic ---
                const db = window.firebaseDB;
                let query = db.collection('listings').where('status', '==', 'approved');
                const currentId = currentListingData.id;
                const type = currentListingData.listingType || currentListingData.type || null;
                const category = currentListingData.category || null;
                const district = currentListingData.location?.district || null;
                const neighborhood = currentListingData.location?.neighborhood || null;
                const subCategory = currentListingData.houseDetails?.subCategory || currentListingData.landDetails?.subCategory || null;

                // 1. Try: Same type + same district + same subCategory
                let filters = [];
                if (type) filters.push(['listingType', '==', type]);
                if (district) filters.push(['location.district', '==', district]);
                if (subCategory) filters.push(['houseDetails.subCategory', '==', subCategory]);
                let listings = await runSimilarQuery(query, filters, currentId, 12);

                // 2. If not enough, relax subCategory
                if (listings.length < 6 && type && district) {
                    filters = [['listingType', '==', type], ['location.district', '==', district]];
                    listings = await runSimilarQuery(query, filters, currentId, 12);
                }
                // 3. If still not enough, relax to just type
                if (listings.length < 6 && type) {
                    filters = [['listingType', '==', type]];
                    listings = await runSimilarQuery(query, filters, currentId, 12);
                }
                // 4. If still not enough, fallback to category
                if (listings.length < 6 && category) {
                    filters = [['category', '==', category]];
                    listings = await runSimilarQuery(query, filters, currentId, 12);
                }
                // 5. If still not enough, just get recent approved listings
                if (listings.length < 6) {
                    listings = await runSimilarQuery(query, [], currentId, 12);
                }

                similarListings = listings;
                renderSimilarListings();
                document.getElementById('loadMoreContainer').style.display = 'none';
                document.getElementById('noSimilarContainer').style.display = listings.length === 0 ? 'block' : 'none';
            } catch (error) {
                console.error('❌ Error loading similar listings:', error);
                document.getElementById('similarListingsContainer').innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-danger">Error loading similar properties. Please try again.</p>
                        <button class="btn btn-outline-primary" onclick="loadSimilarListings(true)">
                            <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        // Helper to run a query with dynamic filters and exclude current listing
        async function runSimilarQuery(baseQuery, filters, excludeId, limit) {
            let q = baseQuery;
            for (const [field, op, value] of filters) {
                q = q.where(field, op, value);
            }
            const snap = await q.orderBy('createdAt', 'desc').limit(limit + 2).get();
            const results = [];
            snap.forEach(doc => {
                const data = doc.data();
                data.id = doc.id;
                if (data.id !== excludeId) results.push(data);
            });
            // Shuffle for variety if more than needed
            if (results.length > limit) {
                for (let i = results.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [results[i], results[j]] = [results[j], results[i]];
                }
                return results.slice(0, limit);
            }
            return results;
        }

        function renderSimilarListings() {
            const container = document.getElementById('similarListingsContainer');
            
            if (similarListings.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">No similar properties found.</p>
                    </div>
                `;
                return;
            }

            const listingsHtml = similarListings.map(listing => {
                const imageUrl = listing.images && listing.images.length > 0 
                    ? listing.images[0] 
                    : 'https://via.placeholder.com/400x300?text=No+Image';
                
                const price = listing.price ? `UGX ${parseInt(listing.price).toLocaleString()}` : 'Price on request';
                const title = listing.title || listing.name || 'Property for Sale';
                const location = listing.location || listing.address || 'Location not specified';
                
                // Improved: Display main category and subcategory
                const category = listing.listingType
                  ? listing.listingType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                  : (listing.category ? listing.category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Property');
                const subCategory = (listing.houseDetails && listing.houseDetails.subCategory) ||
                                   (listing.landDetails && listing.landDetails.subCategory) ||
                                   (listing.vehicleDetails && listing.vehicleDetails.subCategory) || '';

                // Determine listing type for badge (keep for type-badge on image)
                let typeBadge = 'Property';
                if (listing.type) {
                    typeBadge = listing.type.charAt(0).toUpperCase() + listing.type.slice(1).replace('_', ' ');
                } else if (listing.category) {
                    typeBadge = listing.category.charAt(0).toUpperCase() + listing.category.slice(1);
                }

                // Build stats based on available data
                let statsHtml = '';
                if (listing.bedrooms) {
                    statsHtml += `<span><i class="bi bi-house-door-fill"></i> ${listing.bedrooms} bd</span>`;
                }
                if (listing.bathrooms) {
                    statsHtml += `<span><i class="bi bi-droplet-fill"></i> ${listing.bathrooms} ba</span>`;
                }
                if (listing.size || listing.area) {
                    const size = listing.size || listing.area;
                    statsHtml += `<span><i class="bi bi-rulers"></i> ${size}</span>`;
                }
                if (listing.landSize) {
                    statsHtml += `<span><i class="bi bi-geo-fill"></i> ${listing.landSize}</span>`;
                }

                // If no stats available, show a default
                if (!statsHtml) {
                    statsHtml = `<span><i class="bi bi-info-circle"></i> View details</span>`;
                }

                return `
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="listing-card" onclick="viewListingDetails('${listing.id}', '${encodeURIComponent(title)}', '${listing.type || ''}', '${encodeURIComponent(price)}')">
                            <div class="card-img-wrapper">
                                <img src="${imageUrl}" 
                                     class="card-img-top" 
                                     alt="${title}"
                                     onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                                <span class="type-badge">
                                    ${typeBadge}
                                </span>
                                <div class="price-tag">
                                    ${price}
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title mb-1">${title}</h5>
                                <span class="badge bg-info mb-2">${category}</span>
                                ${subCategory ? `<span class='badge bg-secondary mb-2 ms-2'>${subCategory}</span>` : ''}
                                <div class="location">
                                    <i class="bi bi-geo-alt-fill"></i> ${location}
                                </div>
                                <div class="stats">
                                    ${statsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = listingsHtml;
            console.log(`✅ Rendered ${similarListings.length} similar listings`);
        }

        function viewListingDetails(id, title, type, price) {
            // Store listing data in localStorage for the next page
            const listingData = similarListings.find(listing => listing.id === id);
            if (listingData) {
                localStorage.setItem('currentListingData', JSON.stringify(listingData));
            }
            
            // Navigate to the product page
            const url = `product.html?id=${id}&title=${title}&type=${type}&price=${price}`;
            window.location.href = url;
        }

        // Load more button functionality
        document.addEventListener('DOMContentLoaded', function() {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function() {
                    loadSimilarListings(false);
                });
            }
        });

        // Add chat button logic
        document.addEventListener('DOMContentLoaded', function() {
            const chatBtn = document.getElementById('chatWithSellerBtn');
            if (chatBtn) {
                chatBtn.addEventListener('click', function() {
                    // Get the current listing ID from URL
                    const url = new URL(window.location.href);
                    const listingId = url.searchParams.get('id');
                    const listerId = window.currentListingListerId;
                    if (listingId && listerId) {
                        // Redirect to messaging page with listingId and listerId as query params
                        window.location.href = '/pages/user/messaging.html?listingId=' + encodeURIComponent(listingId) + '&listerId=' + encodeURIComponent(listerId);
                    } else if (!listerId) {
                        alert('Lister (seller) ID not found for this property.');
                    } else {
                        alert('Listing ID not found.');
                    }
                });
            }
        });

        // Add Make Offer logic
        document.addEventListener('DOMContentLoaded', function() {
            const makeOfferBtn = document.getElementById('makeOfferBtn');
            if (makeOfferBtn) {
                makeOfferBtn.addEventListener('click', function() {
                    const offerModal = new bootstrap.Modal(document.getElementById('offerModal'));
                    document.getElementById('offerAmount').value = '';
                    offerModal.show();
                });
            }
            const submitOfferBtn = document.getElementById('submitOfferBtn');
            if (submitOfferBtn) {
                submitOfferBtn.addEventListener('click', async function() {
                    const offerAmount = document.getElementById('offerAmount').value;
                    if (!offerAmount || isNaN(offerAmount) || Number(offerAmount) <= 0) {
                        alert('Please enter a valid offer amount.');
                        return;
                    }
                    // Get listingId and listerId
                    const url = new URL(window.location.href);
                    const listingId = url.searchParams.get('id');
                    const listerId = window.currentListingListerId;
                    if (!listingId || !listerId) {
                        alert('Could not determine listing or seller.');
                        return;
                    }
                    // Store offer in localStorage for chat page to pick up
                    localStorage.setItem('pendingOffer', JSON.stringify({ listingId, listerId, offerAmount }));
                    // Redirect to chat with offer
                    window.location.href = '/pages/user/messaging.html?listingId=' + encodeURIComponent(listingId) + '&listerId=' + encodeURIComponent(listerId) + '&makeOffer=1';
                });
            }
        });
    </script>
    <!-- Floating Support Button -->
    <button id="floatingSupportBtn" class="floating-support-btn" title="Chat with Support">
      <i class="bi bi-headset"></i>
      <span class="tooltip">Chat with Support</span>
    </button>
    <script>
    document.getElementById('floatingSupportBtn').onclick = function() {
      window.location.href = '/pages/user/messaging.html?support=1';
    };
    </script>
</body>
</html>