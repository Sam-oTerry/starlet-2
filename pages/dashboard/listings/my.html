<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Listings - Starlet Properties</title>
  <link href="../../css/style.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { font-family: 'Inter', Arial, sans-serif; background: linear-gradient(135deg, var(--light-color) 0%, #e3f0ff 100%); min-height: 100vh; margin: 0; color: var(--dark-color); }
    .dashboard-wrapper { display: flex; min-height: 100vh; width: 100vw; background: none; }
    .sidebar { background: rgba(255,255,255,0.85); backdrop-filter: blur(8px); border-right: 1.5px solid #e3eaf5; min-width: 220px; max-width: 240px; padding: 2.5rem 1.2rem 1.2rem 1.2rem; display: flex; flex-direction: column; gap: 1.5rem; z-index: 2; }
    .sidebar .nav-link { color: var(--primary-color); font-weight: 500; font-size: 1.08rem; border-radius: 10px; padding: 0.7em 1.1em; margin-bottom: 0.2em; display: flex; align-items: center; gap: 0.7em; transition: background 0.2s, color 0.2s; }
    .sidebar .nav-link.active, .sidebar .nav-link:hover { background: linear-gradient(90deg, var(--primary-color), var(--accent-cyan)); color: #fff; }
    .sidebar .sidebar-brand { font-size: 1.5rem; font-weight: 700; margin-bottom: 2.5rem; text-align: left; }
    .sidebar .brand-star { color: var(--accent-gold); }
    .sidebar .brand-let { color: var(--accent-cyan); }
    .main-content { flex: 1 1 auto; padding: 2.5rem 2.5rem 1.5rem 2.5rem; background: none; min-width: 0; position: relative; z-index: 1; display: flex; flex-direction: column; gap: 2rem; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1.5rem; }
    .welcome { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem; }
    .profile-summary { display: flex; align-items: center; gap: 1rem; background: rgba(255,255,255,0.7); border-radius: 12px; padding: 0.7rem 1.2rem; box-shadow: 0 2px 8px #0d6efd11; }
    .profile-avatar { width: 48px; height: 48px; border-radius: 50%; overflow: hidden; background: #eee; display: flex; align-items: center; justify-content: center; }
    .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .profile-info { display: flex; flex-direction: column; gap: 0.1rem; }
    .profile-info .name { font-weight: 600; color: var(--primary-color); }
    .profile-info .role { font-size: 0.97em; color: var(--secondary-color); }
    .recent-table { background: rgba(255,255,255,0.85); border-radius: 16px; box-shadow: 0 4px 18px #0d6efd11; padding: 1.5rem 1.2rem; overflow-x: auto; }
    .recent-table h5 { font-weight: 700; color: var(--primary-color); margin-bottom: 1rem; }
    .recent-table table { width: 100%; border-collapse: collapse; font-size: 1rem; }
    .recent-table th, .recent-table td { padding: 0.7rem 0.5rem; text-align: left; border-bottom: 1px solid #e3eaf5; }
    .recent-table th { color: var(--primary-color); font-weight: 600; background: none; }
    .recent-table tr:last-child td { border-bottom: none; }
    @media (max-width: 900px) { .dashboard-wrapper { flex-direction: column; } .sidebar { flex-direction: row; min-width: 0; max-width: 100vw; width: 100vw; border-right: none; border-bottom: 1.5px solid #e3eaf5; padding: 1rem 0.5rem; gap: 0.5rem; justify-content: space-between; align-items: center; } .sidebar .sidebar-brand { margin-bottom: 0; } .main-content { padding: 1.2rem 0.5rem; } }
    @media (max-width: 600px) { .recent-table { padding: 1rem 0.5rem; } }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
      <a class="navbar-brand" href="../../index.html">
        <span class="brand-star">Star</span> <span class="brand-let">Let</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="../../index.html"><i class="bi bi-house-door"></i> Home</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="categoriesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-grid"></i> Categories
            </a>
            <ul class="dropdown-menu" aria-labelledby="categoriesDropdown">
              <li><a class="dropdown-item" href="../../properties/index.html"><i class="bi bi-building"></i> Properties</a></li>
              <li><a class="dropdown-item" href="../../vehicles/index.html"><i class="bi bi-car-front"></i> Vehicles</a></li>
              <li><a class="dropdown-item" href="../../stores/index.html"><i class="bi bi-shop"></i> Stores</a></li>
              <li><a class="dropdown-item" href="../../about/resources.html"><i class="bi bi-book"></i> Resources</a></li>
              <li><a class="dropdown-item" href="../../about/index.html"><i class="bi bi-info-circle"></i> About</a></li>
              <li><a class="dropdown-item" href="../../about/contact.html"><i class="bi bi-envelope"></i> Contact</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../../auth/login.html"><i class="bi bi-box-arrow-in-right"></i> Login</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../../auth/register.html"><i class="bi bi-person-plus"></i> Sign Up</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="dashboard-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-brand"><span class="brand-star">Star</span><span class="brand-let">Let</span></div>
      <nav class="nav flex-column">
        <a class="nav-link" href="../index.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a class="nav-link active" href="my.html"><i class="bi bi-list-ul"></i> My Listings</a>
        <a class="nav-link" href="add.html"><i class="bi bi-plus-circle"></i> Add Listing</a>
        <a class="nav-link" href="#"><i class="bi bi-chat-dots"></i> Messages</a>
        <a class="nav-link" href="#"><i class="bi bi-shop"></i> Store Profile</a>
        <a class="nav-link" href="#"><i class="bi bi-gear"></i> Settings</a>
        <a class="nav-link" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Logout</a>
      </nav>
    </aside>
    <!-- Main Content -->
    <main class="main-content">
      <div class="dashboard-header">
        <div>
          <div class="welcome">My Listings</div>
          <div class="text-muted">Manage your property and vehicle listings here.</div>
        </div>
        <div class="profile-summary" id="profileSummary">
          <!-- User and store info will be injected here -->
        </div>
      </div>
      <!-- Store Info -->
      <div id="storeInfo" class="mb-4"></div>
      <!-- Listings Table -->
      <div class="recent-table mt-4">
        <h5>Your Listings</h5>
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Type</th>
              <th>Status</th>
              <th>Date</th>
              <th>Views</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="listingsTableBody">
            <!-- Listings will be injected here -->
          </tbody>
        </table>
      </div>
    </main>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Add Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="../../../js/main.js"></script>
  <script>
  // Enforce authentication on this page
  enforceAuth('../../../auth/login.html');
  // Setup My Listings link logic
  document.addEventListener('DOMContentLoaded', function() {
      setupMyListingsLink('#myListingsLink', '../../../auth/login.html', '../../../stores/agent-stores/dashboard.html', '../../../stores/agent-stores/create.html');
  });
    const firebaseConfig = {
      apiKey: "AIzaSyDH1sMk2NwceMAEfvH07azxaoPXpOI1Sek",
      authDomain: "starlet-properties-41509.firebaseapp.com",
      projectId: "starlet-properties-41509",
      storageBucket: "starlet-properties-41509.appspot.com",
      messagingSenderId: "393372988481",
      appId: "1:393372988481:web:c92584d7408296457b02c0",
      measurementId: "G-F02K9SP07C"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    enforceAuth().then(async user => {
      // Load store info for this user
      const storeSnap = await db.collection('stores').where('userId', '==', user.uid).orderBy('createdAt', 'desc').limit(1).get();
      let storeHtml = '';
      if (!storeSnap.empty) {
        const store = storeSnap.docs[0].data();
        storeHtml = `<div class="alert alert-info"><strong>Store:</strong> ${store.name} <br><small>${store.description}</small></div>`;
      } else {
        storeHtml = `<div class="alert alert-warning">No store profile found. <a href='../create-store.html'>Create your store</a>.</div>`;
      }
      document.getElementById('storeInfo').innerHTML = storeHtml;
      // Profile summary
      document.getElementById('profileSummary').innerHTML = `
        <div class="profile-avatar">
          <img src="${user.photoURL || 'https://randomuser.me/api/portraits/men/32.jpg'}" alt="${user.displayName || 'User'}" />
        </div>
        <div class="profile-info">
          <span class="name">${user.displayName || user.email || 'User'}</span>
          <span class="role">Agent</span>
        </div>
      `;
      // Load listings for this user
      loadListings(user.uid);
    });

    async function loadListings(userId) {
      const listingsTable = document.getElementById('listingsTableBody');
      listingsTable.innerHTML = '<tr><td colspan="6"><div class="loading-container"><div class="star-loading"><div class="star"></div><div class="star"></div><div class="star"></div></div><div class="loading-text">Loading listings...</div></div></td></tr>';
      const snapshot = await db.collection('listings').where('userId', '==', userId).get();
      listingsTable.innerHTML = '';
      if (snapshot.empty) {
        listingsTable.innerHTML = '<tr><td colspan="6">No listings found.</td></tr>';
        return;
      }
      snapshot.forEach(doc => {
        const data = doc.data();
        listingsTable.innerHTML += `
          <tr>
            <td>${data.title || ''}</td>
            <td>${data.listingType || ''}</td>
            <td>${data.status ? `<span class="badge bg-success">${data.status}</span>` : ''}</td>
            <td>${data.date || ''}</td>
            <td>${data.views || 0}</td>
            <td>
              <a href="#" class="btn btn-sm btn-outline-primary">View</a>
              <a href="addlistings.html?id=${doc.id}" class="btn btn-sm btn-outline-secondary">Edit</a>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteListing('${doc.id}')">Delete</button>
            </td>
          </tr>
        `;
      });
    }

    // Delete listing
    async function deleteListing(id) {
      if (confirm('Are you sure you want to delete this listing?')) {
        await db.collection('listings').doc(id).delete();
        alert('Listing deleted.');
        firebase.auth().onAuthStateChanged(user => { if (user) loadListings(user.uid); });
      }
    }

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
      e.preventDefault();
      firebase.auth().signOut().then(() => {
        window.location.href = '../../auth/login.html';
      });
    });
  </script>
</body>
</html>