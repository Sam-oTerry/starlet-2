<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Listing - Starlet Properties</title>
  <link href="../../css/style.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { font-family: 'Inter', Arial, sans-serif; background: linear-gradient(135deg, var(--light-color) 0%, #e3f0ff 100%); min-height: 100vh; margin: 0; color: var(--dark-color); }
    .dashboard-wrapper { display: flex; min-height: 100vh; width: 100vw; background: none; }
    .sidebar { background: rgba(255,255,255,0.85); backdrop-filter: blur(8px); border-right: 1.5px solid #e3eaf5; min-width: 220px; max-width: 240px; padding: 2.5rem 1.2rem 1.2rem 1.2rem; display: flex; flex-direction: column; gap: 1.5rem; z-index: 2; }
    .sidebar .nav-link { color: var(--primary-color); font-weight: 500; font-size: 1.08rem; border-radius: 10px; padding: 0.7em 1.1em; margin-bottom: 0.2em; display: flex; align-items: center; gap: 0.7em; transition: background 0.2s, color 0.2s; }
    .sidebar .nav-link.active, .sidebar .nav-link:hover { background: linear-gradient(90deg, var(--primary-color), var(--accent-cyan)); color: #fff; }
    .sidebar .sidebar-brand { font-size: 1.5rem; font-weight: 700; margin-bottom: 2.5rem; text-align: left; }
    .sidebar .brand-star { color: var(--accent-gold); }
    .sidebar .brand-let { color: var(--accent-cyan); }
    .main-content { flex: 1 1 auto; padding: 2.5rem 2.5rem 1.5rem 2.5rem; background: none; min-width: 0; position: relative; z-index: 1; display: flex; flex-direction: column; gap: 2rem; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1.5rem; }
    .welcome { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem; }
    .profile-summary { display: flex; align-items: center; gap: 1rem; background: rgba(255,255,255,0.7); border-radius: 12px; padding: 0.7rem 1.2rem; box-shadow: 0 2px 8px #0d6efd11; }
    .profile-avatar { width: 48px; height: 48px; border-radius: 50%; overflow: hidden; background: #eee; display: flex; align-items: center; justify-content: center; }
    .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .profile-info { display: flex; flex-direction: column; gap: 0.1rem; }
    .profile-info .name { font-weight: 600; color: var(--primary-color); }
    .profile-info .role { font-size: 0.97em; color: var(--secondary-color); }
    .add-listing-form { background: rgba(255,255,255,0.85); border-radius: 16px; box-shadow: 0 4px 18px #0d6efd11; padding: 2.5rem 2rem; max-width: 900px; margin: 0 auto; }
    .add-listing-form h5 { font-weight: 700; color: var(--primary-color); margin-bottom: 1.5rem; }
    .form-label { font-weight: 500; color: var(--primary-color); }
    .form-section-title { font-size: 1.1rem; font-weight: 600; color: var(--primary-color); margin-top: 2rem; margin-bottom: 1rem; }
    .form-control, .form-select { border-radius: 10px; border: 2px solid var(--light-color); padding: 0.75rem 1rem; transition: all 0.3s ease; font-size: 0.95rem; }
    .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25); }
    .btn-primary { background: linear-gradient(135deg, var(--primary-color), #0056b3); border-color: var(--primary-color); }
    .btn-primary:hover { background: linear-gradient(135deg, #0056b3, var(--primary-color)); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(13, 110, 253, 0.3); }
    .form-row { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .form-row > .col { flex: 1 1 220px; min-width: 220px; }
    @media (max-width: 900px) { .dashboard-wrapper { flex-direction: column; } .sidebar { flex-direction: row; min-width: 0; max-width: 100vw; width: 100vw; border-right: none; border-bottom: 1.5px solid #e3eaf5; padding: 1rem 0.5rem; gap: 0.5rem; justify-content: space-between; align-items: center; } .sidebar .sidebar-brand { margin-bottom: 0; } .main-content { padding: 1.2rem 0.5rem; } .add-listing-form { padding: 1.2rem 0.5rem; } }
    @media (max-width: 600px) { .add-listing-form { padding: 1rem 0.2rem; } .form-row { flex-direction: column; gap: 0.7rem; } }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
      <a class="navbar-brand" href="../../index.html">
        <span class="brand-star">Star</span> <span class="brand-let">Let</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="../../index.html"><i class="bi bi-house-door"></i> Home</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="categoriesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-grid"></i> Categories
            </a>
            <ul class="dropdown-menu" aria-labelledby="categoriesDropdown">
              <li><a class="dropdown-item" href="../../properties.html"><i class="bi bi-building"></i> Properties</a></li>
              <li><a class="dropdown-item" href="../../vehicles.html"><i class="bi bi-car-front"></i> Vehicles</a></li>
              <li><a class="dropdown-item" href="../../stores.html"><i class="bi bi-shop"></i> Stores</a></li>
              <li><a class="dropdown-item" href="../../resources.html"><i class="bi bi-book"></i> Resources</a></li>
              <li><a class="dropdown-item" href="../../about.html"><i class="bi bi-info-circle"></i> About</a></li>
              <li><a class="dropdown-item" href="../../contact.html"><i class="bi bi-envelope"></i> Contact</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../../login.html"><i class="bi bi-box-arrow-in-right"></i> Login</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../../register.html"><i class="bi bi-person-plus"></i> Sign Up</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="dashboard-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-brand"><span class="brand-star">Star</span><span class="brand-let">Let</span></div>
      <nav class="nav flex-column">
        <a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a class="nav-link" href="mylistings.html"><i class="bi bi-list-ul"></i> My Listings</a>
        <a class="nav-link active" href="#"><i class="bi bi-plus-circle"></i> Add Listing</a>
        <a class="nav-link" href="#"><i class="bi bi-chat-dots"></i> Messages</a>
        <a class="nav-link" href="#"><i class="bi bi-shop"></i> Store Profile</a>
        <a class="nav-link" href="#"><i class="bi bi-gear"></i> Settings</a>
        <a class="nav-link" href="#"><i class="bi bi-box-arrow-right"></i> Logout</a>
      </nav>
    </aside>
    <!-- Main Content -->
    <main class="main-content">
      <div class="dashboard-header">
        <div>
          <div class="welcome">Add Listing</div>
          <div class="text-muted">Add a new property or vehicle listing below.</div>
        </div>
        <div class="profile-summary">
          <div class="profile-avatar">
            <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="John Doe" />
          </div>
          <div class="profile-info">
            <span class="name">John Doe</span>
            <span class="role">Agent</span>
          </div>
        </div>
      </div>
      <!-- Add Listing Form -->
      <div class="container my-5">
        <div class="row justify-content-center">
          <div class="col-lg-8 col-md-10">
            <div class="card shadow">
              <div class="card-body">
                <h2 class="mb-4">Add New Listing</h2>
                <form id="addListingForm">
                  <!-- Listing Type -->
                  <div class="mb-3">
                    <label class="form-label">Listing Type</label>
                    <select id="listingType" class="form-select">
                      <option value="">Select Type</option>
                      <option value="property">Property</option>
                      <option value="vehicle">Vehicle</option>
                    </select>
                  </div>
                  <!-- Property Section -->
                  <div id="propertySection" class="d-none">
                    <div class="row g-3">
                      <div class="col-lg-6 col-md-12 col-12">
                        <label class="form-label">Property Type</label>
                        <select id="propertyType" class="form-select">
                          <option value="">Select Property Type</option>
                          <option value="house_sale">House for Sale</option>
                          <option value="house_rent">House for Rent</option>
                          <option value="land_sale">Land for Sale</option>
                          <option value="land_rent">Land for Rent</option>
                          <option value="vacation_short_stay">Vacation & Short Stay</option>
                        </select>
                      </div>
                      <div class="col-lg-6 col-md-12 col-12">
                        <label class="form-label">Title</label>
                        <input id="propertyTitle" type="text" class="form-control" required>
                      </div>
                      <div class="col-lg-6 col-md-12 col-12">
                        <label class="form-label">Asking Price (UGX)</label>
                        <input id="propertyAskingPrice" type="number" class="form-control" required>
                      </div>
                      <div class="col-lg-6 col-md-12 col-12">
                        <label class="form-label">District</label>
                        <input id="propertyDistrict" type="text" class="form-control" required>
                      </div>
                    </div>
                    <!-- House Details -->
                    <div id="houseDetailsSection" class="row g-3 mt-3 d-none">
                      <div class="col-lg-6 col-md-12 col-12">
                        <label class="form-label">Sub Category</label>
                        <select id="houseSubCategory" class="form-select">
                          <option value="">Select</option>
                          <option>Houses</option><option>Apartments</option><option>Condominiums</option><option>Townhouses</option><option>Villas</option><option>Single Rooms</option><option>Hostels</option><option>Serviced Apartments</option><option>Family Homes</option><option>Airbnbs</option><option>Cottages</option><option>Beach Houses</option><option>Lodges</option>
                        </select>
                      </div>
                      <div class="col-lg-3 col-md-6 col-12">
                        <label class="form-label">Bedrooms</label>
                        <input id="houseBedrooms" type="number" class="form-control">
                      </div>
                      <div class="col-lg-3 col-md-6 col-12">
                        <label class="form-label">Bathrooms</label>
                        <input id="houseBathrooms" type="number" class="form-control">
                      </div>
                      <div class="col-lg-6 col-md-12 col-12">
                        <label class="form-label">Total Area (sqm)</label>
                        <input id="houseTotalArea" type="number" class="form-control" required>
                      </div>
                      <div class="col-lg-6 col-md-12 col-12">
                        <label class="form-label">Plot Size (width, length, acres, hectares)</label>
                        <div class="row g-2">
                          <div class="col-6 col-md-3"><input id="housePlotWidth" type="number" placeholder="Width" class="form-control"></div>
                          <div class="col-6 col-md-3"><input id="housePlotLength" type="number" placeholder="Length" class="form-control"></div>
                          <div class="col-6 col-md-3"><input id="housePlotAcres" type="number" placeholder="Acres" class="form-control"></div>
                          <div class="col-6 col-md-3"><input id="housePlotHectares" type="number" placeholder="Hectares" class="form-control"></div>
                        </div>
                      </div>
                      <div class="col-lg-6 col-md-12 col-12">
                        <label class="form-label">Furnishing Status</label>
                        <select id="houseFurnishingStatus" class="form-select">
                          <option value="">Select</option>
                          <option>Fully Furnished</option><option>Semi-Furnished</option><option>Unfurnished</option>
                        </select>
                      </div>
                      <div class="col-lg-6 col-md-12 col-12">
                        <label class="form-label">Condition</label>
                        <select id="houseCondition" class="form-select">
                          <option value="">Select</option>
                          <option>New</option><option>Renovated</option><option>Needs Repair</option>
                        </select>
                      </div>
                    </div>
                    <!-- Land Details -->
                    <div id="landDetailsSection" class="row g-3 mt-3 d-none">
                      <div class="col-md-6">
                        <label class="form-label">Sub Category</label>
                        <select id="landSubCategory" class="form-select">
                          <option value="">Select</option>
                          <option>Residential Land</option><option>Commercial Land</option><option>Agricultural Land</option><option>Industrial Land</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Plot Size (acres, hectares, width, length)</label>
                        <div class="row g-2">
                          <div class="col"><input id="landPlotAcres" type="number" placeholder="Acres" class="form-control"></div>
                          <div class="col"><input id="landPlotHectares" type="number" placeholder="Hectares" class="form-control"></div>
                          <div class="col"><input id="landPlotWidth" type="number" placeholder="Width" class="form-control"></div>
                          <div class="col"><input id="landPlotLength" type="number" placeholder="Length" class="form-control"></div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Topography</label>
                        <select id="landTopography" class="form-select">
                          <option value="">Select</option>
                          <option>Flat</option><option>Sloped</option><option>Hilly</option><option>Wetland</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Soil Type</label>
                        <select id="landSoilType" class="form-select">
                          <option value="">Select</option>
                          <option>Clay</option><option>Loam</option><option>Sandy</option><option>Unknown</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Current Use</label>
                        <select id="landCurrentUse" class="form-select">
                          <option value="">Select</option>
                          <option>Vacant</option><option>Farmland</option><option>Bush</option><option>Developed</option>
                        </select>
                      </div>
                    </div>
                    <!-- Ownership Details -->
                    <div id="ownershipDetailsSection" class="row g-3 mt-3 d-none">
                      <div class="col-md-4">
                        <label class="form-label">Ownership Type</label>
                        <select id="ownershipType" class="form-select">
                          <option value="">Select</option>
                          <option>Freehold</option><option>Leasehold</option><option>Customary</option><option>Private Mailo</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Title Status</label>
                        <select id="titleStatus" class="form-select">
                          <option value="">Select</option>
                          <option>Registered</option><option>Unregistered</option><option>Processing</option>
                        </select>
                      </div>
                      <div class="col-md-4" id="leaseYearsField">
                        <label class="form-label">Lease Years Remaining</label>
                        <input id="leaseYearsRemaining" type="number" class="form-control">
                      </div>
                    </div>
                    <!-- Amenities (Premium only) -->
                    <div id="amenitiesSection" class="row g-3 mt-3 d-none">
                      <div class="col-md-4">
                        <label class="form-label">Electricity</label>
                        <select id="amenityElectricity" class="form-select">
                          <option>UMEME</option><option>Solar</option><option>Grid</option><option>None</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Water Supply</label>
                        <select id="amenityWater" class="form-select">
                          <option>Piped</option><option>Borehole</option><option>Water Tank</option><option>Nearby Source</option><option>None</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Toilet Type</label>
                        <select id="amenityToilet" class="form-select">
                          <option>Flush</option><option>Pit Latrine</option><option>None</option>
                        </select>
                      </div>
                      <!-- Security as checkboxes -->
                      <div class="col-md-4">
                        <label class="form-label">Security</label><br>
                        <div id="amenitySecurityCheckboxes" class="form-check">
                          <input class="form-check-input" type="checkbox" value="Gate" id="securityGate">
                          <label class="form-check-label me-2" for="securityGate">Gate</label>
                          <input class="form-check-input" type="checkbox" value="Guard" id="securityGuard">
                          <label class="form-check-label me-2" for="securityGuard">Guard</label>
                          <input class="form-check-input" type="checkbox" value="CCTV" id="securityCCTV">
                          <label class="form-check-label me-2" for="securityCCTV">CCTV</label>
                          <input class="form-check-input" type="checkbox" value="Fence" id="securityFence">
                          <label class="form-check-label me-2" for="securityFence">Fence</label>
                          <input class="form-check-input" type="checkbox" value="None" id="securityNone">
                          <label class="form-check-label" for="securityNone">None</label>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Parking</label>
                        <select id="amenityParking" class="form-select">
                          <option>Garage</option><option>Carport</option><option>Open Space</option><option>None</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Internet Ready</label>
                        <select id="amenityInternet" class="form-select">
                          <option>Fibre</option><option>Airtel Wireless</option><option>MTN Wireless</option><option>None</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Backup Power</label>
                        <select id="amenityBackup" class="form-select">
                          <option>Generator</option><option>Solar</option><option>None</option>
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Kitchen</label>
                        <select id="amenityKitchen" class="form-select">
                          <option>Modern</option><option>Standard</option><option>Basic</option><option>None</option>
                        </select>
                      </div>
                      <div class="col-md-4 d-flex align-items-center">
                        <input id="amenityTiled" type="checkbox" class="form-check-input me-2">
                        <label class="form-label mb-0">Tiled</label>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Road Access</label>
                        <select id="amenityRoadAccess" class="form-select">
                          <option>Tarmac</option><option>Murram</option><option>Footpath</option><option>None</option>
                        </select>
                      </div>
                      <!-- Nearby Amenities as checkboxes -->
                      <div class="col-md-4">
                        <label class="form-label">Nearby Amenities</label><br>
                        <div id="amenityNearbyCheckboxes" class="form-check">
                          <input class="form-check-input" type="checkbox" value="Schools" id="nearbySchools">
                          <label class="form-check-label me-2" for="nearbySchools">Schools</label>
                          <input class="form-check-input" type="checkbox" value="Hospitals" id="nearbyHospitals">
                          <label class="form-check-label me-2" for="nearbyHospitals">Hospitals</label>
                          <input class="form-check-input" type="checkbox" value="Markets" id="nearbyMarkets">
                          <label class="form-check-label me-2" for="nearbyMarkets">Markets</label>
                          <input class="form-check-input" type="checkbox" value="Public Transport" id="nearbyTransport">
                          <label class="form-check-label me-2" for="nearbyTransport">Public Transport</label>
                          <input class="form-check-input" type="checkbox" value="None" id="nearbyNone">
                          <label class="form-check-label" for="nearbyNone">None</label>
                        </div>
                      </div>
                    </div>
                    <!-- Description and Price Type for Property -->
                    <div class="row g-3 mt-3" id="propertyDescPriceRow">
                      <div class="col-md-8">
                        <label class="form-label">Description</label>
                        <textarea id="propertyDescription" class="form-control" rows="2"></textarea>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Price Type</label>
                        <select id="propertyPriceType" class="form-select">
                          <option value="fixed">Fixed</option>
                          <option value="negotiable">Negotiable</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <!-- Vehicle Section -->
                  <div id="vehicleSection" class="d-none">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">Vehicle Category</label>
                        <select id="vehicleCategory" class="form-select">
                          <option value="">Select Category</option>
                          <!-- JS will inject options here -->
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Sub Category</label>
                        <select id="vehicleSubCategory" class="form-select"></select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Make</label>
                        <select id="vehicleMake" class="form-select"></select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Model</label>
                        <select id="vehicleModel" class="form-select"></select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Title</label>
                        <input id="vehicleTitle" type="text" class="form-control" required>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Asking Price (UGX)</label>
                        <input id="vehicleAskingPrice" type="number" class="form-control" required>
                      </div>
                    </div>
                    <div id="vehicleStandardFields" class="row g-3 mt-3 d-none">
                      <div class="col-md-6">
                        <label class="form-label">Condition</label>
                        <select id="vehicleCondition" class="form-select">
                          <option>New</option><option>Used</option><option>For Parts</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Mileage (km)</label>
                        <input id="vehicleMileage" type="number" class="form-control">
                      </div>
                    </div>
                    <div id="vehiclePremiumFields" class="row g-3 mt-3 d-none">
                      <div class="col-md-4">
                        <label class="form-label">Color</label>
                        <select id="vehicleColor" class="form-select"></select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Transmission</label>
                        <select id="vehicleTransmission" class="form-select"></select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Fuel Type</label>
                        <select id="vehicleFuelType" class="form-select"></select>
                      </div>
                    </div>
                    <!-- Description and Price Type for Vehicle -->
                    <div class="row g-3 mt-3" id="vehicleDescPriceRow">
                      <div class="col-md-8">
                        <label class="form-label">Description</label>
                        <textarea id="vehicleDescription" class="form-control" rows="2"></textarea>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Price Type</label>
                        <select id="vehiclePriceType" class="form-select">
                          <option value="fixed">Fixed</option>
                          <option value="negotiable">Negotiable</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="mt-4">
                    <button type="submit" class="btn btn-primary px-4">Submit Listing</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    enforceAuth().then(user => {
      document.addEventListener('DOMContentLoaded', async function() {
        // Define all DOM element variables used in setFieldVisibility and elsewhere
        const listingTypeEl = document.getElementById('listingType');
        const propertySection = document.getElementById('propertySection');
        const vehicleSection = document.getElementById('vehicleSection');
        const houseDetailsSection = document.getElementById('houseDetailsSection');
        const landDetailsSection = document.getElementById('landDetailsSection');
        const ownershipDetailsSection = document.getElementById('ownershipDetailsSection');
        const amenitiesSection = document.getElementById('amenitiesSection');
        const leaseYearsField = document.getElementById('leaseYearsField');
        const vehicleStandardFields = document.getElementById('vehicleStandardFields');
        const vehiclePremiumFields = document.getElementById('vehiclePremiumFields');
        const propertyTypeEl = document.getElementById('propertyType');

        // Helper functions to safely get values
        function getValue(id) {
          const el = document.getElementById(id);
          return el ? el.value : undefined;
        }
        function getChecked(id) {
          const el = document.getElementById(id);
          return el ? el.checked : undefined;
        }
        function getCheckedValues(containerId) {
          return Array.from(document.querySelectorAll(`#${containerId} input[type=checkbox]:checked`)).map(cb => cb.value);
        }

        const firebaseConfig = {
          apiKey: "AIzaSyDH1sMk2NwceMAEfvH07azxaoPXpOI1Sek",
          authDomain: "starlet-properties-41509.firebaseapp.com",
          projectId: "starlet-properties-41509",
          storageBucket: "starlet-properties-41509.appspot.com",
          messagingSenderId: "393372988481",
          appId: "1:393372988481:web:c92584d7408296457b02c0",
          measurementId: "G-F02K9SP07C"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Auth check and prefill contact from store
        let currentAgent = null;
        let currentStoreId = null;
        firebase.auth().onAuthStateChanged(async function(user) {
          if (!user) {
            window.location.href = '../login.html';
            return;
          }
          // Prefill contact from store and get agent info
          const storeSnap = await db.collection('stores').where('userId', '==', user.uid).orderBy('createdAt', 'desc').limit(1).get();
          if (!storeSnap.empty) {
            const store = storeSnap.docs[0].data();
            const contactInfoEl = document.getElementById('contactInfo');
            if (contactInfoEl) contactInfoEl.value = store.contact || '';
            currentStoreId = storeSnap.docs[0].id;
            currentAgent = {
              avatar: store.avatar || 'https://randomuser.me/api/portraits/men/32.jpg',
              name: store.name || 'Agent',
              verified: !!store.verified,
              agentId: user.uid,
              agentTier: store.tier || 'diamond'
            };
          } else {
            // fallback if no store
            currentAgent = {
              avatar: 'https://randomuser.me/api/portraits/men/32.jpg',
              name: user.displayName || 'Agent',
              verified: false,
              agentId: user.uid,
              agentTier: 'diamond'
            };
          }
        });

        // --- Section Toggle Logic for Listing Type ---
        function toggleListingSections() {
          const type = listingTypeEl.value;
          if (type === 'property') {
            propertySection.classList.remove('d-none');
            vehicleSection.classList.add('d-none');
          } else if (type === 'vehicle') {
            propertySection.classList.add('d-none');
            vehicleSection.classList.remove('d-none');
          } else {
            propertySection.classList.add('d-none');
            vehicleSection.classList.add('d-none');
          }
        }
        listingTypeEl.addEventListener('change', toggleListingSections);
        // Call once on load to set initial state
        toggleListingSections();

        document.getElementById('addListingForm').addEventListener('submit', function(e) {
          e.preventDefault();
          let listing = {};
          if (listingTypeEl.value === 'property') {
            listing.listingType = getValue('propertyType');
            listing.title = getValue('propertyTitle');
            listing.askingPrice = Number(getValue('propertyAskingPrice'));
            listing.location = { district: getValue('propertyDistrict') };
            listing.description = getValue('propertyDescription');
            listing.priceType = getValue('propertyPriceType');
            if (userAgentTier !== 'Basic') {
              if (["house_sale","house_rent","vacation_short_stay"].includes(getValue('propertyType'))) {
                listing.houseDetails = {
                  subCategory: getValue('houseSubCategory'),
                  bedrooms: Number(getValue('houseBedrooms')),
                  bathrooms: Number(getValue('houseBathrooms')),
                  totalArea: Number(getValue('houseTotalArea')),
                  plotSize: {
                    width: Number(getValue('housePlotWidth')),
                    length: Number(getValue('housePlotLength')),
                    acres: Number(getValue('housePlotAcres')),
                    hectares: Number(getValue('housePlotHectares'))
                  },
                  furnishingStatus: getValue('houseFurnishingStatus'),
                  condition: getValue('houseCondition')
                };
              }
              if (["land_sale","land_rent"].includes(getValue('propertyType'))) {
                listing.landDetails = {
                  subCategory: getValue('landSubCategory'),
                  plotSize: {
                    acres: Number(getValue('landPlotAcres')),
                    hectares: Number(getValue('landPlotHectares')),
                    dimensions: {
                      width: Number(getValue('landPlotWidth')),
                      length: Number(getValue('landPlotLength'))
                    }
                  },
                  topography: getValue('landTopography'),
                  soilType: getValue('landSoilType'),
                  currentUse: getValue('landCurrentUse')
                };
              }
              listing.ownershipDetails = {
                ownershipType: getValue('ownershipType'),
                titleStatus: getValue('titleStatus')
              };
              if (userAgentTier === 'Premium' && getValue('ownershipType') === 'Leasehold') {
                listing.ownershipDetails.leaseYearsRemaining = Number(getValue('leaseYearsRemaining'));
              }
            }
            if (userAgentTier === 'Premium') {
              listing.amenities = {
                essentialUtilities: {
                  electricity: getValue('amenityElectricity'),
                  waterSupply: getValue('amenityWater'),
                  toiletType: getValue('amenityToilet')
                },
                additionalFeatures: {
                  security: getCheckedValues('amenitySecurityCheckboxes'),
                  parking: getValue('amenityParking'),
                  internetReady: getValue('amenityInternet'),
                  backupPower: getValue('amenityBackup'),
                  kitchen: getValue('amenityKitchen'),
                  tiled: getChecked('amenityTiled')
                },
                roadAccess: getValue('amenityRoadAccess'),
                nearbyAmenities: getCheckedValues('amenityNearbyCheckboxes')
              };
            }
          } else if (listingTypeEl.value === 'vehicle') {
            listing.listingType = 'vehicle';
            listing.vehicleCategory = getValue('vehicleCategory');
            listing.subCategory = getValue('vehicleSubCategory');
            listing.make = getValue('vehicleMake');
            listing.model = getValue('vehicleModel');
            listing.title = getValue('vehicleTitle');
            listing.askingPrice = Number(getValue('vehicleAskingPrice'));
            listing.description = getValue('vehicleDescription');
            listing.priceType = getValue('vehiclePriceType');
            if (userAgentTier !== 'Basic') {
              listing.condition = getValue('vehicleCondition');
              listing.mileage = Number(getValue('vehicleMileage'));
            }
            if (userAgentTier === 'Premium') {
              listing.color = getValue('vehicleColor');
              listing.transmission = getValue('vehicleTransmission');
              listing.fuelType = getValue('vehicleFuelType');
            }
          }
          alert('Listing to submit (see console):\n' + JSON.stringify(listing, null, 2));
          console.log('Listing to submit:', listing);
          // TODO: Submit to Firestore
        });

        // --- CONFIG ---
        // Set this variable based on the logged-in user's agent tier:
        const userAgentTier = 'Premium'; // 'Basic', 'Standard', or 'Premium'

        // --- Dynamic Vehicle Dropdowns from Firestore ---
        let vehicleMakesModels = [];
        const vehicleCategoryEl = document.getElementById('vehicleCategory');
        const vehicleMakeEl = document.getElementById('vehicleMake');
        const vehicleModelEl = document.getElementById('vehicleModel');

        document.addEventListener('DOMContentLoaded', async function() {
          await fetchVehicleMakesModels();
          populateVehicleCategories();
          setupVehicleDropdownListeners();
        });

        async function fetchVehicleMakesModels() {
          try {
            const snap = await db.collection('vehicleMakesModels').get();
            vehicleMakesModels = snap.docs.map(doc => doc.data());
            console.log('vehicleMakesModels:', vehicleMakesModels);
          } catch (e) {
            vehicleMakesModels = [];
            console.error('Error fetching vehicleMakesModels:', e);
          }
        }

        function populateVehicleCategories() {
          if (!vehicleCategoryEl) return;
          vehicleCategoryEl.length = 1;
          const allowedCategories = [
            'Cars', 'Motorcycles', 'Trucks & Lorries', 'Buses & Vans',
            'Heavy Machinery', 'Bicycles & E-bikes', 'Boats & Watercraft'
          ];
          allowedCategories.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type;
            opt.textContent = type;
            vehicleCategoryEl.appendChild(opt);
          });
        }

        function setupVehicleDropdownListeners() {
          if (!vehicleCategoryEl || !vehicleMakeEl || !vehicleModelEl) return;

          vehicleCategoryEl.addEventListener('change', function() {
            const selectedType = vehicleCategoryEl.value.trim();
            const makes = vehicleMakesModels
              .filter(item => item.vehicleType && item.vehicleType.trim().toLowerCase() === selectedType.toLowerCase())
              .map(item => item.make)
              .filter((v, i, a) => v && a.indexOf(v) === i);
            vehicleMakeEl.length = 1;
            makes.forEach(make => {
              const opt = document.createElement('option');
              opt.value = make;
              opt.textContent = make;
              vehicleMakeEl.appendChild(opt);
            });
            vehicleModelEl.length = 1;
          });

          vehicleMakeEl.addEventListener('change', function() {
            const selectedType = vehicleCategoryEl.value.trim();
            const selectedMake = vehicleMakeEl.value.trim();
            const makeObj = vehicleMakesModels.find(
              item =>
                item.vehicleType &&
                item.make &&
                item.vehicleType.trim().toLowerCase() === selectedType.toLowerCase() &&
                item.make.trim().toLowerCase() === selectedMake.toLowerCase()
            );
            vehicleModelEl.length = 1;
            if (makeObj && Array.isArray(makeObj.models)) {
              makeObj.models.forEach(model => {
                const opt = document.createElement('option');
                opt.value = model;
                opt.textContent = model;
                vehicleModelEl.appendChild(opt);
              });
            }
          });
        }

        // --- Dynamic Property Dropdowns from Firestore ---
        let propertyMeta = null;
        const houseSubCategoryEl = document.getElementById('houseSubCategory');
        const landSubCategoryEl = document.getElementById('landSubCategory');

        async function fetchPropertyMeta() {
          try {
            // Assume a collection 'propertyMeta' with a single doc containing all enums
            const snap = await db.collection('propertyMeta').limit(1).get();
            if (!snap.empty) {
              propertyMeta = snap.docs[0].data();
              console.log('propertyMeta:', propertyMeta);
            } else {
              console.warn('propertyMeta: No documents found');
            }
          } catch (e) {
            propertyMeta = null;
            console.error('Error fetching propertyMeta:', e);
          }
          populatePropertyTypeDropdown();
        }

        function populatePropertyTypeDropdown() {
          if (propertyMeta && propertyMeta.propertyTypes) {
            propertyTypeEl.innerHTML = '<option value="">Select Property Type</option>' + propertyMeta.propertyTypes.map(pt => `<option value="${pt.value}">${pt.label}</option>`).join('');
          } else {
            // fallback to hardcoded
            propertyTypeEl.innerHTML = '<option value="">Select Property Type</option>' +
              '<option value="house_sale">House for Sale</option>' +
              '<option value="house_rent">House for Rent</option>' +
              '<option value="land_sale">Land for Sale</option>' +
              '<option value="land_rent">Land for Rent</option>' +
              '<option value="vacation_short_stay">Vacation & Short Stay</option>';
          }
          houseSubCategoryEl.innerHTML = '<option value="">Select</option>';
          landSubCategoryEl.innerHTML = '<option value="">Select</option>';
        }

        propertyTypeEl.addEventListener('change', function() {
          const type = this.value;
          // House subcategories
          if (["house_sale","house_rent","vacation_short_stay"].includes(type)) {
            if (propertyMeta && propertyMeta.houseSubCategories) {
              houseSubCategoryEl.innerHTML = '<option value="">Select</option>' + propertyMeta.houseSubCategories.map(sc => `<option>${sc}</option>`).join('');
            } else {
              houseSubCategoryEl.innerHTML = '<option value="">Select</option>' +
                '<option>Houses</option><option>Apartments</option><option>Condominiums</option><option>Townhouses</option><option>Villas</option><option>Single Rooms</option><option>Hostels</option><option>Serviced Apartments</option><option>Family Homes</option><option>Airbnbs</option><option>Cottages</option><option>Beach Houses</option><option>Lodges</option>';
            }
          } else {
            houseSubCategoryEl.innerHTML = '<option value="">Select</option>';
          }
          // Land subcategories
          if (["land_sale","land_rent"].includes(type)) {
            if (propertyMeta && propertyMeta.landSubCategories) {
              landSubCategoryEl.innerHTML = '<option value="">Select</option>' + propertyMeta.landSubCategories.map(sc => `<option>${sc}</option>`).join('');
            } else {
              landSubCategoryEl.innerHTML = '<option value="">Select</option>' +
                '<option>Residential Land</option><option>Commercial Land</option><option>Agricultural Land</option><option>Industrial Land</option>';
            }
          } else {
            landSubCategoryEl.innerHTML = '<option value="">Select</option>';
          }
        });

        fetchPropertyMeta();

        // --- INIT ---
        setFieldVisibility();

        // Restore setFieldVisibility function
        function setFieldVisibility() {
          // Hide all sections by default
          propertySection.classList.add('d-none');
          vehicleSection.classList.add('d-none');
          houseDetailsSection.classList.add('d-none');
          landDetailsSection.classList.add('d-none');
          ownershipDetailsSection.classList.add('d-none');
          amenitiesSection.classList.add('d-none');
          leaseYearsField.classList.add('d-none');
          vehicleStandardFields.classList.add('d-none');
          vehiclePremiumFields.classList.add('d-none');

          if (listingTypeEl.value === 'property') {
            propertySection.classList.remove('d-none');
            if (userAgentTier === 'Basic') {
              houseDetailsSection.classList.add('d-none');
              landDetailsSection.classList.add('d-none');
              ownershipDetailsSection.classList.add('d-none');
              amenitiesSection.classList.add('d-none');
            }
            if (userAgentTier === 'Standard' || userAgentTier === 'Premium') {
              if (["house_sale","house_rent","vacation_short_stay"].includes(propertyTypeEl.value)) {
                houseDetailsSection.classList.remove('d-none');
                landDetailsSection.classList.add('d-none');
              } else if (["land_sale","land_rent"].includes(propertyTypeEl.value)) {
                landDetailsSection.classList.remove('d-none');
                houseDetailsSection.classList.add('d-none');
              } else {
                houseDetailsSection.classList.add('d-none');
                landDetailsSection.classList.add('d-none');
              }
              ownershipDetailsSection.classList.remove('d-none');
              if (userAgentTier === 'Premium') {
                amenitiesSection.classList.remove('d-none');
              }
            }
            if (userAgentTier === 'Premium' && getValue('ownershipType') === 'Leasehold') {
              leaseYearsField.classList.remove('d-none');
            }
          } else if (listingTypeEl.value === 'vehicle') {
            vehicleSection.classList.remove('d-none');
            if (userAgentTier === 'Basic') {
              vehicleStandardFields.classList.add('d-none');
              vehiclePremiumFields.classList.add('d-none');
            }
            if (userAgentTier === 'Standard' || userAgentTier === 'Premium') {
              vehicleStandardFields.classList.remove('d-none');
              if (userAgentTier === 'Premium') {
                vehiclePremiumFields.classList.remove('d-none');
              }
            }
          }
        }
      });
    });
  </script>
</body>
</html>