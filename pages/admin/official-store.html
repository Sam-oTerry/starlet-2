<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Official Store | Starlet Properties</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    body { background: #f8fafc; }
    .sidebar {
      min-height: 100vh;
      background: #fff;
      border-right: 1px solid #e3eaf5;
      padding: 2rem 1rem 1rem 1rem;
    }
    .sidebar .nav-link {
      color: #0d6efd;
      font-weight: 500;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.7em;
      transition: background 0.2s, color 0.2s;
    }
    .sidebar .nav-link.active, .sidebar .nav-link:hover {
      background: #0d6efd;
      color: #fff;
    }
    .dashboard-content { padding: 2rem; }
    .summary-card { border-radius: 1rem; box-shadow: 0 2px 8px #0d6efd11; }
  </style>
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <nav class="sidebar d-flex flex-column flex-shrink-0 p-3">
      <a href="dashboard.html" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none">
        <span class="fs-4 fw-bold"><span class="brand-star">Star</span><span class="brand-let">Let</span> Admin</span>
      </a>
      <hr>
      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
        <li><a href="listings.html" class="nav-link"><i class="bi bi-list-ul"></i> Listings</a></li>
        <li><a href="users.html" class="nav-link"><i class="bi bi-people"></i> Users</a></li>
        <li><a href="stores.html" class="nav-link"><i class="bi bi-shop"></i> Stores</a></li>
        <li><a href="official-store.html" class="nav-link active"><i class="bi bi-patch-check"></i> Official Store</a></li>
        <li><a href="analytics.html" class="nav-link"><i class="bi bi-bar-chart"></i> Analytics</a></li>
        <li><a href="#" class="nav-link"><i class="bi bi-gear"></i> Settings</a></li>
        <li><a href="#" class="nav-link"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
      </ul>
    </nav>
    <!-- Main Content -->
    <div class="flex-grow-1">
      <!-- Top Navbar -->
      <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
        <div class="container-fluid">
          <a class="navbar-brand fw-bold" href="dashboard.html">
            <span class="brand-star">Star</span><span class="brand-let">Let</span> Admin
          </a>
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Admin" width="32" height="32" class="rounded-circle me-2"> Admin
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                <li><a class="dropdown-item" href="#">Profile</a></li>
                <li><a class="dropdown-item" href="#">Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#">Logout</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <!-- Official Store Content -->
      <div class="dashboard-content">
        <h2 class="mb-4">Manage Official Store</h2>
        <div class="card mb-4">
          <div class="card-body" id="official-store-details">
            <!-- Official store details will be loaded here -->
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4>Official Store Listings</h4>
          <button class="btn btn-primary" id="addListingBtn"><i class="bi bi-plus-lg"></i> Add Listing</button>
        </div>
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover align-middle" id="official-listings-table">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Price</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Listings will be injected here by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- Listing Details Modal -->
        <div class="modal fade" id="officialListingDetailsModal" tabindex="-1" aria-labelledby="officialListingDetailsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="officialListingDetailsModalLabel">Listing Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <!-- Details will be injected by JS -->
              </div>
            </div>
          </div>
        </div>
        <!-- Add/Edit Listing Modal (to be implemented) -->
        <div class="modal fade" id="addEditListingModal" tabindex="-1" aria-labelledby="addEditListingModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addEditListingModalLabel">Add/Edit Listing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <!-- Add/Edit Listing Form will be injected by JS -->
                <div id="addEditListingFormContainer"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="../../js/admin.js"></script>
  <!-- Official Store JS will be added next -->
  <script>
  enforceAuth('admin').then(user => {
    // --- Add/Edit Listing Modal (full form, dynamic like addlistings.html) ---
    let vehicleMakesModels = [];
    let propertyMeta = null;

    // Fetch vehicle makes/models and property meta on page load
    fetchVehicleMakesModels();
    fetchPropertyMeta();

    async function fetchVehicleMakesModels() {
      try {
        const snap = await db.collection('vehicleMakesModels').get();
        vehicleMakesModels = snap.docs.map(doc => doc.data());
      } catch (e) {
        vehicleMakesModels = [];
      }
    }
    async function fetchPropertyMeta() {
      try {
        const snap = await db.collection('propertyMeta').limit(1).get();
        if (!snap.empty) propertyMeta = snap.docs[0].data();
        else propertyMeta = null;
      } catch (e) {
        propertyMeta = null;
      }
    }

    function showAddEditListingModal(listing = null) {
      const isEdit = !!listing;
      // Modal form HTML (property/vehicle sections, dynamic fields)
      const formHtml = `
        <form id='addEditListingForm'>
          <div class='mb-3'>
            <label class='form-label'>Listing Type</label>
            <select id='modalListingType' class='form-select' name='listingType' required>
              <option value=''>Select Type</option>
              <option value='property' ${listing?.listingType && listing.listingType!=='vehicle'?'selected':''}>Property</option>
              <option value='vehicle' ${listing?.listingType==='vehicle'?'selected':''}>Vehicle</option>
            </select>
          </div>
          <div id='modalPropertySection' class='d-none'>
            <div class='mb-3'>
              <label class='form-label'>Property Type</label>
              <select id='modalPropertyType' class='form-select' name='propertyType'>
                <option value=''>Select Property Type</option>
                <option value='house_sale'>House for Sale</option>
                <option value='house_rent'>House for Rent</option>
                <option value='land_sale'>Land for Sale</option>
                <option value='land_rent'>Land for Rent</option>
                <option value='vacation_short_stay'>Vacation & Short Stay</option>
              </select>
            </div>
            <div class='mb-3'>
              <label class='form-label'>Title</label>
              <input id='modalPropertyTitle' name='title' type='text' class='form-control' value='${listing?.title||''}' required>
            </div>
            <div class='mb-3'>
              <label class='form-label'>Asking Price (UGX)</label>
              <input id='modalPropertyAskingPrice' name='askingPrice' type='number' class='form-control' value='${listing?.askingPrice||''}' required>
            </div>
            <div class='mb-3'>
              <label class='form-label'>District</label>
              <input id='modalPropertyDistrict' name='district' type='text' class='form-control' value='${listing?.location?.district||''}' required>
            </div>
            <div class='mb-3'>
              <label class='form-label'>Description</label>
              <textarea id='modalPropertyDescription' name='description' class='form-control' rows='2'>${listing?.description||''}</textarea>
            </div>
          </div>
          <div id='modalVehicleSection' class='d-none'>
            <div class='mb-3'>
              <label class='form-label'>Vehicle Category</label>
              <select id='modalVehicleCategory' class='form-select' name='vehicleCategory'>
                <option value=''>Select Category</option>
                <option value='Cars'>Cars</option>
                <option value='Motorcycles'>Motorcycles</option>
                <option value='Trucks & Lorries'>Trucks & Lorries</option>
                <option value='Buses & Vans'>Buses & Vans</option>
                <option value='Heavy Machinery'>Heavy Machinery</option>
                <option value='Bicycles & E-bikes'>Bicycles & E-bikes</option>
                <option value='Boats & Watercraft'>Boats & Watercraft</option>
              </select>
            </div>
            <div class='mb-3'>
              <label class='form-label'>Make</label>
              <select id='modalVehicleMake' class='form-select' name='make'></select>
            </div>
            <div class='mb-3'>
              <label class='form-label'>Model</label>
              <select id='modalVehicleModel' class='form-select' name='model'></select>
            </div>
            <div class='mb-3'>
              <label class='form-label'>Title</label>
              <input id='modalVehicleTitle' name='title' type='text' class='form-control' value='${listing?.title||''}' required>
            </div>
            <div class='mb-3'>
              <label class='form-label'>Asking Price (UGX)</label>
              <input id='modalVehicleAskingPrice' name='askingPrice' type='number' class='form-control' value='${listing?.askingPrice||''}' required>
            </div>
            <div class='mb-3'>
              <label class='form-label'>Description</label>
              <textarea id='modalVehicleDescription' name='description' class='form-control' rows='2'>${listing?.description||''}</textarea>
            </div>
          </div>
          <button type='submit' class='btn btn-primary'>${isEdit ? 'Save Changes' : 'Add Listing'}</button>
        </form>
      `;
      document.getElementById('addEditListingFormContainer').innerHTML = formHtml;
      const modal = new bootstrap.Modal(document.getElementById('addEditListingModal'));
      modal.show();

      // --- Dynamic Section Toggle ---
      const modalListingType = document.getElementById('modalListingType');
      const modalPropertySection = document.getElementById('modalPropertySection');
      const modalVehicleSection = document.getElementById('modalVehicleSection');
      function toggleModalSections() {
        if (modalListingType.value === 'property') {
          modalPropertySection.classList.remove('d-none');
          modalVehicleSection.classList.add('d-none');
        } else if (modalListingType.value === 'vehicle') {
          modalPropertySection.classList.add('d-none');
          modalVehicleSection.classList.remove('d-none');
        } else {
          modalPropertySection.classList.add('d-none');
          modalVehicleSection.classList.add('d-none');
        }
      }
      modalListingType.addEventListener('change', toggleModalSections);
      toggleModalSections();

      // --- Dynamic Vehicle Dropdowns ---
      const modalVehicleCategory = document.getElementById('modalVehicleCategory');
      const modalVehicleMake = document.getElementById('modalVehicleMake');
      const modalVehicleModel = document.getElementById('modalVehicleModel');
      function populateModalVehicleMakes() {
        const selectedType = modalVehicleCategory.value.trim();
        const makes = vehicleMakesModels
          .filter(item => item.vehicleType && item.vehicleType.trim().toLowerCase() === selectedType.toLowerCase())
          .map(item => item.make)
          .filter((v, i, a) => v && a.indexOf(v) === i);
        modalVehicleMake.length = 1;
        makes.forEach(make => {
          const opt = document.createElement('option');
          opt.value = make;
          opt.textContent = make;
          modalVehicleMake.appendChild(opt);
        });
        modalVehicleModel.length = 1;
      }
      function populateModalVehicleModels() {
        const selectedType = modalVehicleCategory.value.trim();
        const selectedMake = modalVehicleMake.value.trim();
        const makeObj = vehicleMakesModels.find(
          item =>
            item.vehicleType &&
            item.make &&
            item.vehicleType.trim().toLowerCase() === selectedType.toLowerCase() &&
            item.make.trim().toLowerCase() === selectedMake.toLowerCase()
        );
        modalVehicleModel.length = 1;
        if (makeObj && Array.isArray(makeObj.models)) {
          makeObj.models.forEach(model => {
            const opt = document.createElement('option');
            opt.value = model;
            opt.textContent = model;
            modalVehicleModel.appendChild(opt);
          });
        }
      }
      modalVehicleCategory.addEventListener('change', populateModalVehicleMakes);
      modalVehicleMake.addEventListener('change', populateModalVehicleModels);
      if (listing && listing.listingType === 'vehicle') {
        modalVehicleCategory.value = listing.vehicleDetails?.vehicleCategory || '';
        populateModalVehicleMakes();
        modalVehicleMake.value = listing.vehicleDetails?.make || '';
        populateModalVehicleModels();
        modalVehicleModel.value = listing.vehicleDetails?.model || '';
      }

      // --- Form Submit ---
      document.getElementById('addEditListingForm').onsubmit = async function(e) {
        e.preventDefault();
        const fd = new FormData(this);
        let data = {
          storeId: officialStoreId,
          isOfficial: true,
          status: 'pending',
          createdAt: listing?.createdAt || new Date(),
          updatedAt: new Date()
        };
        if (fd.get('listingType') === 'property') {
          data.listingType = fd.get('propertyType');
          data.title = fd.get('title');
          data.askingPrice = Number(fd.get('askingPrice'));
          data.location = { district: fd.get('district') };
          data.description = fd.get('description');
        } else if (fd.get('listingType') === 'vehicle') {
          data.listingType = 'vehicle';
          data.vehicleDetails = {
            vehicleCategory: fd.get('vehicleCategory'),
            make: fd.get('make'),
            model: fd.get('model')
          };
          data.title = fd.get('title');
          data.askingPrice = Number(fd.get('askingPrice'));
          data.description = fd.get('description');
        }
        if (isEdit) {
          await db.collection('listings').doc(listing.id).update(data);
          showToast('Listing updated');
        } else {
          await db.collection('listings').add(data);
          showToast('Listing added');
        }
        modal.hide();
        fetchAndRenderOfficialListings();
      };
    }

    // Add Listing button handler
    const addListingBtn = document.getElementById('addListingBtn');
    if (addListingBtn) {
      addListingBtn.onclick = () => showAddEditListingModal();
    }
  });
  </script>
</body>
</html> 