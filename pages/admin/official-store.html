<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Official Store | Starlet Properties</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Custom Styles -->
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="icon" type="image/x-icon" href="../../favicon.ico">
</head>
<body class="admin-panel">
  <!-- Admin Sidebar as Bootstrap Offcanvas -->
  <div class="offcanvas offcanvas-start admin-sidebar d-lg-flex flex-column flex-shrink-0 p-3" tabindex="-1" id="adminSidebar" aria-labelledby="adminSidebarLabel">
    <div class="offcanvas-header d-lg-none">
      <h5 class="offcanvas-title sidebar-brand" id="adminSidebarLabel"><span class="brand-star">Star</span><span class="brand-let">Let</span> Admin</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="sidebar-brand mb-4 d-none d-lg-block"><span class="brand-star">Star</span><span class="brand-let">Let</span> Admin</div>
    <ul class="nav nav-pills flex-column mb-auto">
      <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
      <li><a href="listings.html" class="nav-link"><i class="bi bi-list-ul"></i> Listings</a></li>
      <li><a href="users.html" class="nav-link"><i class="bi bi-people"></i> Users</a></li>
      <li><a href="stores.html" class="nav-link"><i class="bi bi-shop"></i> Stores</a></li>
      <li><a href="official-store.html" class="nav-link active"><i class="bi bi-patch-check"></i> Official Store</a></li>
      <li><a href="analytics.html" class="nav-link"><i class="bi bi-bar-chart"></i> Analytics</a></li>
      <li><a href="messages.html" class="nav-link"><i class="bi bi-chat-dots"></i> Messages</a></li>
      <li><a href="reviews.html" class="nav-link"><i class="bi bi-star"></i> Reviews</a></li>
      <li><a href="settings.html" class="nav-link"><i class="bi bi-gear"></i> Settings</a></li>
      <li><a href="#" class="logout-link nav-link"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
    </ul>
  </div>
  <!-- Admin Navbar -->
  <nav class="admin-navbar d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <button class="btn btn-outline-primary d-lg-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#adminSidebar" aria-controls="adminSidebar" aria-label="Open sidebar"><i class="bi bi-list"></i></button>
      <div class="navbar-brand">
        <span class="brand-star">Star</span> <span class="brand-let">Let</span> Admin
      </div>
    </div>
    <div class="profile-dropdown dropdown">
      <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <span class="profile-avatar me-2"><img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Admin"></span>
        <span>Admin</span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
        <li><a class="dropdown-item" href="#">Profile</a></li>
        <li><a class="dropdown-item" href="#">Settings</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item logout-link" href="#"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
      </ul>
    </div>
  </nav>
  <!-- Main Content -->
  <main style="min-height: 100vh;">
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="container">
        <h2 class="hero-title">Manage Official Store</h2>
        <p class="hero-subtitle">View, add, and manage official store listings and details</p>
      </div>
    </section>
    <div class="container my-5">
      <!-- Official Store Content (Retain all original functionality) -->
      <div class="card mb-4">
        <div class="card-body" id="official-store-details">
          <!-- Official store details will be loaded here -->
        </div>
      </div>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Official Store Listings</h4>
        <a href="add-official-listing.html" class="btn btn-primary" id="addListingBtn"><i class="bi bi-plus-lg"></i> Add Listing</a>
      </div>
      <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
        <div class="btn-group" role="group" aria-label="Bulk actions">
          <button class="btn btn-success btn-sm" id="bulkApproveBtn" disabled data-bs-toggle="tooltip" title="Approve selected"><i class="bi bi-patch-check"></i></button>
          <button class="btn btn-danger btn-sm" id="bulkRejectBtn" disabled data-bs-toggle="tooltip" title="Reject selected"><i class="bi bi-x-octagon"></i></button>
          <button class="btn btn-outline-danger btn-sm" id="bulkDeleteBtn" disabled data-bs-toggle="tooltip" title="Delete selected"><i class="bi bi-trash"></i></button>
        </div>
        <button class="btn btn-secondary btn-sm" id="exportCsvBtn" data-bs-toggle="tooltip" title="Export all to CSV"><i class="bi bi-download"></i> Export CSV</button>
        <span class="ms-3 text-muted" id="selectedCount"></span>
      </div>
      <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer" style="z-index: 1080;"></div>
      <!-- Confirmation Modal -->
      <div class="modal fade" id="bulkConfirmModal" tabindex="-1" aria-labelledby="bulkConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="bulkConfirmModalLabel">Confirm Bulk Action</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="bulkConfirmModalBody"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="bulkConfirmModalOk">OK</button>
            </div>
          </div>
        </div>
      </div>
      <div class="card card-modern">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle" id="official-listings-table">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllOfficialListings"></th>
                  <th>Title</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Price</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Listings will be injected here by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Listing Details Modal -->
      <div class="modal fade" id="officialListingDetailsModal" tabindex="-1" aria-labelledby="officialListingDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="officialListingDetailsModalLabel">Listing Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <!-- Details will be injected by JS -->
            </div>
          </div>
        </div>
      </div>
      <!-- Add/Edit Listing Modal (advanced form) -->
      <div class="modal fade" id="addEditListingModal" tabindex="-1" aria-labelledby="addEditListingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addEditListingModalLabel">Add/Edit Listing</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="addEditListingForm">
                <!-- Listing Type -->
                <div class="mb-3">
                  <label class="form-label">Listing Type</label>
                  <select id="modalListingType" class="form-select" name="listingType" required>
                    <option value="">Select Type</option>
                    <option value="property">Property</option>
                    <option value="vehicle">Vehicle</option>
                  </select>
                </div>
                <!-- Property Section -->
                <div id="modalPropertySection" class="d-none">
                  <!-- (copy all property fields/sections from add.html, use modal- prefix for IDs) -->
                  <!-- Property fields go here (see add.html, use modal- prefix) -->
                </div>
                <!-- Vehicle Section -->
                <div id="modalVehicleSection" class="d-none">
                  <!-- (copy all vehicle fields/sections from add.html, use modal- prefix for IDs) -->
                  <!-- Vehicle fields go here (see add.html, use modal- prefix) -->
                </div>
                <div class="mt-4">
                  <button type="submit" class="btn btn-primary px-4">Submit Listing</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 mb-4">
          <h4>About Starlet Properties</h4>
          <p>Uganda's premier real estate and vehicle marketplace, connecting buyers and sellers across the country.</p>
          <div class="social-links">
            <a href="#"><i class="fab fa-facebook"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-linkedin"></i></a>
          </div>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Properties</h4>
          <ul>
            <li><a href="/properties.html?type=house_sale">Houses for Sale</a></li>
            <li><a href="/properties.html?type=house_rent">Houses for Rent</a></li>
            <li><a href="/properties.html?type=land_sale">Land for Sale</a></li>
            <li><a href="/properties.html?type=land_rent">Land for Rent</a></li>
            <li><a href="/properties.html?type=commercial">Commercial Property</a></li>
            <li><a href="/properties.html?type=vacation_short_stay">Vacation & Short Stay</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Vehicles</h4>
          <ul>
            <li><a href="/pages/vehicles/index.html?type=cars">Cars</a></li>
            <li><a href="/pages/vehicles/index.html?type=motorcycles">Motorcycles</a></li>
            <li><a href="/pages/vehicles/index.html?type=trucks">Trucks</a></li>
            <li><a href="/pages/vehicles/index.html?type=buses">Buses</a></li>
            <li><a href="/pages/vehicles/index.html?type=heavy_machinery">Heavy Machinery</a></li>
            <li><a href="/pages/vehicles/index.html?type=bicycles_ebikes">Bicycles & E-bikes</a></li>
            <li><a href="/pages/vehicles/index.html?type=boats_watercraft">Boats & Watercraft</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Company</h4>
          <ul>
            <li><a href="/about.html">About Us</a></li>
            <li><a href="/contact.html">Contact</a></li>
            <li><a href="/resources.html">Resources</a></li>
            <li><a href="/stores.html">Our Stores</a></li>
            <li><a href="/privacy.html">Privacy Policy</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Contact</h4>
          <ul>
            <li><a href="tel:+256123456789"><i class="bi bi-telephone"></i> +256 123 456 789</a></li>
            <li><a href="mailto:info@starlet.co.ug"><i class="bi bi-envelope"></i> info@starlet.co.ug</a></li>
            <li><a href="#"><i class="bi bi-geo-alt"></i> Kampala, Uganda</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="row">
          <div class="col-md-6">
            <p class="mb-0">&copy; 2024 Starlet Properties. All rights reserved.</p>
          </div>
          <div class="col-md-6 text-md-end">
            <a href="/terms.html" class="me-3">Terms of Service</a>
            <a href="/privacy.html">Privacy Policy</a>
          </div>
        </div>
      </div>
    </div>
  </footer>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="../../js/admin.js"></script>
  <script src="../../js/main.js"></script>
  <script>
  // Enforce authentication on this page
  enforceAuth('../../auth/login.html');
  // Setup My Listings link logic
  document.addEventListener('DOMContentLoaded', function() {
      setupMyListingsLink('#myListingsLink', '../../auth/login.html', '../../stores/agent-stores/dashboard.html', '../../stores/agent-stores/create.html');
  });
  // Wait for admin.js to load and then use the proper admin authentication
  document.addEventListener('DOMContentLoaded', function() {
    if (window.enforceAuth) {
      window.enforceAuth().then(user => {
        // --- Add/Edit Listing Modal Logic (advanced) ---
        function showAddEditListingModal(listing = null) {
          // Render the advanced form (copy from add.html, use modal- prefix for IDs)
          // 1. Inject the full property and vehicle form sections into the modal, using modal- prefixes for all IDs.
          // 2. Setup dynamic field logic, dropdowns, and Firestore-powered options (as in add.html), but scoped to modal- IDs.
          // 3. If editing, prefill all fields.
          // 4. On submit, build listing object as in add.html, but always set isOfficial: true and storeId: officialStoreId.
          // 5. On success, show toast and refresh listings.
          // (Implementation will mirror add.html, but in the modal context)
        }

        // Add Listing button handler
        const addListingBtn = document.getElementById('addListingBtn');
        if (addListingBtn) {
          addListingBtn.onclick = () => showAddEditListingModal();
        }

        // Bulk actions and export for official listings
        function renderOfficialListingsTable(listings) {
          const tbody = document.querySelector('#official-listings-table tbody');
          tbody.innerHTML = '';
          if (!listings.length) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No listings found.</td></tr>`;
            document.getElementById('selectedCount').textContent = '';
            return;
          }
          listings.forEach((l, idx) => {
            const statusBadge = `<span class="badge bg-${l.status==='active'?'success':l.status==='pending'?'warning':l.status==='rejected'?'danger':'secondary'}">${l.status||''}</span>`;
            tbody.innerHTML += `
              <tr class="fade-in" style="animation-delay:${idx*0.07}s;" data-id="${l.id}">
                <td><input type="checkbox" class="official-listing-checkbox" data-id="${l.id}" aria-label="Select listing"></td>
                <td>${l.title||''}</td>
                <td>${l.listingType||''}</td>
                <td>${statusBadge}</td>
                <td>${l.askingPrice ? 'USh ' + Number(l.askingPrice).toLocaleString() : ''}</td>
                <td>${formatDate(l.createdAt)}</td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary" onclick="showOfficialListingDetails('${l.id}')" title="View Details"><i class="bi bi-eye"></i></button>
                    ${(l.status!=='active' && l.status!=='rejected') ? `<button class="btn btn-outline-success" onclick="verifyOfficialListing('${l.id}')" title="Approve"><i class="bi bi-patch-check"></i></button>` : ''}
                    ${(l.status!=='rejected' && l.status!=='active') ? `<button class="btn btn-outline-danger" onclick="rejectOfficialListing('${l.id}')" title="Reject"><i class="bi bi-x-octagon"></i></button>` : ''}
                  </div>
                </td>
              </tr>
            `;
          });
          updateSelectedCount();
          document.getElementById('selectAllOfficialListings').onclick = function() {
            document.querySelectorAll('.official-listing-checkbox').forEach(cb => cb.checked = this.checked);
            updateSelectedCount();
          };
          document.querySelectorAll('.official-listing-checkbox').forEach(cb => {
            cb.onchange = updateSelectedCount;
          });
          // Highlight selected rows
          document.querySelectorAll('.official-listing-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
              const row = cb.closest('tr');
              if (cb.checked) row.classList.add('table-active');
              else row.classList.remove('table-active');
            });
          });
        }
        function getSelectedOfficialListingIds() {
          return Array.from(document.querySelectorAll('.official-listing-checkbox:checked')).map(cb => cb.getAttribute('data-id'));
        }
        function updateSelectedCount() {
          const count = getSelectedOfficialListingIds().length;
          document.getElementById('selectedCount').textContent = count ? `${count} selected` : '';
          document.getElementById('bulkApproveBtn').disabled = count === 0;
          document.getElementById('bulkRejectBtn').disabled = count === 0;
          document.getElementById('bulkDeleteBtn').disabled = count === 0;
        }
        // Toast function
        function showToast(message, type = 'success') {
          const toastContainer = document.getElementById('toastContainer');
          const toast = document.createElement('div');
          toast.className = `toast align-items-center text-bg-${type} border-0 show`;
          toast.role = 'alert';
          toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
          toastContainer.appendChild(toast);
          setTimeout(() => toast.remove(), 4000);
        }
        // Confirmation modal
        function showBulkConfirmModal(action, callback) {
          const modal = new bootstrap.Modal(document.getElementById('bulkConfirmModal'));
          let msg = '';
          if (action === 'approve') msg = 'Approve selected listings?';
          else if (action === 'reject') msg = 'Reject selected listings?';
          else if (action === 'delete') msg = 'Delete selected listings? This cannot be undone.';
          document.getElementById('bulkConfirmModalBody').textContent = msg;
          document.getElementById('bulkConfirmModalOk').onclick = function() {
            modal.hide();
            callback();
          };
          modal.show();
        }
        // Batch Firestore writes
        async function batchUpdateListings(ids, updateObj) {
          const batch = db.batch();
          ids.forEach(id => {
            const ref = db.collection('listings').doc(id);
            batch.update(ref, updateObj);
          });
          await batch.commit();
        }
        async function batchDeleteListings(ids) {
          const batch = db.batch();
          ids.forEach(id => {
            const ref = db.collection('listings').doc(id);
            batch.delete(ref);
          });
          await batch.commit();
        }
        document.getElementById('bulkApproveBtn').onclick = function() {
          const ids = getSelectedOfficialListingIds();
          if (!ids.length) return showToast('No listings selected', 'danger');
          showBulkConfirmModal('approve', async () => {
            try {
              await batchUpdateListings(ids, { status: 'active' });
              showToast('Selected listings approved');
              fetchAndRenderOfficialListings();
            } catch (e) {
              showToast('Error approving listings', 'danger');
            }
          });
        };
        document.getElementById('bulkRejectBtn').onclick = function() {
          const ids = getSelectedOfficialListingIds();
          if (!ids.length) return showToast('No listings selected', 'danger');
          showBulkConfirmModal('reject', async () => {
            try {
              await batchUpdateListings(ids, { status: 'rejected' });
              showToast('Selected listings rejected', 'warning');
              fetchAndRenderOfficialListings();
            } catch (e) {
              showToast('Error rejecting listings', 'danger');
            }
          });
        };
        document.getElementById('bulkDeleteBtn').onclick = function() {
          const ids = getSelectedOfficialListingIds();
          if (!ids.length) return showToast('No listings selected', 'danger');
          showBulkConfirmModal('delete', async () => {
            try {
              await batchDeleteListings(ids);
              showToast('Selected listings deleted', 'danger');
              fetchAndRenderOfficialListings();
            } catch (e) {
              showToast('Error deleting listings', 'danger');
            }
          });
        };
        // Enable Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });
    }
  });
  </script>
</body>
</html> 
