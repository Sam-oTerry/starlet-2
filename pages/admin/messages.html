<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Messages | Starlet Properties</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Custom Styles -->
  <link rel="stylesheet" href="../../css/style.css">
  <style>
    /* Modern Messages Page Styles */
    .admin-main-content {
      min-height: 100vh;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    /* Page Header */
    .page-header {
      background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
    }

    .stat-card {
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    /* Conversations Container */
    .conversations-container {
      max-height: 800px;
      min-height: 600px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #dee2e6 #f8f9fa;
      display: flex;
      flex-direction: column;
    }

    .conversations-container::-webkit-scrollbar {
      width: 6px;
    }

    .conversations-container::-webkit-scrollbar-track {
      background: #f8f9fa;
    }

    .conversations-container::-webkit-scrollbar-thumb {
      background: #dee2e6;
      border-radius: 3px;
    }

    .conversations-container::-webkit-scrollbar-thumb:hover {
      background: #adb5bd;
    }

    /* Ensure conversations list takes full height */
    #conversationsList {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Empty state styling */
    .conversations-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: #6c757d;
    }

    .conversations-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: #6c757d;
    }

    /* Conversation Items */
    .conversation-item {
      padding: 1rem;
      border-bottom: 1px solid #f8f9fa;
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
      height: 110px; /* Adjusted height to ensure avatar fits */
      display: flex;
      align-items: center;
      overflow: hidden;
      box-sizing: border-box;
    }

    .conversation-item:hover {
      background-color: #f8f9fa;
      transform: translateX(4px);
    }

    .conversation-item.active {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border-left: 4px solid #0d6efd;
    }

    .conversation-item.unread {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
    }

    .conversation-item.unread::after {
      content: '';
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 8px;
      height: 8px;
      background: #dc3545;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    /* Conversation content layout */
    .conversation-content {
      display: flex;
      align-items: center;
      width: 100%;
      height: 100%;
      padding: 0.5rem 0;
      box-sizing: border-box;
    }

    .conversation-avatar {
      flex-shrink: 0;
      margin-right: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .conversation-avatar img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e9ecef;
    }

    .conversation-details {
      flex: 1;
      min-width: 0; /* Allow text to truncate */
      display: flex;
      flex-direction: column;
      justify-content: center;
      height: 100%;
      margin-left: 0.5rem;
    }

    .conversation-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.25rem;
    }

    .conversation-title {
      font-weight: 600;
      font-size: 1rem;
      color: #212529;
      margin: 0;
      line-height: 1.2;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70%;
    }

    .conversation-time {
      font-size: 0.8rem;
      color: #6c757d;
      flex-shrink: 0;
      margin-left: 0.5rem;
    }

    .conversation-subtitle {
      font-size: 0.85rem;
      color: #6c757d;
      margin: 0 0 0.25rem 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .conversation-message {
      font-size: 0.85rem;
      color: #6c757d;
      margin: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 1.3;
    }

    .conversation-badge {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      font-size: 0.7rem;
      min-width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    /* Chat Messages Container */
    .chat-messages-container {
      height: 500px;
      overflow-y: auto;
      padding: 1rem;
      background: #fafafa;
      scrollbar-width: thin;
      scrollbar-color: #dee2e6 #f8f9fa;
    }

    .chat-messages-container::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages-container::-webkit-scrollbar-track {
      background: #f8f9fa;
    }

    .chat-messages-container::-webkit-scrollbar-thumb {
      background: #dee2e6;
      border-radius: 3px;
    }

    /* Message Bubbles */
    .message-bubble {
      max-width: 70%;
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
    }

    .message-bubble.sent {
      background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .message-bubble.received {
      background: white;
      color: #212529;
      border: 1px solid #dee2e6;
      margin-right: auto;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 0.25rem;
    }

    .message-status {
      font-size: 0.75rem;
      margin-left: 0.5rem;
    }

    /* Chat Input */
    .chat-input-form {
      padding: 1rem;
    }

    .chat-input-form .input-group {
      border-radius: 25px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .chat-input-form .form-control {
      border: none;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
    }

    .chat-input-form .form-control:focus {
      box-shadow: none;
      border-color: #0d6efd;
    }

    .chat-input-form .btn {
      border: none;
      padding: 0.75rem 1rem;
      transition: all 0.2s ease;
    }

    .chat-input-form .btn:hover {
      transform: scale(1.05);
    }

    /* Quick Action Cards */
    .quick-action-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .quick-action-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      border-color: #0d6efd;
    }

    /* Typing Indicator */
    .typing-indicator {
      animation: fadeInOut 1.5s ease-in-out infinite;
    }

    @keyframes fadeInOut {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    /* Message Actions */
    .message-actions {
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 10;
    }

    .message-bubble:hover .message-actions {
      opacity: 1;
    }

    .message-actions .dropdown-toggle {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.1);
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    .message-actions .dropdown-toggle:hover {
      background: rgba(255, 255, 255, 1);
      border-color: rgba(0, 0, 0, 0.2);
    }

    .message-bubble.sent .message-actions .dropdown-toggle {
      background: rgba(13, 110, 253, 0.9);
      color: white;
      border-color: rgba(255, 255, 255, 0.2);
    }

    .message-bubble.sent .message-actions .dropdown-toggle:hover {
      background: rgba(13, 110, 253, 1);
    }

    /* Message Selection */
    .message-bubble.selected {
      outline: 2px solid #0d6efd;
      outline-offset: 2px;
    }

    .message-bubble {
      cursor: pointer;
      transition: outline 0.2s ease;
    }

    .message-bubble:hover {
      outline: 1px solid rgba(13, 110, 253, 0.3);
    }

    /* Unread messages badge styling */
    #unreadMessagesBadge {
      font-size: 0.7rem;
      min-width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
      }
    }
    
    #messagesIcon {
      transition: transform 0.2s ease;
    }
    
    #messagesIcon:hover {
      transform: scale(1.1);
    }
  
    /* Sidebar Toggle Functionality */
    .admin-sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 280px;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      z-index: 1040;
      transition: transform 0.3s ease;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      overflow-y: auto;
    }
    
    .admin-sidebar.collapsed {
      transform: translateX(-100%);
    }
    
    .admin-sidebar .sidebar-header {
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.1);
    }
    
    .admin-sidebar .sidebar-brand {
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .admin-sidebar .nav-link {
      color: rgba(255,255,255,0.8);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.25rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .admin-sidebar .nav-link:hover {
      color: white;
      background: rgba(255,255,255,0.1);
      transform: translateX(5px);
    }
    
    .admin-sidebar .nav-link.active {
      background: #0d6efd;
      color: white;
      box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
    }
    
    .admin-sidebar .nav-link i {
      width: 20px;
      text-align: center;
    }
    
    /* Sidebar Toggle Button */
    .sidebar-toggle {
      transition: all 0.3s ease;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
    }
    
    .sidebar-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
    }
    
    .sidebar-toggle .bi-list {
      transition: transform 0.3s ease;
    }
    
    .sidebar-toggle.active .bi-list {
      transform: rotate(90deg);
    }
    
    /* Main Content Adjustment */
    .admin-panel {
      padding-left: 280px;
      transition: padding-left 0.3s ease;
    }
    
    .admin-panel.sidebar-collapsed {
      padding-left: 0;
    }
    
    /* Admin Navbar */
    .admin-navbar {
      background: white;
      border-bottom: 1px solid #dee2e6;
      padding: 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1030;
    }
    
    /* Notification Badge */
    #notificationBadge {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      /* Mobile sidebar behavior */
      .admin-sidebar {
        transform: translateX(-100%);
      }
      
      .admin-sidebar.show {
        transform: translateX(0);
      }
      
      .admin-panel {
        padding-left: 0;
      }
      
      .admin-navbar {
        padding: 1rem;
      }
    }
    
    @media (max-width: 576px) {
      .admin-navbar .navbar-brand {
        font-size: 1rem;
      }
      
      .sidebar-toggle {
        padding: 0.4rem 0.6rem;
      }
    }
  </style>
</head>
<body class="admin-panel">
    <!-- Admin Sidebar -->
  <div class="admin-sidebar" id="adminSidebar">
    <div class="sidebar-header d-flex align-items-center justify-content-between p-3">
      <div class="sidebar-brand">
        <span class="brand-star">Star</span><span class="brand-let">Let</span> Admin
      </div>
      <button type="button" class="btn-close btn-close-white d-lg-none" id="sidebarCloseBtn" aria-label="Close sidebar"></button>
    </div>
    <div class="sidebar-content p-3">
      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">
            <i class="bi-speedometer2"></i>
            <span class="nav-text">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="listings.html" class="nav-link">
            <i class="bi-list-ul"></i>
            <span class="nav-text">Listings</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="users.html" class="nav-link">
            <i class="bi-people"></i>
            <span class="nav-text">Users</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="stores.html" class="nav-link">
            <i class="bi-shop"></i>
            <span class="nav-text">Stores</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="official-store.html" class="nav-link">
            <i class="bi-patch-check"></i>
            <span class="nav-text">Official Store</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="analytics.html" class="nav-link">
            <i class="bi-bar-chart"></i>
            <span class="nav-text">Analytics</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="messages.html" class="nav-link active">
            <i class="bi-chat-dots"></i>
            <span class="nav-text">Messages</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="reviews.html" class="nav-link">
            <i class="bi-star"></i>
            <span class="nav-text">Reviews</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="settings.html" class="nav-link">
            <i class="bi-gear"></i>
            <span class="nav-text">Settings</span>
          </a>
        </li>
        <li class="nav-item mt-auto">
          <a href="#" class="logout-link nav-link">
            <i class="bi bi-box-arrow-right"></i>
            <span class="nav-text">Logout</span>
          </a>
        </li>
      </ul>
    </div>
  </div>
  <!-- Admin Navbar -->
  <nav class="admin-navbar d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <!-- Sidebar Toggle Button -->
      <button class="btn btn-outline-primary sidebar-toggle me-3" type="button" id="sidebarToggle" aria-label="Toggle sidebar">
        <i class="bi bi-list" id="sidebarToggleIcon"></i>
      </button>
      <div class="navbar-brand">
        <span class="brand-star">Star</span> <span class="brand-let">Let</span> Admin
      </div>
    </div>
    <div class="d-flex align-items-center">
      <!-- Notifications -->
      <div class="position-relative me-3">
        <button class="btn btn-outline-secondary btn-sm" id="notificationsBtn" title="Notifications">
          <i class="bi bi-bell"></i>
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="font-size: 0.6rem; display: none;">0</span>
        </button>
      </div>
      <!-- Profile Dropdown -->
      <div class="profile-dropdown dropdown">
        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="profile-avatar me-2">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzBkNmVmZCIvPgo8dGV4dCB4PSIxNiIgeT0iMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BPC90ZXh0Pgo8L3N2Zz4K" alt="Admin">
          </span>
          <span id="adminName">Admin</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
          <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
          <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item logout-link" href="#"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <nav class="admin-navbar d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <!-- Sidebar Toggle Button -->
      <button class="btn btn-outline-primary sidebar-toggle me-3" type="button" id="sidebarToggle" aria-label="Toggle sidebar">
        <i class="bi bi-list" id="sidebarToggleIcon"></i>
      </button>
      <div class="navbar-brand">
        <span class="brand-star">Star</span> <span class="brand-let">Let</span> Admin
      </div>
    </div>
    <div class="d-flex align-items-center">
      <!-- Notifications -->
      <div class="position-relative me-3">
        <button class="btn btn-outline-secondary btn-sm" id="notificationsBtn" title="Notifications">
          <i class="bi bi-bell"></i>
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="font-size: 0.6rem; display: none;">0</span>
        </button>
      </div>
      <!-- Profile Dropdown -->
      <div class="profile-dropdown dropdown">
        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="profile-avatar me-2">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzBkNmVmZCIvPgo8dGV4dCB4PSIxNiIgeT0iMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BPC90ZXh0Pgo8L3N2Zz4K" alt="Admin">
          </span>
          <span id="adminName">Admin</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
          <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
          <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item logout-link" href="#"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <!-- Main Content -->
  <main class="admin-main-content">
    <!-- Page Header -->
    <div class="page-header bg-gradient-primary text-white py-4">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1 class="h3 mb-2">
              <i class="bi bi-chat-dots me-2"></i>
              Messages & Communications
            </h1>
            <p class="mb-0 opacity-75">Manage all user inquiries, notifications, and official store communications</p>
            <div class="mt-2">
              <small class="opacity-75">
                <i class="bi bi-info-circle me-1"></i>
                <strong>Tip:</strong> Click on messages to select them, use Ctrl+Delete to delete, or hover for more options
              </small>
              <div class="mt-2">
                <button class="btn btn-sm btn-outline-light" onclick="requestNotificationPermission()">
                  <i class="bi bi-bell"></i> Enable Notifications
                </button>
              </div>
            </div>
      </div>
          <div class="col-md-4 text-md-end">
            <div class="d-flex align-items-center justify-content-md-end gap-3">
              <div class="stat-card bg-white bg-opacity-10 rounded p-3 text-center">
                <div class="h4 mb-1" id="totalConversations">0</div>
                <small class="opacity-75">Conversations</small>
              </div>
              <div class="stat-card bg-white bg-opacity-10 rounded p-3 text-center">
                <div class="h4 mb-1 text-warning" id="unreadCount">0</div>
                <small class="opacity-75">Unread</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="container-fluid py-4">
          <div class="row">
        <!-- Conversations Sidebar -->
        <div class="col-lg-4 col-xl-3 mb-4">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-white border-bottom">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-0">
                  <i class="bi bi-list-ul me-2"></i>
                  Conversations
                </h5>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-funnel"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" data-filter="all">All Conversations</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="unread">Unread Only</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="recent">Recent (24h)</a></li>
                  </ul>
                </div>
              </div>
              <div class="mt-3">
                <div class="input-group input-group-sm">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="bi bi-search text-muted"></i>
                  </span>
                  <input type="text" class="form-control border-start-0" id="conversationSearch" placeholder="Search conversations...">
                </div>
              </div>
                </div>
                <div class="card-body p-0">
              <div id="conversationsList" class="conversations-container">
                    <!-- Conversations will be loaded here -->
                <div class="conversations-loading">
                  <i class="bi bi-chat-dots" style="font-size: 2rem;"></i>
                  <p class="mt-2">Loading conversations...</p>
                  </div>
                </div>
              </div>
            </div>
                </div>

        <!-- Chat Area -->
        <div class="col-lg-8 col-xl-9">
          <div class="card shadow-sm h-100">
            <!-- Chat Header -->
            <div class="card-header bg-white border-bottom" id="chatHeader">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                  <div class="conversation-avatar me-3">
                    <img src="../../img/default-avatar.svg" alt="User" class="rounded-circle" width="48" height="48">
                  </div>
                  <div>
                    <h5 class="mb-1" id="conversationTitle">Select a conversation</h5>
                    <small class="text-muted" id="conversationSubtitle">Choose from the list to start messaging</small>
                  </div>
                </div>
                <div class="chat-actions">
                  <button class="btn btn-sm btn-outline-secondary" id="chatInfoBtn" title="Conversation Info" disabled>
                    <i class="bi bi-info-circle"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" id="chatArchiveBtn" title="Archive" disabled>
                    <i class="bi bi-archive"></i>
                  </button>
                </div>
              </div>
              <div id="typingIndicator" class="typing-indicator mt-2" style="display: none;">
                <small class="text-primary">
                  <i class="bi bi-three-dots"></i> Someone is typing...
                </small>
              </div>
            </div>

            <!-- Chat Messages -->
                <div class="card-body p-0">
              <div id="chatMessages" class="chat-messages-container">
                    <div class="text-center text-muted py-5">
                      <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
                  <h5 class="mt-3">Welcome to Messages</h5>
                  <p class="text-muted">Select a conversation from the sidebar to view and send messages</p>
                    </div>
                  </div>
            </div>

            <!-- Chat Input -->
            <div class="card-footer bg-white border-top">
              <form id="chatInputForm" class="chat-input-form">
                <div class="input-group">
                  <button type="button" class="btn btn-outline-secondary" id="attachBtn" disabled>
                    <i class="bi bi-paperclip"></i>
                  </button>
                  <input type="text" id="chatInput" class="form-control border-start-0 border-end-0" 
                         placeholder="Type your message..." disabled>
                  <button type="button" class="btn btn-outline-secondary" id="emojiBtn" disabled>
                    <i class="bi bi-emoji-smile"></i>
                  </button>
                      <button type="submit" class="btn btn-primary" disabled>
                        <i class="bi bi-send"></i>
                      </button>
                </div>
                    </form>
              <!-- Hidden file input for attachments -->
              <input type="file" id="fileInput" style="display: none;" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                </div>
              </div>
            </div>
          </div>
        </div>
        
    <!-- Quick Actions Section -->
    <div class="container-fluid pb-4">
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <i class="bi bi-lightning me-2"></i>
                Quick Actions
              </h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <div class="quick-action-card text-center p-3 border rounded">
                    <i class="bi bi-broadcast text-primary mb-2" style="font-size: 1.5rem;"></i>
                    <h6>Broadcast Message</h6>
                    <p class="small text-muted">Send message to all users</p>
                    <button class="btn btn-sm btn-outline-primary">Send Broadcast</button>
            </div>
          </div>
                <div class="col-md-3">
                  <div class="quick-action-card text-center p-3 border rounded">
                    <i class="bi bi-gear text-success mb-2" style="font-size: 1.5rem;"></i>
                    <h6>Auto-Reply</h6>
                    <p class="small text-muted">Configure automatic responses</p>
                    <button class="btn btn-sm btn-outline-success">Configure</button>
        </div>
            </div>
                <div class="col-md-3">
                  <div class="quick-action-card text-center p-3 border rounded">
                    <i class="bi bi-graph-up text-info mb-2" style="font-size: 1.5rem;"></i>
                    <h6>Analytics</h6>
                    <p class="small text-muted">View messaging statistics</p>
                    <button class="btn btn-sm btn-outline-info">View Stats</button>
            </div>
          </div>
                <div class="col-md-3">
                  <div class="quick-action-card text-center p-3 border rounded">
                    <i class="bi bi-download text-warning mb-2" style="font-size: 1.5rem;"></i>
                    <h6>Export</h6>
                    <p class="small text-muted">Export conversation history</p>
                    <button class="btn btn-sm btn-outline-warning">Export</button>
        </div>
            </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 mb-4">
          <h4>About Starlet Properties</h4>
          <p>Uganda's premier real estate and vehicle marketplace, connecting buyers and sellers across the country.</p>
          <div class="social-links">
            <a href="#"><i class="fab fa-facebook"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-linkedin"></i></a>
          </div>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Properties</h4>
          <ul>
            <li><a href="/properties.html?type=house_sale">Houses for Sale</a></li>
            <li><a href="/properties.html?type=house_rent">Houses for Rent</a></li>
            <li><a href="/properties.html?type=land_sale">Land for Sale</a></li>
            <li><a href="/properties.html?type=land_rent">Land for Rent</a></li>
            <li><a href="/properties.html?type=commercial">Commercial Property</a></li>
            <li><a href="/properties.html?type=vacation_short_stay">Vacation & Short Stay</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Vehicles</h4>
          <ul>
            <li><a href="/pages/vehicles/index.html?type=cars">Cars</a></li>
            <li><a href="/pages/vehicles/index.html?type=motorcycles">Motorcycles</a></li>
            <li><a href="/pages/vehicles/index.html?type=trucks">Trucks</a></li>
            <li><a href="/pages/vehicles/index.html?type=buses">Buses</a></li>
            <li><a href="/pages/vehicles/index.html?type=heavy_machinery">Heavy Machinery</a></li>
            <li><a href="/pages/vehicles/index.html?type=bicycles_ebikes">Bicycles & E-bikes</a></li>
            <li><a href="/pages/vehicles/index.html?type=boats_watercraft">Boats & Watercraft</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Company</h4>
          <ul>
            <li><a href="/about.html">About Us</a></li>
            <li><a href="/contact.html">Contact</a></li>
            <li><a href="/resources.html">Resources</a></li>
            <li><a href="/stores.html">Our Stores</a></li>
            <li><a href="/privacy.html">Privacy Policy</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Contact</h4>
          <ul>
            <li><a href="tel:+256123456789"><i class="bi bi-telephone"></i> +256 123 456 789</a></li>
            <li><a href="mailto:info@starlet.co.ug"><i class="bi bi-envelope"></i> info@starlet.co.ug</a></li>
            <li><a href="#"><i class="bi bi-geo-alt"></i> Kampala, Uganda</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="row">
          <div class="col-md-6">
            <p class="mb-0">&copy; 2024 Starlet Properties. All rights reserved.</p>
          </div>
          <div class="col-md-6 text-md-end">
            <a href="/terms.html" class="me-3">Terms of Service</a>
            <a href="/privacy.html">Privacy Policy</a>
          </div>
        </div>
      </div>
    </div>
  </footer>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
  <script src="../../assets/js/firebase-config.js"></script>
      <script src="../../js/admin.js"></script>
    <!-- Admin Authentication Enhancement -->
    <script src="../../js/admin-auth-enhancement.js"></script>
  <script src="../../js/main.js"></script>
  <script>
    // Enforce authentication on this page
    enforceAuth('../../auth/login.html');
    // Setup My Listings link logic
    document.addEventListener('DOMContentLoaded', function() {
        setupMyListingsLink('#myListingsLink', '../../auth/login.html', '../../stores/agent-stores/dashboard.html', '../../stores/agent-stores/create.html');
        // Setup sidebar toggle functionality
        setupSidebarToggle();
      });
      
      
      // Setup sidebar toggle functionality
      function setupSidebarToggle() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
        const sidebar = document.getElementById('adminSidebar');
        const adminPanel = document.querySelector('.admin-panel');
        const toggleIcon = document.getElementById('sidebarToggleIcon');
        
        // Get saved sidebar state
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        
        // Initialize sidebar state
        if (sidebarCollapsed) {
          sidebar.classList.add('collapsed');
          adminPanel.classList.add('sidebar-collapsed');
          sidebarToggle.classList.add('active');
        }
        
        // Toggle sidebar
        sidebarToggle.addEventListener('click', () => {
          const isCollapsed = sidebar.classList.contains('collapsed');
          
          if (isCollapsed) {
            // Show sidebar
            sidebar.classList.remove('collapsed');
            adminPanel.classList.remove('sidebar-collapsed');
            sidebarToggle.classList.remove('active');
            localStorage.setItem('sidebarCollapsed', 'false');
          } else {
            // Hide sidebar
            sidebar.classList.add('collapsed');
            adminPanel.classList.add('sidebar-collapsed');
            sidebarToggle.classList.add('active');
            localStorage.setItem('sidebarCollapsed', 'true');
          }
        });
        
        // Close sidebar on mobile
        sidebarCloseBtn.addEventListener('click', () => {
          sidebar.classList.remove('show');
        });
        
        // Handle mobile sidebar behavior
        function handleMobileSidebar() {
          if (window.innerWidth <= 768) {
            sidebar.classList.remove('collapsed');
            sidebar.classList.add('show');
          } else {
            sidebar.classList.remove('show');
            // Restore desktop state
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (sidebarCollapsed) {
              sidebar.classList.add('collapsed');
              adminPanel.classList.add('sidebar-collapsed');
              sidebarToggle.classList.add('active');
            } else {
              sidebar.classList.remove('collapsed');
              adminPanel.classList.remove('sidebar-collapsed');
              sidebarToggle.classList.remove('active');
            }
          }
        }
        
        // Handle window resize
        window.addEventListener('resize', handleMobileSidebar);
        
        // Initial mobile check
        handleMobileSidebar();
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
          if (window.innerWidth <= 768) {
            if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
              sidebar.classList.remove('show');
            }
          }
        });
      }
    // Initialize Firebase services
    // Use window.firebaseDB, window.firebaseAuth, window.firebaseMessaging from firebase-config.js
    // Use window.currentUser as set by main.js
    let selectedConversation = null;
    let conversations = [];
    let unsubscribeMessages = null;
    let typingTimeout;
    let totalUnreadCount = 0;
    let unreadMessagesListener = null;

    // Note: Tracking prevention warnings are normal browser privacy features
    // and don't affect functionality. They block some analytics/tracking requests.

    // Initialize Firebase after config is loaded
    function initializeFirebase() {
      try {
        // Check if Firebase is available
        if (typeof firebase === 'undefined') {
          console.error('Firebase is not loaded - check if firebase-config.js is included');
          return false;
        }

        // Check if Firebase is already initialized
        if (!firebase.apps.length) {
          console.error('Firebase not initialized - check firebase-config.js');
          return false;
        }

        // Use shared Firebase services
        window.firebaseDB = firebase.firestore();
        window.firebaseAuth = firebase.auth();
        
        console.log('Firebase initialized successfully');
        return true;
      } catch (error) {
        console.error('Error initializing Firebase:', error);
        return false;
      }
    }

    // Wait for Firebase to be ready
    function waitForFirebase() {
      if (typeof firebase !== 'undefined' && firebase.auth) {
        initializeFirebase();
        setupAuthListener();
      } else {
        console.log('Waiting for Firebase to load...');
        setTimeout(waitForFirebase, 100);
      }
    }

    // Setup authentication listener
    function setupAuthListener() {
      if (!window.firebaseAuth) {
        console.error('Auth not initialized');
        return;
      }

      window.firebaseAuth.onAuthStateChanged(async user => {
        if (!user) {
          console.log('No user logged in, redirecting to login');
          window.location.href = '../auth/login.html';
          return;
        }
        
        window.currentUser = {
          id: user.uid,
          name: user.displayName || user.email || 'User',
          avatar: user.photoURL || 'https://randomuser.me/api/portraits/lego/2.jpg',
          email: user.email
        };
        
        console.log('Admin authenticated:', window.currentUser.email);
        
        // Initialize messaging with better error handling
        try {
          window.firebaseMessaging = firebase.messaging();
          
          // Check if notifications are already granted
          if (Notification.permission === 'granted') {
            const token = await window.firebaseMessaging.getToken({ vapidKey: 'YOUR_PUBLIC_VAPID_KEY' });
            await window.firebaseDB.collection('users').doc(window.currentUser.id).update({ fcmToken: token });
            console.log('FCM token obtained successfully');
          } else if (Notification.permission === 'default') {
            // Don't request permission automatically - wait for user interaction
            console.log('Notification permission not granted, will request on user interaction');
          } else {
            console.log('Notification permission blocked by browser or user');
          }
        } catch (err) { 
          console.warn('FCM initialization error (this is normal if notifications are blocked):', err.message); 
        }
        
        // Load conversations for admin
        await loadAdminConversations();
        
        // Start listening for unread messages
        startUnreadMessagesListener();
      });
    }

    // Cache for user names to avoid repeated Firestore queries
    const userNamesCache = new Map();
    
    // Function to extract user IDs from conversation IDs
    function extractUserIdsFromConversationId(convId) {
      const userIds = [];
      
      // Pattern 1: listing_listingId_userId_agentId
      if (convId.startsWith('listing_')) {
        const parts = convId.split('_');
        if (parts.length >= 3) {
          userIds.push(parts[2]); // userId
          if (parts.length >= 4) {
            userIds.push(parts[3]); // agentId
          }
        }
      }
      // Pattern 2: support_userId
      else if (convId.startsWith('support_')) {
        const parts = convId.split('_');
        if (parts.length >= 2) {
          userIds.push(parts[1]); // userId
        }
      }
      // Pattern 3: direct conversation ID (might be user ID)
      else {
        userIds.push(convId);
      }
      
      return userIds;
    }
    
    // Cache for user avatars to avoid repeated Firestore queries
    const userAvatarsCache = new Map();
    
    // Function to fetch user name from users collection
    async function fetchUserName(userId) {
      // Check cache first
      if (userNamesCache.has(userId)) {
        return userNamesCache.get(userId);
      }
      
      try {
        const userDoc = await window.firebaseDB.collection('users').doc(userId).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          const userName = userData.displayName || userData.name || userData.email || 'User';
          // Cache the result
          userNamesCache.set(userId, userName);
          console.log(`‚úÖ Fetched user name for ${userId}:`, userName);
          return userName;
        } else {
          console.log(`‚ö†Ô∏è User document not found for ID: ${userId}`);
          return null;
        }
      } catch (error) {
        console.error(`‚ùå Error fetching user name for ${userId}:`, error);
        return null;
      }
    }
    
    // Function to fetch user avatar from users collection
    async function fetchUserAvatar(userId) {
      // Check cache first
      if (userAvatarsCache.has(userId)) {
        return userAvatarsCache.get(userId);
      }
      
      try {
        const userDoc = await window.firebaseDB.collection('users').doc(userId).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          const userAvatar = userData.avatar || userData.profileImage || userData.photoURL || null;
          // Cache the result
          userAvatarsCache.set(userId, userAvatar);
          console.log(`‚úÖ Fetched user avatar for ${userId}:`, userAvatar);
          return userAvatar;
        } else {
          console.log(`‚ö†Ô∏è User document not found for ID: ${userId}`);
          return null;
        }
      } catch (error) {
        console.error(`‚ùå Error fetching user avatar for ${userId}:`, error);
        return null;
      }
    }
    
    // Function to fetch missing avatars for conversations
    async function fetchMissingAvatars() {
      for (const conversation of conversations) {
        if (!conversation.agentAvatar && conversation.userIds && conversation.userIds.length > 0) {
          console.log(`üñºÔ∏è Fetching avatar for conversation: ${conversation.id}`);
          for (const userId of conversation.userIds) {
            const avatar = await fetchUserAvatar(userId);
            if (avatar) {
              conversation.agentAvatar = avatar;
              console.log(`‚úÖ Updated avatar for conversation ${conversation.id}:`, avatar);
              break; // Use the first avatar found
            }
          }
        }
      }
      
      // Update UI with new avatars
      updateConversationsUI();
    }

    // Load conversations for admin view
    async function loadAdminConversations() {
      console.log('=== LOAD ADMIN CONVERSATIONS START ===');
      console.log('Current user:', window.currentUser);
      console.log('Firebase DB available:', !!window.firebaseDB);
      
      if (!window.currentUser || !window.firebaseDB) {
        console.error('‚ùå User or Firebase DB not available');
        console.log('Current user:', window.currentUser);
        console.log('Firebase DB:', window.firebaseDB);
        
        // Show error in conversations list
        const conversationsList = document.getElementById('conversationsList');
        if (conversationsList) {
          conversationsList.innerHTML = `
            <div class="conversations-empty">
              <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
              <p class="mt-2">Firebase not initialized</p>
              <small>Please refresh the page to try again</small>
            </div>`;
        }
        return;
      }
      
      try {
        console.log('üîÑ Loading conversations for admin...');
        
        console.log('üì° Executing Firestore query...');
        const convSnap = await window.firebaseDB.collection('conversations')
          .orderBy('lastMessageAt', 'desc')
          .limit(50).get();
        
        console.log('üìä Raw Firestore response:', convSnap);
        console.log('üìä Number of conversations found:', convSnap.size);
        
        conversations = [];
        
        // Process conversations sequentially to fetch user names
        for (const doc of convSnap.docs) {
          console.log('üîç Processing conversation document:', doc.id);
          console.log('üîç Raw conversation data:', doc.data());
          const convData = doc.data();
          
          // Enhanced data processing with better field mapping
          console.log('üîß Processing conversation data...');
          console.log('üîß Available fields:', Object.keys(convData));
          
          // Log field detection attempts
          console.log('üîç User name detection:');
          console.log('  - agentName:', convData.agentName);
          console.log('  - listerName:', convData.listerName);
          console.log('  - userName:', convData.userName);
          console.log('  - senderName:', convData.senderName);
          console.log('  - agent.name:', convData.agent?.name);
          console.log('  - lister.name:', convData.lister?.name);
          console.log('  - user.name:', convData.user?.name);
          console.log('  - sender.name:', convData.sender?.name);
          console.log('  - participantName:', convData.participantName);
          console.log('  - customerName:', convData.customerName);
          console.log('  - clientName:', convData.clientName);
          
          console.log('üîç Listing title detection:');
          console.log('  - listingTitle:', convData.listingTitle);
          console.log('  - title:', convData.title);
          console.log('  - listingName:', convData.listingName);
          console.log('  - propertyTitle:', convData.propertyTitle);
          console.log('  - listing.title:', convData.listing?.title);
          
          console.log('üîç Last message detection:');
          console.log('  - lastMessage:', convData.lastMessage);
          console.log('  - lastMessageText:', convData.lastMessageText);
          console.log('  - lastMessageContent:', convData.lastMessageContent);
          
          console.log('üîç Avatar detection:');
          console.log('  - agentAvatar:', convData.agentAvatar);
          console.log('  - listerAvatar:', convData.listerAvatar);
          console.log('  - agent.avatar:', convData.agent?.avatar);
          console.log('  - lister.avatar:', convData.lister?.avatar);
          console.log('  - user.avatar:', convData.user?.avatar);
          console.log('  - sender.avatar:', convData.sender?.avatar);
          console.log('  - participantAvatar:', convData.participantAvatar);
          
          // Enhanced user name detection with more field variations
          let userName = convData.agentName || convData.listerName || convData.userName || convData.senderName || 
                        convData.participantName || convData.customerName || convData.clientName ||
                        (convData.agent && convData.agent.name) || 
                        (convData.lister && convData.lister.name) ||
                        (convData.user && convData.user.name) ||
                        (convData.sender && convData.sender.name);
          
          // If still no name, try to extract from conversation ID and fetch from users collection
          if (!userName || userName === 'Unknown User') {
            const convId = doc.id;
            console.log('üîç Attempting to extract user IDs from conversation ID:', convId);
            
            // Extract all possible user IDs from conversation ID
            const userIds = extractUserIdsFromConversationId(convId);
            console.log('üîç Extracted user IDs:', userIds);
            
            // Try to fetch user name from each user ID
            for (const userId of userIds) {
              console.log('üîç Attempting to fetch user name for ID:', userId);
              const fetchedUserName = await fetchUserName(userId);
              if (fetchedUserName) {
                userName = fetchedUserName;
                console.log('‚úÖ Found user name:', userName);
                break; // Use the first valid user name found
              }
            }
            
            // If still no name, use fallback based on conversation type
            if (!userName || userName === 'Unknown User') {
              if (convId.startsWith('listing_')) {
                userName = 'Property Inquirer';
              } else if (convId.startsWith('support_')) {
                userName = 'Support User';
              } else {
                userName = 'Chat User';
              }
              console.log('‚ö†Ô∏è Using fallback name:', userName);
            }
          }
          
          // Enhanced listing title detection
          let listingTitle = convData.listingTitle || convData.title || convData.listingName || 
                           convData.propertyTitle || (convData.listing && convData.listing.title);
          
          // If still no title, try to extract from conversation ID
          if (!listingTitle || listingTitle === 'Untitled Listing') {
            const convId = doc.id;
            if (convId.startsWith('listing_')) {
              const parts = convId.split('_');
              if (parts.length > 1) {
                listingTitle = parts[1] || 'Property Inquiry';
              }
            } else if (convId.startsWith('support_')) {
              listingTitle = 'Support Chat';
            }
          }
          
          const conversation = {
            id: doc.id,
            ...convData,
            // Enhanced user name detection
            agentName: userName || 'Unknown User',
            // Enhanced listing title detection
            listingTitle: listingTitle || 'Untitled Listing',
            // Enhanced last message detection
            lastMessage: convData.lastMessage || convData.lastMessageText || convData.lastMessageContent || 'No messages yet',
            unreadCount: convData.unreadCount || 0,
                      // Enhanced avatar detection
          agentAvatar: convData.agentAvatar || convData.listerAvatar || convData.participantAvatar ||
                      (convData.agent && convData.agent.avatar) || 
                      (convData.lister && convData.lister.avatar) ||
                      (convData.user && convData.user.avatar) ||
                      (convData.sender && convData.sender.avatar) || null,
          // Store user IDs for later avatar fetching
          userIds: extractUserIdsFromConversationId(doc.id)
          };
          
          console.log('‚úÖ Processed conversation:', conversation);
          conversations.push(conversation);
        }
        
        console.log(`‚úÖ Loaded ${conversations.length} conversations for admin:`, conversations);
        console.log('=== LOAD ADMIN CONVERSATIONS END ===');
        
        // Update UI with conversations
        console.log('üé® Updating UI with conversations...');
        updateConversationsUI();
        
        // Fetch avatars for conversations that don't have them
        console.log('üñºÔ∏è Fetching missing avatars...');
        await fetchMissingAvatars();
        
        // If no conversations, show a helpful message
        if (conversations.length === 0) {
          const conversationsList = document.getElementById('conversationsList');
          if (conversationsList) {
            conversationsList.innerHTML = `
              <div class="conversations-empty">
                <i class="bi bi-chat-dots" style="font-size: 2rem;"></i>
                <p class="mt-2">No conversations found</p>
                <small>Conversations will appear here when users start messaging</small>
                <div class="mt-3">
                  <button class="btn btn-outline-primary btn-sm" onclick="createTestConversation()">
                    <i class="bi bi-plus-circle"></i> Create Test Conversation
                  </button>
                </div>
              </div>`;
          }
        }
        
      } catch (err) {
        console.error('Error loading conversations:', err);
        const conversationsList = document.getElementById('conversationsList');
        if (conversationsList) {
          conversationsList.innerHTML = `
            <div class="conversations-empty">
              <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
              <p class="mt-2">Error loading conversations</p>
              <small>Please refresh the page to try again</small>
            </div>`;
        }
      }
    }

    // Update conversations UI
    function updateConversationsUI() {
      console.log('=== UPDATE CONVERSATIONS UI START ===');
      console.log('üìä Conversations to render:', conversations.length);
      
      const conversationsList = document.getElementById('conversationsList');
      if (!conversationsList) {
        console.error('‚ùå Conversations list container not found');
        return;
      }
      
      if (conversations.length === 0) {
        conversationsList.innerHTML = `
          <div class="text-center text-muted py-5">
            <i class="bi bi-chat-dots" style="font-size: 2rem;"></i>
            <p class="mt-2">No conversations found</p>
            <small>New conversations will appear here</small>
          </div>`;
        return;
      }
      
      console.log('üé® Rendering conversations...');
      conversationsList.innerHTML = conversations.map((conv, idx) => {
        console.log(`üé® Rendering conversation ${idx + 1}/${conversations.length}:`, conv.id);
        
        const unreadCount = conv.unreadCount || 0;
        console.log(`  üìä Unread count: ${unreadCount}`);
        
        // Enhanced date handling for lastMessageAt
        console.log(`  üìÖ Processing lastMessageAt:`, conv.lastMessageAt);
        let lastMessageTime = '';
        if (conv.lastMessageAt) {
          let messageTime;
          try {
            console.log(`    üìÖ Date format detection for conversation ${conv.id}:`);
            console.log(`    üìÖ Type: ${typeof conv.lastMessageAt}`);
            console.log(`    üìÖ Value:`, conv.lastMessageAt);
            
            // Handle Firestore Timestamp objects
            if (conv.lastMessageAt.seconds && typeof conv.lastMessageAt.seconds === 'number') {
              console.log(`    ‚úÖ Using seconds property: ${conv.lastMessageAt.seconds}`);
              messageTime = new Date(conv.lastMessageAt.seconds * 1000);
            } else if (conv.lastMessageAt.toDate && typeof conv.lastMessageAt.toDate === 'function') {
              console.log(`    ‚úÖ Using toDate() method`);
              messageTime = conv.lastMessageAt.toDate();
            } else if (conv.lastMessageAt._seconds && typeof conv.lastMessageAt._seconds === 'number') {
              console.log(`    ‚úÖ Using _seconds property: ${conv.lastMessageAt._seconds}`);
              messageTime = new Date(conv.lastMessageAt._seconds * 1000);
            } else if (conv.lastMessageAt._methodName === 'FieldValue.serverTimestamp') {
              console.log(`    ‚ö†Ô∏è Server timestamp detected, using current time`);
              messageTime = new Date();
            } else if (typeof conv.lastMessageAt === 'string') {
              console.log(`    ‚úÖ Using string date: ${conv.lastMessageAt}`);
              messageTime = new Date(conv.lastMessageAt);
            } else if (typeof conv.lastMessageAt === 'number') {
              console.log(`    ‚úÖ Using number timestamp: ${conv.lastMessageAt}`);
              messageTime = new Date(conv.lastMessageAt);
            } else if (conv.lastMessageAt instanceof Date) {
              console.log(`    ‚úÖ Using Date object`);
              messageTime = conv.lastMessageAt;
            } else {
              console.warn(`    ‚ö†Ô∏è Unknown date format for lastMessageAt:`, conv.lastMessageAt);
              messageTime = new Date();
            }
            
            console.log(`    üìÖ Parsed messageTime:`, messageTime);
            
            // Validate the date
            if (isNaN(messageTime.getTime())) {
              console.warn(`    ‚ùå Invalid date for conversation: ${conv.id}`, conv.lastMessageAt);
              lastMessageTime = 'Recently';
            } else {
              const now = new Date();
              const diffInHours = (now - messageTime) / (1000 * 60 * 60);
              console.log(`    üìÖ Time difference: ${diffInHours.toFixed(2)} hours`);
              
              if (diffInHours < 1) {
                lastMessageTime = 'Just now';
                console.log(`    ‚úÖ Display: "Just now"`);
              } else if (diffInHours < 24) {
                lastMessageTime = messageTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                console.log(`    ‚úÖ Display: "${lastMessageTime}"`);
              } else if (diffInHours < 48) {
                lastMessageTime = 'Yesterday';
                console.log(`    ‚úÖ Display: "Yesterday"`);
              } else {
                lastMessageTime = messageTime.toLocaleDateString([], {month: 'short', day: 'numeric'});
                console.log(`    ‚úÖ Display: "${lastMessageTime}"`);
              }
            }
          } catch (error) {
            console.error(`    ‚ùå Error processing date for conversation: ${conv.id}`, error);
            lastMessageTime = 'Recently';
          }
        } else {
          console.log(`    üìÖ No lastMessageAt found, using "Recently"`);
          lastMessageTime = 'Recently';
        }
        
        console.log(`    üë§ User name: "${conv.agentName}"`);
        console.log(`    üè† Listing title: "${conv.listingTitle}"`);
        console.log(`    üí¨ Last message: "${conv.lastMessage}"`);
        console.log(`    üïê Last message time: "${lastMessageTime}"`);
        const isActive = selectedConversation && selectedConversation.id === conv.id;
        const isUnread = unreadCount > 0;
        
        return `
          <div class="conversation-item ${isActive ? 'active' : ''} ${isUnread ? 'unread' : ''}" 
               data-conversation-id="${conv.id}">
            <div class="conversation-content">
              <div class="conversation-avatar">
                <img src="${conv.agentAvatar || '../../img/default-avatar.svg'}" 
                     alt="User" onerror="this.src='../../img/default-avatar.svg'">
              </div>
              <div class="conversation-details">
                <div class="conversation-header">
                  <h6 class="conversation-title">${conv.listingTitle || 'Listing'}</h6>
                  <small class="conversation-time">${lastMessageTime}</small>
                </div>
                <p class="conversation-subtitle">${conv.agentName || 'User'}</p>
                <p class="conversation-message">
                  ${conv.lastMessage ? conv.lastMessage.slice(0, 50) : 'No messages yet'}
                </p>
              </div>
              ${unreadCount > 0 ? `<span class="conversation-badge badge bg-danger rounded-pill">${unreadCount}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      console.log('üîó Adding click handlers to conversation items...');
      // Add click handlers
      conversationsList.querySelectorAll('[data-conversation-id]').forEach(el => {
        el.addEventListener('click', async () => {
          const convId = el.dataset.conversationId;
          console.log('üñ±Ô∏è Conversation clicked:', convId);
          
          // Remove active class from all conversations
          conversationsList.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
          });
          
          // Add active class to clicked conversation
          el.classList.add('active');
          
          const conv = conversations.find(c => c.id === convId);
          if (conv) {
            console.log('‚úÖ Found conversation:', conv);
            await selectConversation(conv);
          } else {
            console.error('‚ùå Conversation not found:', convId);
            console.log('Available conversations:', conversations.map(c => c.id));
            showToast('Conversation not found. Please refresh the page.', 'error');
          }
        });
      });

      // Update stats
      console.log('üìä Updating conversation stats...');
      const totalConversationsElement = document.getElementById('totalConversations');
      const unreadCountElement = document.getElementById('unreadCount');
      
      if (totalConversationsElement) {
        totalConversationsElement.textContent = conversations.length;
        console.log(`üìä Total conversations: ${conversations.length}`);
      } else {
        console.error('‚ùå Total conversations element not found');
      }
      
      const totalUnread = conversations.reduce((sum, conv) => sum + (conv.unreadCount || 0), 0);
      if (unreadCountElement) {
        unreadCountElement.textContent = totalUnread;
        console.log(`üìä Total unread: ${totalUnread}`);
      } else {
        console.error('‚ùå Unread count element not found');
      }
      
      console.log('=== UPDATE CONVERSATIONS UI END ===');
    }

    // Start listening for unread messages
    function startUnreadMessagesListener() {
      if (!window.firebaseDB || !window.currentUser) return;
      
      // Listen to all conversations for unread count changes
      unreadMessagesListener = window.firebaseDB.collection('conversations')
        .onSnapshot(snap => {
          let totalUnread = 0;
          snap.forEach(doc => {
            const data = doc.data();
            if (data.unreadCount && data.unreadCount > 0) {
              totalUnread += data.unreadCount;
            }
          });
          
          updateUnreadBadge(totalUnread);
        });
    }

    // Update the unread messages badge
    function updateUnreadBadge(count) {
      const badge = document.getElementById('unreadMessagesBadge');
      if (!badge) return;
      
      totalUnreadCount = count;
      
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count.toString();
        badge.classList.remove('d-none');
      } else {
        badge.classList.add('d-none');
      }
    }

    // Clear unread badge when messages page is opened
    function clearUnreadBadge() {
      updateUnreadBadge(0);
    }

    async function selectConversation(conv) {
      console.log('=== SELECT CONVERSATION START ===');
      console.log('üéØ Selecting conversation:', conv?.id);
      console.log('üéØ Conversation data:', conv);
      console.log('üéØ Current user:', window.currentUser);
      
      if (!conv || !window.currentUser) {
        console.error('‚ùå Cannot select conversation - missing data');
        console.log('Conversation:', conv);
        console.log('Current user:', window.currentUser);
        return;
      }
      
      // Clear any existing message listener
      if (unsubscribeMessages) {
        unsubscribeMessages();
        unsubscribeMessages = null;
      }
      
      selectedConversation = conv;
      
      console.log('üîß Enabling chat input elements...');
      // Enable chat input
      const chatInput = document.getElementById('chatInput');
      const sendButton = document.querySelector('#chatInputForm button[type="submit"]');
      const attachBtn = document.getElementById('attachBtn');
      const emojiBtn = document.getElementById('emojiBtn');
      
      console.log('üîß Chat input elements found:');
      console.log('  - chatInput:', !!chatInput);
      console.log('  - sendButton:', !!sendButton);
      console.log('  - attachBtn:', !!attachBtn);
      console.log('  - emojiBtn:', !!emojiBtn);
      
      if (chatInput) {
        chatInput.disabled = false;
        console.log('‚úÖ Chat input enabled');
      }
      if (sendButton) {
        sendButton.disabled = false;
        console.log('‚úÖ Send button enabled');
      }
      if (attachBtn) {
        attachBtn.disabled = false;
        console.log('‚úÖ Attach button enabled');
      }
      if (emojiBtn) {
        emojiBtn.disabled = false;
        console.log('‚úÖ Emoji button enabled');
      }
      
      // Update UI
      console.log('üé® Updating UI...');
      renderChatHeader();
      updateConversationsUI(); // to update active state
      
      // Load messages for this conversation
      console.log('üì® Loading messages for conversation...');
      await loadMessages();
      
      // Mark all unread messages as read
      console.log('üìñ Marking messages as read...');
      try {
        const msgsSnap = await window.firebaseDB.collection('conversations').doc(conv.id)
          .collection('messages')
          .where('read', '==', false)
          .where('senderId', '!=', window.currentUser.id)
          .get();
        
        console.log(`üìñ Found ${msgsSnap.size} unread messages to mark as read`);
        
        if (!msgsSnap.empty) {
          const batch = window.firebaseDB.batch();
          msgsSnap.forEach(doc => batch.update(doc.ref, { read: true }));
          await batch.commit();
          console.log('‚úÖ Messages marked as read');
          
          // Update conversation unread count
          await window.firebaseDB.collection('conversations').doc(conv.id).update({
            unreadCount: 0
          });
          console.log('‚úÖ Conversation unread count reset to 0');
          
          // Clear unread badge when conversation is opened
          clearUnreadBadge();
        } else {
          console.log('üìñ No unread messages to mark');
        }
      } catch (err) {
        console.error('‚ùå Error marking messages as read:', err);
      }
      
      console.log('=== SELECT CONVERSATION END ===');
    }

    function renderMessages(messages) {
      console.log('=== RENDER MESSAGES START ===');
      console.log(`üì® Rendering ${messages.length} messages`);
      
      const chat = document.getElementById('chatMessages');
      if (!chat) {
        console.error('‚ùå Chat messages container not found');
        return;
      }
      
      console.log('üì® Messages to render:', messages);
      
      if (!messages || messages.length === 0) {
        chat.innerHTML = `
          <div class="text-center text-muted py-5">
            <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
            <h5 class="mt-3">No messages yet</h5>
            <p class="text-muted">Start the conversation by sending a message!</p>
          </div>`;
        return;
      }
      
      console.log('üé® Rendering message HTML...');
      // Show all messages (no filtering needed for admin view)
      chat.innerHTML = messages.map((msg, index) => {
        console.log(`üì® Processing message ${index + 1}/${messages.length}:`, msg.id);
        
        // Enhanced date handling for message createdAt
        console.log(`  üìÖ Processing message createdAt:`, msg.createdAt);
        let messageTime;
        try {
          if (!msg.createdAt) {
            console.log(`    üìÖ No createdAt, using current time`);
            messageTime = new Date();
          } else if (msg.createdAt.seconds && typeof msg.createdAt.seconds === 'number') {
            console.log(`    üìÖ Using seconds property: ${msg.createdAt.seconds}`);
            messageTime = new Date(msg.createdAt.seconds * 1000);
          } else if (msg.createdAt.toDate && typeof msg.createdAt.toDate === 'function') {
            console.log(`    üìÖ Using toDate() method`);
            messageTime = msg.createdAt.toDate();
          } else if (msg.createdAt._seconds && typeof msg.createdAt._seconds === 'number') {
            console.log(`    üìÖ Using _seconds property: ${msg.createdAt._seconds}`);
            messageTime = new Date(msg.createdAt._seconds * 1000);
          } else if (typeof msg.createdAt === 'string') {
            console.log(`    üìÖ Using string date: ${msg.createdAt}`);
            messageTime = new Date(msg.createdAt);
          } else if (typeof msg.createdAt === 'number') {
            console.log(`    üìÖ Using number timestamp: ${msg.createdAt}`);
            messageTime = new Date(msg.createdAt);
          } else if (msg.createdAt instanceof Date) {
            console.log(`    üìÖ Using Date object`);
            messageTime = msg.createdAt;
          } else {
            console.warn(`    ‚ö†Ô∏è Unknown date format for message createdAt:`, msg.createdAt);
            messageTime = new Date();
          }
          
          console.log(`    üìÖ Parsed messageTime:`, messageTime);
          
          // Validate the date
          if (isNaN(messageTime.getTime())) {
            console.warn(`    ‚ùå Invalid date for message: ${msg.id}`, msg.createdAt);
            messageTime = new Date();
          } else {
            console.log(`    ‚úÖ Valid date: ${messageTime.toISOString()}`);
          }
        } catch (error) {
          console.error(`    ‚ùå Error processing message date:`, error);
          messageTime = new Date();
        }
        
        const timeString = messageTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const isToday = new Date().toDateString() === messageTime.toDateString();
        const isSent = msg.senderId === window.currentUser.id;
        
        console.log(`    üïê Time string: "${timeString}"`);
        console.log(`    üìÖ Is today: ${isToday}`);
        console.log(`    üì§ Is sent by current user: ${isSent}`);
        console.log(`    üë§ Sender ID: ${msg.senderId}, Current user ID: ${window.currentUser.id}`);
        
        let statusIcon = '';
        if (isSent) {
          if (msg.read) {
            statusIcon = '<i class="bi bi-check2-all text-success"></i>';
            console.log(`    ‚úÖ Message read`);
          } else if (msg.delivered) {
            statusIcon = '<i class="bi bi-check2 text-primary"></i>';
            console.log(`    üì® Message delivered`);
          } else {
            statusIcon = '<i class="bi bi-clock text-muted"></i>';
            console.log(`    ‚è≥ Message pending`);
          }
        }
        
        const messageHtml = `
          <div class="d-flex ${isSent ? 'justify-content-end' : 'justify-content-start'} mb-3" data-message-id="${msg.id}">
            <div class="message-bubble ${isSent ? 'sent' : 'received'} position-relative">
              <div class="message-content">${msg.text || 'No message content'}</div>
              <div class="message-time">
                  ${isToday ? timeString : messageTime.toLocaleDateString() + ' ' + timeString}
                ${statusIcon ? `<span class="message-status">${statusIcon}</span>` : ''}
              </div>
              <!-- Message Actions Dropdown -->
              <div class="message-actions position-absolute top-0 end-0" style="display: none;">
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-three-dots-vertical"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="copyMessageText('${msg.id}')">
                      <i class="bi bi-clipboard me-2"></i>Copy Text
                    </a></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteMessage('${msg.id}')">
                      <i class="bi bi-trash me-2"></i>Delete Message
                    </a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        `;
        
        console.log(`    ‚úÖ Message ${index + 1} HTML generated`);
        return messageHtml;
      }).join('');
      
      console.log('‚úÖ All messages HTML generated');
      
      // Scroll to bottom
      setTimeout(() => {
        chat.scrollTop = chat.scrollHeight;
        console.log('üìú Scrolled to bottom of chat');
      }, 100);
      
      // Setup message hover effects for actions
      setupMessageHoverEffects();
      
      console.log('=== RENDER MESSAGES END ===');
    }

    function renderChatHeader() {
      const header = document.getElementById('chatHeader');
      if (!header) return;
      
      if (!selectedConversation) {
        header.innerHTML = `
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <div class="conversation-avatar me-3">
                <img src="../../img/default-avatar.svg" alt="User" class="rounded-circle" width="48" height="48">
              </div>
              <div>
                <h5 class="mb-1" id="conversationTitle">Select a conversation</h5>
                <small class="text-muted" id="conversationSubtitle">Choose from the list to start messaging</small>
              </div>
            </div>
            <div class="chat-actions">
              <button class="btn btn-sm btn-outline-secondary" id="chatInfoBtn" title="Conversation Info" disabled>
                <i class="bi bi-info-circle"></i>
              </button>
              <button class="btn btn-sm btn-outline-secondary" id="chatArchiveBtn" title="Archive" disabled>
                <i class="bi bi-archive"></i>
              </button>
            </div>
          </div>`;
        return;
      }
      
      header.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
            <div class="conversation-avatar me-3">
              <img src="${selectedConversation.agentAvatar || '../../img/default-avatar.svg'}" 
                   alt="User" class="rounded-circle" width="48" height="48"
                   onerror="this.src='../../img/default-avatar.svg'">
          </div>
            <div>
              <h5 class="mb-1" id="conversationTitle">${selectedConversation.listingTitle || 'Listing'}</h5>
              <small class="text-muted" id="conversationSubtitle">${selectedConversation.agentName || 'User'}</small>
            </div>
          </div>
          <div class="chat-actions">
            <button class="btn btn-sm btn-outline-secondary" id="chatInfoBtn" title="Conversation Info">
              <i class="bi bi-info-circle"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="chatArchiveBtn" title="Archive">
              <i class="bi bi-archive"></i>
            </button>
          </div>
        </div>
        <div id="typingIndicator" class="typing-indicator mt-2" style="display: none;">
          <small class="text-primary">
            <i class="bi bi-three-dots"></i> Someone is typing...
          </small>
        </div>
      `;
      
      // Listen for typing indicator
      if (selectedConversation.id) {
        window.firebaseDB.collection('conversations').doc(selectedConversation.id).onSnapshot(doc => {
          const data = doc.data();
          const otherId = selectedConversation.participants.find(id => id !== window.currentUser.id);
          const typingIndicator = document.getElementById('typingIndicator');
          if (typingIndicator) {
            if (data && data['typing_' + otherId]) {
              typingIndicator.style.display = 'block';
            } else {
              typingIndicator.style.display = 'none';
            }
          }
        });
      }
    }

    async function loadMessages() {
      console.log('=== LOAD MESSAGES START ===');
      
      if (!selectedConversation) {
        console.error('‚ùå No conversation selected');
        return;
      }
      
      console.log('üì® Loading messages for conversation:', selectedConversation.id);
      console.log('üì® Selected conversation data:', selectedConversation);
      
      // Show loading state
      const chat = document.getElementById('chatMessages');
      if (chat) {
        chat.innerHTML = `
          <div class="text-center text-muted py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading messages...</p>
          </div>`;
      }
      
      try {
        console.log('üì° Checking Firebase availability...');
        if (!window.firebaseDB) {
          throw new Error('Firebase database not initialized');
        }
        
        console.log('üì° Executing Firestore conversation check...');
        
        // Check if conversation exists first
        const conversationDoc = await window.firebaseDB.collection('conversations')
          .doc(selectedConversation.id)
          .get();
        
        console.log('üì° Conversation document exists:', conversationDoc.exists);
        if (conversationDoc.exists) {
          console.log('üì° Conversation data:', conversationDoc.data());
        }
        
        if (!conversationDoc.exists) {
          throw new Error(`Conversation '${selectedConversation.id}' not found in database`);
        }
        
        console.log('üì° Executing Firestore messages query...');
        
        // Try different approaches to get messages
        let messagesSnapshot;
        let messages = [];
        
        try {
          // First, try the standard subcollection approach
          messagesSnapshot = await window.firebaseDB.collection('conversations')
            .doc(selectedConversation.id)
            .collection('messages')
            .orderBy('createdAt', 'asc')
            .get();
          
          console.log(`üìä Found ${messagesSnapshot.size} messages in subcollection`);
          
          messagesSnapshot.forEach(doc => {
            const messageData = doc.data();
            console.log(`üì® Processing message ${doc.id}:`, messageData);
            messages.push({
              id: doc.id,
              ...messageData
            });
          });
          
        } catch (subcollectionError) {
          console.log('‚ö†Ô∏è Subcollection approach failed, trying alternative methods...');
          console.error('Subcollection error:', subcollectionError);
          
          // Try to get messages from the conversation document itself
          const convData = conversationDoc.data();
          if (convData.messages && Array.isArray(convData.messages)) {
            console.log('üì® Found messages array in conversation document');
            messages = convData.messages.map((msg, index) => ({
              id: `msg_${index}`,
              ...msg
            }));
          } else if (convData.messageHistory && Array.isArray(convData.messageHistory)) {
            console.log('üì® Found messageHistory array in conversation document');
            messages = convData.messageHistory.map((msg, index) => ({
              id: `msg_${index}`,
              ...msg
            }));
          } else {
            console.log('üì® No messages found in conversation document');
            console.log('üì® Available fields:', Object.keys(convData));
          }
        }
        
        console.log(`‚úÖ Loaded ${messages.length} messages`);
        console.log('üì® Messages data:', messages);
        
        if (messages.length === 0) {
          // Show empty state
          const chat = document.getElementById('chatMessages');
          if (chat) {
            chat.innerHTML = `
              <div class="text-center text-muted py-5">
                <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
                <h5 class="mt-3">No messages yet</h5>
                <p class="text-muted">This conversation has no messages yet.</p>
                <button class="btn btn-primary btn-sm mt-2" onclick="loadMessages()">
                  <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
              </div>`;
          }
        } else {
          renderMessages(messages);
          
          // Then set up real-time listener for new messages
          console.log('üîó Setting up real-time listener for new messages...');
          listenForMessages(selectedConversation.id);
        }
        
      } catch (error) {
        console.error('‚ùå Error loading messages:', error);
        
        // Show error message in chat area
        const chat = document.getElementById('chatMessages');
        if (chat) {
          chat.innerHTML = `
            <div class="text-center text-muted py-5">
              <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
              <h5 class="mt-3">Error Loading Messages</h5>
              <p class="text-muted">Failed to load messages: ${error.message}</p>
              <div class="mt-3">
                <button class="btn btn-primary btn-sm me-2" onclick="loadMessages()">
                  <i class="bi bi-arrow-clockwise"></i> Try Again
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="debugConversation()">
                  <i class="bi bi-bug"></i> Debug Info
                </button>
              </div>
            </div>`;
        }
        
        showToast('Failed to load messages. Please try again.', 'error');
      }
      
      console.log('=== LOAD MESSAGES END ===');
    }

    function listenForMessages(convId) {
      if (unsubscribeMessages) {
        unsubscribeMessages();
      }
      
      console.log('Setting up real-time listener for conversation:', convId);
      
      unsubscribeMessages = window.firebaseDB.collection('conversations').doc(convId)
        .collection('messages')
        .orderBy('createdAt', 'asc')
        .onSnapshot(snap => {
          const messages = [];
          snap.forEach(doc => {
            const messageData = doc.data();
            messages.push({
              id: doc.id,
              ...messageData
            });
          });
          
          console.log('Real-time update - messages count:', messages.length);
          renderMessages(messages);
        }, error => {
          console.error('Error in real-time listener:', error);
        });
    }

    // Message sending functionality
    function setupMessageSending() {
      const chatInputForm = document.getElementById('chatInputForm');
      if (chatInputForm) {
        chatInputForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const chatInput = document.getElementById('chatInput');
          const text = chatInput.value.trim();
          
          if (!text || !selectedConversation) return;
          
          // Clear input immediately for better UX
          chatInput.value = '';
          
          try {
            const msg = {
              text: text,
              senderId: window.currentUser.id,
              senderName: window.currentUser.name,
              senderAvatar: window.currentUser.avatar,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              read: false,
              delivered: false
            };
            
            // Add message to Firestore
            const messageRef = await window.firebaseDB.collection('conversations').doc(selectedConversation.id)
              .collection('messages').add(msg);
            
            // Update conversation metadata
            await window.firebaseDB.collection('conversations').doc(selectedConversation.id).update({
              lastMessage: text,
              lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
              unreadCount: firebase.firestore.FieldValue.increment(1)
            });
            
            // Mark as delivered after a short delay
            setTimeout(async () => {
              try {
                await messageRef.update({ delivered: true });
              } catch (err) {
                console.error('Error marking message as delivered:', err);
              }
            }, 1000);
            
            // Refresh conversations list
            updateConversationsUI();
            
          } catch (err) {
            console.error('Error sending message:', err);
            // Restore the message text if sending failed
            chatInput.value = text;
          }
        });
      }
    }

    // Typing indicator logic
    function setupTypingIndicator() {
      const chatInput = document.getElementById('chatInput');
      if (chatInput) {
        chatInput.addEventListener('input', function() {
          if (!selectedConversation || !window.currentUser) return;
          window.firebaseDB.collection('conversations').doc(selectedConversation.id).update({ ['typing_' + window.currentUser.id]: true });
          clearTimeout(typingTimeout);
          typingTimeout = setTimeout(() => {
            window.firebaseDB.collection('conversations').doc(selectedConversation.id).update({ ['typing_' + window.currentUser.id]: false });
          }, 2000);
        });
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Page loaded, initializing Firebase...');
      waitForFirebase();
      setupTypingIndicator();
      setupMessageSending();
      setupSearchAndFilter();
      setupBroadcastMessage();
      setupAutoReply();
      setupAnalytics();
      setupExport();
      setupEnhancedMessageFeatures();
      setupKeyboardShortcuts();
      
      // Clear unread badge when messages page is opened
      clearUnreadBadge();
      
      // Add click handler for messages icon
      const messagesIcon = document.getElementById('messagesIcon');
      if (messagesIcon) {
        messagesIcon.addEventListener('click', function(e) {
          e.preventDefault();
          // Scroll to messages section
          document.getElementById('inquiries-tab').click();
          // Clear unread badge
          clearUnreadBadge();
        });
      }
      
      // Request notification permission on first user interaction
      let notificationRequested = false;
      const requestNotificationOnInteraction = () => {
        if (!notificationRequested && Notification.permission === 'default') {
          notificationRequested = true;
          requestNotificationPermission();
          // Remove the event listeners after first interaction
          document.removeEventListener('click', requestNotificationOnInteraction);
          document.removeEventListener('keydown', requestNotificationOnInteraction);
        }
      };
      
      // Add listeners for user interaction
      document.addEventListener('click', requestNotificationOnInteraction);
      document.addEventListener('keydown', requestNotificationOnInteraction);
    });

    // Setup keyboard shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(e) {
        // Only handle shortcuts when not typing in input fields
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          return;
        }
        
        // Ctrl/Cmd + Delete: Delete selected message
        if ((e.ctrlKey || e.metaKey) && e.key === 'Delete') {
          e.preventDefault();
          const selectedMessage = document.querySelector('.message-bubble.selected');
          if (selectedMessage) {
            const messageId = selectedMessage.closest('[data-message-id]').dataset.messageId;
            deleteMessage(messageId);
          }
        }
        
        // Escape: Clear message selection
        if (e.key === 'Escape') {
          document.querySelectorAll('.message-bubble.selected').forEach(el => {
            el.classList.remove('selected');
          });
        }
      });
    }

    // Setup search and filter functionality
    function setupSearchAndFilter() {
      const searchInput = document.getElementById('conversationSearch');
      const filterDropdown = document.querySelector('[data-bs-toggle="dropdown"]');
      
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          filterConversations(searchTerm, 'search');
        });
      }

      // Filter dropdown items
      document.querySelectorAll('[data-filter]').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const filterType = this.getAttribute('data-filter');
          filterConversations('', filterType);
        });
      });
    }

    // Filter conversations based on search term or filter type
    function filterConversations(searchTerm, filterType) {
      const conversationItems = document.querySelectorAll('.conversation-item');
      
      conversationItems.forEach(item => {
        const title = item.querySelector('h6').textContent.toLowerCase();
        const subtitle = item.querySelector('small').textContent.toLowerCase();
        const message = item.querySelector('p').textContent.toLowerCase();
        const isUnread = item.classList.contains('unread');
        
        let shouldShow = true;
        
        if (filterType === 'search' && searchTerm) {
          shouldShow = title.includes(searchTerm) || 
                      subtitle.includes(searchTerm) || 
                      message.includes(searchTerm);
        } else if (filterType === 'unread') {
          shouldShow = isUnread;
        } else if (filterType === 'recent') {
          // Show conversations from last 24 hours
          const timeElement = item.querySelector('small:last-child');
          if (timeElement) {
            const timeText = timeElement.textContent;
            // Simple check for recent conversations (you can enhance this)
            shouldShow = !timeText.includes('yesterday') && !timeText.includes('ago');
          }
        }
        
        item.style.display = shouldShow ? 'block' : 'none';
      });
    }

    // ===== COMPREHENSIVE MESSAGING FUNCTIONS =====

    // 1. BROADCAST MESSAGE FUNCTIONALITY
    function setupBroadcastMessage() {
      const broadcastBtn = document.querySelector('.quick-action-card .btn-outline-primary');
      if (broadcastBtn) {
        broadcastBtn.addEventListener('click', function() {
          showBroadcastModal();
        });
      }
    }

    function showBroadcastModal() {
      const modalHtml = `
        <div class="modal fade" id="broadcastModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="bi bi-broadcast me-2"></i>
                  Send Broadcast Message
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="broadcastForm">
                  <div class="mb-3">
                    <label class="form-label">Message Title</label>
                    <input type="text" class="form-control" id="broadcastTitle" placeholder="Enter message title" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Message Content</label>
                    <textarea class="form-control" id="broadcastContent" rows="5" placeholder="Enter your broadcast message" required></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Target Audience</label>
                    <select class="form-select" id="broadcastTarget">
                      <option value="all">All Users</option>
                      <option value="agents">Agents Only</option>
                      <option value="buyers">Buyers Only</option>
                      <option value="sellers">Sellers Only</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="broadcastEmail">
                      <label class="form-check-label">Also send as email notification</label>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendBroadcastMessage()">
                  <i class="bi bi-send me-2"></i>Send Broadcast
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('broadcastModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('broadcastModal'));
      modal.show();
    }

    async function sendBroadcastMessage() {
      const title = document.getElementById('broadcastTitle').value;
      const content = document.getElementById('broadcastContent').value;
      const target = document.getElementById('broadcastTarget').value;
      const sendEmail = document.getElementById('broadcastEmail').checked;
      
      if (!title || !content) {
        showToast('Please fill in all required fields', 'error');
        return;
      }
      
      try {
        // Create broadcast message in Firestore
        const broadcastData = {
          title: title,
          content: content,
          target: target,
          sentBy: window.currentUser.id,
          sentByEmail: window.currentUser.email,
          sentAt: firebase.firestore.FieldValue.serverTimestamp(),
          readBy: [],
          sendEmail: sendEmail
        };
        
        await window.firebaseDB.collection('broadcasts').add(broadcastData);
        
        // Send email if requested
        if (sendEmail) {
          await sendBroadcastEmail(broadcastData);
        }
        
        showToast('Broadcast message sent successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('broadcastModal')).hide();
        
      } catch (error) {
        console.error('Error sending broadcast:', error);
        showToast('Failed to send broadcast message', 'error');
      }
    }

    async function sendBroadcastEmail(broadcastData) {
      try {
        // Get target users based on selection
        let usersQuery = window.firebaseDB.collection('users');
        
        if (broadcastData.target === 'agents') {
          usersQuery = usersQuery.where('role', '==', 'agent');
        } else if (broadcastData.target === 'buyers') {
          usersQuery = usersQuery.where('userType', '==', 'buyer');
        } else if (broadcastData.target === 'sellers') {
          usersQuery = usersQuery.where('userType', '==', 'seller');
        }
        
        const usersSnapshot = await usersQuery.get();
        const emails = [];
        
        usersSnapshot.forEach(doc => {
          const userData = doc.data();
          if (userData.email) {
            emails.push(userData.email);
          }
        });
        
        // Send email via Firebase Extensions
        if (emails.length > 0) {
          await window.firebaseDB.collection('mail').add({
            to: emails.join(','),
            message: {
              subject: `[Starlet Properties] ${broadcastData.title}`,
              html: `
                <h2>${broadcastData.title}</h2>
                <p>${broadcastData.content}</p>
                <hr>
                <p><small>This is an automated message from Starlet Properties Admin</small></p>
              `
            }
          });
        }
        
      } catch (error) {
        console.error('Error sending broadcast email:', error);
      }
    }

    // 2. AUTO-REPLY FUNCTIONALITY
    function setupAutoReply() {
      const autoReplyBtn = document.querySelector('.quick-action-card .btn-outline-success');
      if (autoReplyBtn) {
        autoReplyBtn.addEventListener('click', function() {
          showAutoReplyModal();
        });
      }
    }

    function showAutoReplyModal() {
      const modalHtml = `
        <div class="modal fade" id="autoReplyModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="bi bi-gear me-2"></i>
                  Configure Auto-Reply
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="autoReplyForm">
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="enableAutoReply">
                      <label class="form-check-label">Enable Auto-Reply</label>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Auto-Reply Message</label>
                    <textarea class="form-control" id="autoReplyMessage" rows="4" placeholder="Enter your auto-reply message"></textarea>
                    <small class="text-muted">This message will be sent automatically to new conversations</small>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Delay (minutes)</label>
                    <input type="number" class="form-control" id="autoReplyDelay" value="5" min="1" max="60">
                    <small class="text-muted">How long to wait before sending auto-reply</small>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Business Hours</label>
                    <div class="row">
                      <div class="col-6">
                        <label class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="businessStart" value="09:00">
                      </div>
                      <div class="col-6">
                        <label class="form-label">End Time</label>
                        <input type="time" class="form-control" id="businessEnd" value="17:00">
                      </div>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveAutoReplySettings()">
                  <i class="bi bi-check me-2"></i>Save Settings
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('autoReplyModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Load existing settings
      loadAutoReplySettings();
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('autoReplyModal'));
      modal.show();
    }

    async function loadAutoReplySettings() {
      try {
        const settingsDoc = await window.firebaseDB.collection('adminSettings').doc('autoReply').get();
        if (settingsDoc.exists) {
          const settings = settingsDoc.data();
          document.getElementById('enableAutoReply').checked = settings.enabled || false;
          document.getElementById('autoReplyMessage').value = settings.message || '';
          document.getElementById('autoReplyDelay').value = settings.delay || 5;
          document.getElementById('businessStart').value = settings.businessStart || '09:00';
          document.getElementById('businessEnd').value = settings.businessEnd || '17:00';
        }
      } catch (error) {
        console.error('Error loading auto-reply settings:', error);
      }
    }

    async function saveAutoReplySettings() {
      try {
        const settings = {
          enabled: document.getElementById('enableAutoReply').checked,
          message: document.getElementById('autoReplyMessage').value,
          delay: parseInt(document.getElementById('autoReplyDelay').value),
          businessStart: document.getElementById('businessStart').value,
          businessEnd: document.getElementById('businessEnd').value,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: window.currentUser.id
        };
        
        await window.firebaseDB.collection('adminSettings').doc('autoReply').set(settings);
        
        showToast('Auto-reply settings saved successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('autoReplyModal')).hide();
        
      } catch (error) {
        console.error('Error saving auto-reply settings:', error);
        showToast('Failed to save auto-reply settings', 'error');
      }
    }

    // 3. ANALYTICS FUNCTIONALITY
    function setupAnalytics() {
      const analyticsBtn = document.querySelector('.quick-action-card .btn-outline-info');
      if (analyticsBtn) {
        analyticsBtn.addEventListener('click', function() {
          showAnalyticsModal();
        });
      }
    }

    function showAnalyticsModal() {
      const modalHtml = `
        <div class="modal fade" id="analyticsModal" tabindex="-1">
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="bi bi-graph-up me-2"></i>
                  Messaging Analytics
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-3 mb-3">
                    <div class="card text-center">
                      <div class="card-body">
                        <h3 class="text-primary" id="totalMessages">0</h3>
                        <p class="card-text">Total Messages</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3 mb-3">
                    <div class="card text-center">
                      <div class="card-body">
                        <h3 class="text-success" id="activeConversations">0</h3>
                        <p class="card-text">Active Conversations</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3 mb-3">
                    <div class="card text-center">
                      <div class="card-body">
                        <h3 class="text-warning" id="avgResponseTime">0</h3>
                        <p class="card-text">Avg Response Time (min)</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-3 mb-3">
                    <div class="card text-center">
                      <div class="card-body">
                        <h3 class="text-info" id="satisfactionRate">0%</h3>
                        <p class="card-text">Satisfaction Rate</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <div class="card">
                      <div class="card-header">
                        <h6 class="mb-0">Messages per Day (Last 7 Days)</h6>
                      </div>
                      <div class="card-body">
                        <canvas id="messagesChart" width="400" height="200"></canvas>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <div class="card">
                      <div class="card-header">
                        <h6 class="mb-0">Response Time Distribution</h6>
                      </div>
                      <div class="card-body">
                        <canvas id="responseTimeChart" width="400" height="200"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportAnalytics()">
                  <i class="bi bi-download me-2"></i>Export Report
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('analyticsModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('analyticsModal'));
      modal.show();
      
      // Load analytics data
      loadAnalyticsData();
    }

    async function loadAnalyticsData() {
      try {
        // Get analytics data from Firestore
        const analyticsDoc = await window.firebaseDB.collection('analytics').doc('messaging').get();
        let analyticsData = {};
        
        if (analyticsDoc.exists) {
          analyticsData = analyticsDoc.data();
        }
        
        // Update stats
        document.getElementById('totalMessages').textContent = analyticsData.totalMessages || 0;
        document.getElementById('activeConversations').textContent = analyticsData.activeConversations || 0;
        document.getElementById('avgResponseTime').textContent = analyticsData.avgResponseTime || 0;
        document.getElementById('satisfactionRate').textContent = (analyticsData.satisfactionRate || 0) + '%';
        
        // Create charts (you can use Chart.js or any charting library)
        createAnalyticsCharts(analyticsData);
        
      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    function createAnalyticsCharts(data) {
      // This is a placeholder for chart creation
      // You can integrate Chart.js or any other charting library
      console.log('Creating charts with data:', data);
    }

    async function exportAnalytics() {
      try {
        const analyticsDoc = await window.firebaseDB.collection('analytics').doc('messaging').get();
        const data = analyticsDoc.exists ? analyticsDoc.data() : {};
        
        // Create CSV content
        const csvContent = `data:text/csv;charset=utf-8,${[
          'Metric,Value',
          `Total Messages,${data.totalMessages || 0}`,
          `Active Conversations,${data.activeConversations || 0}`,
          `Average Response Time,${data.avgResponseTime || 0} minutes`,
          `Satisfaction Rate,${data.satisfactionRate || 0}%`
        ].join('\n')}`;
        
        // Download file
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `messaging_analytics_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('Analytics report exported successfully!', 'success');
        
      } catch (error) {
        console.error('Error exporting analytics:', error);
        showToast('Failed to export analytics report', 'error');
      }
    }

    // 4. EXPORT FUNCTIONALITY
    function setupExport() {
      const exportBtn = document.querySelector('.quick-action-card .btn-outline-warning');
      if (exportBtn) {
        exportBtn.addEventListener('click', function() {
          showExportModal();
        });
      }
    }

    function showExportModal() {
      const modalHtml = `
        <div class="modal fade" id="exportModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="bi bi-download me-2"></i>
                  Export Conversation History
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="exportForm">
                  <div class="mb-3">
                    <label class="form-label">Export Type</label>
                    <select class="form-select" id="exportType">
                      <option value="all">All Conversations</option>
                      <option value="selected">Selected Conversation</option>
                      <option value="date">By Date Range</option>
                    </select>
                  </div>
                  <div class="mb-3" id="dateRangeDiv" style="display: none;">
                    <label class="form-label">Date Range</label>
                    <div class="row">
                      <div class="col-6">
                        <input type="date" class="form-control" id="exportStartDate">
                      </div>
                      <div class="col-6">
                        <input type="date" class="form-control" id="exportEndDate">
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Format</label>
                    <select class="form-select" id="exportFormat">
                      <option value="csv">CSV</option>
                      <option value="json">JSON</option>
                      <option value="pdf">PDF</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="includeMetadata" checked>
                      <label class="form-check-label">Include metadata (timestamps, user info)</label>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="exportConversations()">
                  <i class="bi bi-download me-2"></i>Export
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('exportModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Setup date range toggle
      document.getElementById('exportType').addEventListener('change', function() {
        const dateRangeDiv = document.getElementById('dateRangeDiv');
        dateRangeDiv.style.display = this.value === 'date' ? 'block' : 'none';
      });
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('exportModal'));
      modal.show();
    }

    async function exportConversations() {
      try {
        const exportType = document.getElementById('exportType').value;
        const exportFormat = document.getElementById('exportFormat').value;
        const includeMetadata = document.getElementById('includeMetadata').checked;
        
        let conversationsData = [];
        
        if (exportType === 'selected' && selectedConversation) {
          // Export selected conversation
          const messagesSnapshot = await window.firebaseDB.collection('conversations')
            .doc(selectedConversation.id)
            .collection('messages')
            .orderBy('createdAt')
            .get();
          
          const messages = [];
          messagesSnapshot.forEach(doc => {
            const msg = doc.data();
            messages.push({
              id: doc.id,
              text: msg.text,
              senderId: msg.senderId,
              senderName: msg.senderName,
              createdAt: msg.createdAt ? msg.createdAt.toDate().toISOString() : null,
              read: msg.read,
              delivered: msg.delivered
            });
          });
          
          conversationsData.push({
            conversationId: selectedConversation.id,
            title: selectedConversation.listingTitle,
            participants: selectedConversation.participants,
            messages: messages
          });
          
        } else if (exportType === 'date') {
          // Export by date range
          const startDate = new Date(document.getElementById('exportStartDate').value);
          const endDate = new Date(document.getElementById('exportEndDate').value);
          
          const conversationsSnapshot = await window.firebaseDB.collection('conversations')
            .where('lastMessageAt', '>=', startDate)
            .where('lastMessageAt', '<=', endDate)
            .get();
          
          for (const convDoc of conversationsSnapshot.docs) {
            const conv = convDoc.data();
            const messagesSnapshot = await convDoc.ref.collection('messages')
              .orderBy('createdAt')
              .get();
            
            const messages = [];
            messagesSnapshot.forEach(doc => {
              const msg = doc.data();
              messages.push({
                id: doc.id,
                text: msg.text,
                senderId: msg.senderId,
                senderName: msg.senderName,
                createdAt: msg.createdAt ? msg.createdAt.toDate().toISOString() : null,
                read: msg.read,
                delivered: msg.delivered
              });
            });
            
            conversationsData.push({
              conversationId: convDoc.id,
              title: conv.listingTitle,
              participants: conv.participants,
              messages: messages
            });
          }
          
        } else {
          // Export all conversations
          const conversationsSnapshot = await window.firebaseDB.collection('conversations').get();
          
          for (const convDoc of conversationsSnapshot.docs) {
            const conv = convDoc.data();
            const messagesSnapshot = await convDoc.ref.collection('messages')
              .orderBy('createdAt')
              .get();
            
            const messages = [];
            messagesSnapshot.forEach(doc => {
              const msg = doc.data();
              messages.push({
                id: doc.id,
                text: msg.text,
                senderId: msg.senderId,
                senderName: msg.senderName,
                createdAt: msg.createdAt ? msg.createdAt.toDate().toISOString() : null,
                read: msg.read,
                delivered: msg.delivered
              });
            });
            
            conversationsData.push({
              conversationId: convDoc.id,
              title: conv.listingTitle,
              participants: conv.participants,
              messages: messages
            });
          }
        }
        
        // Generate export file
        let exportContent = '';
        let filename = '';
        
        if (exportFormat === 'csv') {
          exportContent = generateCSVExport(conversationsData, includeMetadata);
          filename = `conversations_${new Date().toISOString().split('T')[0]}.csv`;
        } else if (exportFormat === 'json') {
          exportContent = JSON.stringify(conversationsData, null, 2);
          filename = `conversations_${new Date().toISOString().split('T')[0]}.json`;
        } else if (exportFormat === 'pdf') {
          // For PDF, you would need a PDF generation library
          showToast('PDF export not implemented yet', 'warning');
          return;
        }
        
        // Download file
        const blob = new Blob([exportContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        showToast('Conversation history exported successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
        
      } catch (error) {
        console.error('Error exporting conversations:', error);
        showToast('Failed to export conversation history', 'error');
      }
    }

    function generateCSVExport(conversationsData, includeMetadata) {
      let csv = 'Conversation ID,Title,Message ID,Sender,Message,Timestamp,Read,Delivered\n';
      
      conversationsData.forEach(conv => {
        conv.messages.forEach(msg => {
          const row = [
            conv.conversationId,
            `"${conv.title || ''}"`,
            msg.id,
            `"${msg.senderName || msg.senderId}"`,
            `"${msg.text || ''}"`,
            msg.createdAt || '',
            msg.read ? 'Yes' : 'No',
            msg.delivered ? 'Yes' : 'No'
          ];
          csv += row.join(',') + '\n';
        });
      });
      
      return csv;
    }

    // 5. ENHANCED MESSAGE FUNCTIONS
    function setupEnhancedMessageFeatures() {
      // Setup attachment functionality
      const attachBtn = document.getElementById('attachBtn');
      if (attachBtn) {
        attachBtn.addEventListener('click', function() {
          document.getElementById('fileInput').click();
        });
      }
      
      // Setup emoji picker
      const emojiBtn = document.getElementById('emojiBtn');
      if (emojiBtn) {
        emojiBtn.addEventListener('click', function() {
          toggleEmojiPicker();
        });
      }
      
      // Setup chat actions
      const chatInfoBtn = document.getElementById('chatInfoBtn');
      const chatArchiveBtn = document.getElementById('chatArchiveBtn');
      
      if (chatInfoBtn) {
        chatInfoBtn.addEventListener('click', function() {
          showConversationInfo();
        });
      }
      
      if (chatArchiveBtn) {
        chatArchiveBtn.addEventListener('click', function() {
          archiveConversation();
        });
      }
    }

    function toggleEmojiPicker() {
      // Create emoji picker if it doesn't exist
      let emojiPicker = document.getElementById('emojiPicker');
      if (!emojiPicker) {
        emojiPicker = document.createElement('div');
        emojiPicker.id = 'emojiPicker';
        emojiPicker.className = 'emoji-picker';
        emojiPicker.style.cssText = `
          position: absolute;
          bottom: 80px;
          right: 20px;
          background: white;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 1000;
          display: none;
        `;
        
        // Add common emojis
        const emojis = ['üòä', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üëé', 'üéâ', 'üî•', 'üíØ', 'üòç', 'ü§î', 'üò≠', 'üò°', 'üëè', 'üôè', 'üí™', 'üéØ'];
        emojis.forEach(emoji => {
          const emojiBtn = document.createElement('button');
          emojiBtn.textContent = emoji;
          emojiBtn.className = 'btn btn-sm me-1 mb-1';
          emojiBtn.onclick = () => {
            const chatInput = document.getElementById('chatInput');
            chatInput.value += emoji;
            emojiPicker.style.display = 'none';
          };
          emojiPicker.appendChild(emojiBtn);
        });
        
        document.body.appendChild(emojiPicker);
      }
      
      emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
    }

    function showConversationInfo() {
      if (!selectedConversation) return;
      
      const modalHtml = `
        <div class="modal fade" id="conversationInfoModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="bi bi-info-circle me-2"></i>
                  Conversation Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-4 text-center">
                    <img src="${selectedConversation.agentAvatar || selectedConversation.listerAvatar || '../../img/default-avatar.svg'}" 
                         class="rounded-circle mb-3" width="80" height="80" alt="User">
                  </div>
                  <div class="col-md-8">
                    <h6>${selectedConversation.listingTitle || 'Listing'}</h6>
                    <p class="text-muted">${selectedConversation.agentName || selectedConversation.listerName || 'User'}</p>
                    <hr>
                    <div class="row">
                      <div class="col-6">
                        <small class="text-muted">Started</small><br>
                        <strong>${selectedConversation.createdAt ? new Date(selectedConversation.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown'}</strong>
                      </div>
                      <div class="col-6">
                        <small class="text-muted">Last Activity</small><br>
                        <strong>${selectedConversation.lastMessageAt ? new Date(selectedConversation.lastMessageAt.seconds * 1000).toLocaleDateString() : 'Unknown'}</strong>
                      </div>
                    </div>
                    <hr>
                    <div class="row">
                      <div class="col-6">
                        <small class="text-muted">Total Messages</small><br>
                        <strong id="totalMessagesCount">Loading...</strong>
                      </div>
                      <div class="col-6">
                        <small class="text-muted">Unread Messages</small><br>
                        <strong>${selectedConversation.unreadCount || 0}</strong>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="clearAllMessages()">
                  <i class="bi bi-trash me-2"></i>Clear All Messages
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteConversation()">
                  <i class="bi bi-trash me-2"></i>Delete Conversation
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('conversationInfoModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Load message count
      loadMessageCount();
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('conversationInfoModal'));
      modal.show();
    }

    async function loadMessageCount() {
      try {
        const messagesSnapshot = await window.firebaseDB.collection('conversations')
          .doc(selectedConversation.id)
          .collection('messages')
          .get();
        
        document.getElementById('totalMessagesCount').textContent = messagesSnapshot.size;
      } catch (error) {
        console.error('Error loading message count:', error);
        document.getElementById('totalMessagesCount').textContent = 'Error';
      }
    }

    async function archiveConversation() {
      if (!selectedConversation) return;
      
      if (confirm('Are you sure you want to archive this conversation?')) {
        try {
          await window.firebaseDB.collection('conversations')
            .doc(selectedConversation.id)
            .update({
              archived: true,
              archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
              archivedBy: window.currentUser.id
            });
          
          showToast('Conversation archived successfully!', 'success');
          loadAdminConversations(); // Refresh conversations list
          
        } catch (error) {
          console.error('Error archiving conversation:', error);
          showToast('Failed to archive conversation', 'error');
        }
      }
    }

    async function clearAllMessages() {
      if (!selectedConversation) return;
      
      if (confirm('Are you sure you want to clear all messages in this conversation? This action cannot be undone.')) {
        try {
          console.log('üóëÔ∏è Clearing all messages for conversation:', selectedConversation.id);
          
          // Get all messages in the conversation
          const messagesSnapshot = await window.firebaseDB.collection('conversations')
            .doc(selectedConversation.id)
            .collection('messages')
            .get();
          
          if (messagesSnapshot.empty) {
            showToast('No messages to clear', 'info');
            return;
          }
          
          // Delete all messages in a batch
          const batch = window.firebaseDB.batch();
          messagesSnapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
          });
          
          await batch.commit();
          
          showToast(`Cleared ${messagesSnapshot.size} messages successfully!`, 'success');
          bootstrap.Modal.getInstance(document.getElementById('conversationInfoModal')).hide();
          
          // Refresh the messages display
          await loadMessages();
          
        } catch (error) {
          console.error('Error clearing messages:', error);
          showToast('Failed to clear messages', 'error');
        }
      }
    }

    async function deleteConversation() {
      if (!selectedConversation) return;
      
      if (confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
        try {
          // Delete all messages in the conversation
          const messagesSnapshot = await window.firebaseDB.collection('conversations')
            .doc(selectedConversation.id)
            .collection('messages')
            .get();
          
          const batch = window.firebaseDB.batch();
          messagesSnapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
          });
          
          // Delete the conversation document
          batch.delete(window.firebaseDB.collection('conversations').doc(selectedConversation.id));
          
          await batch.commit();
          
          showToast('Conversation deleted successfully!', 'success');
          bootstrap.Modal.getInstance(document.getElementById('conversationInfoModal')).hide();
          loadAdminConversations(); // Refresh conversations list
          selectedConversation = null;
          renderChatHeader();
          
        } catch (error) {
          console.error('Error deleting conversation:', error);
          showToast('Failed to delete conversation', 'error');
        }
      }
    }

    // 6. NOTIFICATION PERMISSION HANDLING
    async function requestNotificationPermission() {
      try {
        console.log('üîî Requesting notification permission...');
        
        if (Notification.permission === 'granted') {
          console.log('‚úÖ Notifications already granted');
          showToast('Notifications are already enabled!', 'success');
          return;
        }
        
        if (Notification.permission === 'denied') {
          console.log('‚ùå Notifications blocked by user');
          showToast('Notifications are blocked. Please enable them in your browser settings.', 'warning');
          return;
        }
        
        // Request permission (this must be triggered by user interaction)
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
          console.log('‚úÖ Notification permission granted');
          
          // Get FCM token
          if (window.firebaseMessaging) {
            try {
              const token = await window.firebaseMessaging.getToken({ vapidKey: 'YOUR_PUBLIC_VAPID_KEY' });
              if (window.currentUser && window.firebaseDB) {
                await window.firebaseDB.collection('users').doc(window.currentUser.id).update({ fcmToken: token });
                console.log('‚úÖ FCM token saved successfully');
              }
            } catch (tokenError) {
              console.warn('‚ö†Ô∏è Could not get FCM token:', tokenError);
            }
          }
          
          showToast('Notifications enabled successfully!', 'success');
        } else {
          console.log('‚ùå Notification permission denied');
          showToast('Notification permission denied. You can enable them later in browser settings.', 'info');
        }
        
      } catch (error) {
        console.error('‚ùå Error requesting notification permission:', error);
        showToast('Failed to request notification permission', 'error');
      }
    }

    // 7. DEBUG AND TROUBLESHOOTING
    function debugConversation() {
      console.log('=== DEBUG CONVERSATION START ===');
      console.log('üîç Current state:');
      console.log('  - Selected conversation:', selectedConversation);
      console.log('  - Firebase DB available:', !!window.firebaseDB);
      console.log('  - Current user:', window.currentUser);
      console.log('  - All conversations:', conversations);
      
      // Show debug info in a modal
      const debugInfo = `
        <div class="modal fade" id="debugModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="bi bi-bug me-2"></i>
                  Debug Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-6">
                    <h6>Selected Conversation</h6>
                    <pre class="bg-light p-2 rounded" style="font-size: 0.8rem;">${JSON.stringify(selectedConversation, null, 2)}</pre>
                  </div>
                  <div class="col-md-6">
                    <h6>Current User</h6>
                    <pre class="bg-light p-2 rounded" style="font-size: 0.8rem;">${JSON.stringify(window.currentUser, null, 2)}</pre>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-12">
                    <h6>All Conversations (${conversations.length})</h6>
                    <pre class="bg-light p-2 rounded" style="font-size: 0.7rem; max-height: 200px; overflow-y: auto;">${JSON.stringify(conversations.map(c => ({ id: c.id, title: c.listingTitle, name: c.agentName })), null, 2)}</pre>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-12">
                    <h6>Firebase Status</h6>
                    <ul class="list-unstyled">
                      <li><strong>Firebase DB:</strong> ${window.firebaseDB ? '‚úÖ Available' : '‚ùå Not available'}</li>
                      <li><strong>Firebase Auth:</strong> ${window.firebaseAuth ? '‚úÖ Available' : '‚ùå Not available'}</li>
                      <li><strong>Current URL:</strong> ${window.location.href}</li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="testFirebaseConnection()">
                  <i class="bi bi-wifi"></i> Test Firebase Connection
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('debugModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', debugInfo);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('debugModal'));
      modal.show();
      
      console.log('=== DEBUG CONVERSATION END ===');
    }

    async function createTestConversation() {
      try {
        console.log('üß™ Creating test conversation...');
        
        const testConversation = {
          id: 'test_conversation_' + Date.now(),
          listingTitle: 'Test Property',
          agentName: 'Test User',
          lastMessage: 'Hello, this is a test message',
          lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          unreadCount: 1,
          participants: [window.currentUser.id, 'test_user_id']
        };
        
        // Create conversation document
        await window.firebaseDB.collection('conversations').doc(testConversation.id).set({
          listingTitle: testConversation.listingTitle,
          agentName: testConversation.agentName,
          lastMessage: testConversation.lastMessage,
          lastMessageAt: testConversation.lastMessageAt,
          createdAt: testConversation.createdAt,
          unreadCount: testConversation.unreadCount,
          participants: testConversation.participants
        });
        
        // Add a test message
        await window.firebaseDB.collection('conversations').doc(testConversation.id)
          .collection('messages').add({
            text: 'Hello, this is a test message from the admin panel!',
            senderId: 'test_user_id',
            senderName: 'Test User',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            read: false,
            delivered: true
          });
        
        showToast('Test conversation created successfully!', 'success');
        
        // Reload conversations
        await loadAdminConversations();
        
      } catch (error) {
        console.error('‚ùå Error creating test conversation:', error);
        showToast('Failed to create test conversation: ' + error.message, 'error');
      }
    }

    async function testFirebaseConnection() {
      try {
        console.log('üîç Testing Firebase connection...');
        
        // Test basic Firestore access
        const testDoc = await window.firebaseDB.collection('conversations').limit(1).get();
        console.log('‚úÖ Firestore read test successful');
        
        // Test specific conversation access
        if (selectedConversation) {
          const convDoc = await window.firebaseDB.collection('conversations').doc(selectedConversation.id).get();
          console.log('‚úÖ Conversation access test:', convDoc.exists ? 'Conversation exists' : 'Conversation not found');
          
          if (convDoc.exists) {
            const convData = convDoc.data();
            console.log('‚úÖ Conversation data keys:', Object.keys(convData));
            
            // Test messages subcollection
            try {
              const messagesSnapshot = await window.firebaseDB.collection('conversations')
                .doc(selectedConversation.id)
                .collection('messages')
                .limit(5)
                .get();
              console.log('‚úÖ Messages subcollection test successful, found', messagesSnapshot.size, 'messages');
            } catch (msgError) {
              console.error('‚ùå Messages subcollection test failed:', msgError);
            }
          }
        }
        
        showToast('Firebase connection test completed. Check console for details.', 'success');
        
      } catch (error) {
        console.error('‚ùå Firebase connection test failed:', error);
        showToast('Firebase connection test failed: ' + error.message, 'error');
      }
    }

    // 7. MESSAGE DELETION AND ACTIONS
    async function deleteMessage(messageId) {
      if (!selectedConversation || !messageId) {
        showToast('Cannot delete message: No conversation or message selected', 'error');
        return;
      }
      
      if (!confirm('Are you sure you want to delete this message? This action cannot be undone.')) {
        return;
      }
      
      try {
        console.log('üóëÔ∏è Deleting message:', messageId);
        
        // Delete the message from Firestore
        await window.firebaseDB.collection('conversations')
          .doc(selectedConversation.id)
          .collection('messages')
          .doc(messageId)
          .delete();
        
        showToast('Message deleted successfully!', 'success');
        console.log('‚úÖ Message deleted successfully');
        
      } catch (error) {
        console.error('‚ùå Error deleting message:', error);
        showToast('Failed to delete message. Please try again.', 'error');
      }
    }

    function copyMessageText(messageId) {
      const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
      if (!messageElement) {
        showToast('Message not found', 'error');
        return;
      }
      
      const messageContent = messageElement.querySelector('.message-content').textContent;
      
      // Copy to clipboard
      navigator.clipboard.writeText(messageContent).then(() => {
        showToast('Message text copied to clipboard!', 'success');
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = messageContent;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('Message text copied to clipboard!', 'success');
      });
    }

    function setupMessageHoverEffects() {
      const messageElements = document.querySelectorAll('[data-message-id]');
      
      messageElements.forEach(element => {
        const messageBubble = element.querySelector('.message-bubble');
        const messageActions = element.querySelector('.message-actions');
        
        if (messageBubble && messageActions) {
          // Show actions on hover
          messageBubble.addEventListener('mouseenter', () => {
            messageActions.style.display = 'block';
          });
          
          messageBubble.addEventListener('mouseleave', () => {
            messageActions.style.display = 'none';
          });
          
          // Click to select message
          messageBubble.addEventListener('click', (e) => {
            // Don't select if clicking on dropdown
            if (e.target.closest('.dropdown')) {
              return;
            }
            
            // Remove selection from other messages
            document.querySelectorAll('.message-bubble.selected').forEach(el => {
              el.classList.remove('selected');
            });
            
            // Toggle selection on clicked message
            messageBubble.classList.toggle('selected');
            
            // Show selection info
            if (messageBubble.classList.contains('selected')) {
              const messageId = element.dataset.messageId;
              showToast(`Message selected. Press Ctrl+Delete to delete or Escape to deselect.`, 'info');
            }
          });
        }
      });
    }

    // 7. TOAST NOTIFICATION SYSTEM
    function showToast(message, type = 'info') {
      const toastHtml = `
        <div class="toast align-items-center text-bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'primary'} border-0 position-fixed bottom-0 end-0 m-3" style="z-index: 9999;">
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>
      `;
      
      // Remove existing toasts
      document.querySelectorAll('.toast').forEach(toast => toast.remove());
      
      // Add new toast
      document.body.insertAdjacentHTML('beforeend', toastHtml);
      
      // Show toast
      const toastElement = document.querySelector('.toast');
      const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
      toast.show();
      
      // Remove toast after it's hidden
      toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
      });
    }
  </script>
</body>
</html> 
