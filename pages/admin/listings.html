<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Listings - Starlet Properties (Admin)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="/index.html">
                <span class="brand-star">Star</span> <span class="brand-let">Let</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="#">Listings</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>All Listings</h2>
            <form id="filterForm" class="row g-2 align-items-end">
                <div class="col-auto">
                    <input type="text" class="form-control" id="searchKeyword" placeholder="Keyword">
                </div>
                <div class="col-auto">
                    <select class="form-select" id="filterType">
                        <option value="">All Types</option>
                        <option value="property">Property</option>
                        <option value="vehicle">Vehicle</option>
                    </select>
                </div>
                <div class="col-auto">
                    <select class="form-select" id="filterStatus">
                        <option value="">All Statuses</option>
                        <option value="Active">Active</option>
                        <option value="Pending">Pending</option>
                        <option value="Sold">Sold</option>
                    </select>
                </div>
                <div class="col-auto">
                    <input type="text" class="form-control" id="filterLocation" placeholder="Location">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Filter</button>
                </div>
            </form>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Price</th>
                        <th>Location</th>
                        <th>Agent/Store</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="listingsTableBody">
                    <tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDH1sMk2NwceMAEfvH07azxaoPXpOI1Sek",
      authDomain: "starlet-properties-41509.firebaseapp.com",
      projectId: "starlet-properties-41509",
      storageBucket: "starlet-properties-41509.appspot.com",
      messagingSenderId: "393372988481",
      appId: "1:393372988481:web:c92584d7408296457b02c0",
      measurementId: "G-F02K9SP07C"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function fetchListings(filters = {}) {
      let ref = db.collection('listings');
      if (filters.type) ref = ref.where('listingType', '==', filters.type);
      if (filters.status) ref = ref.where('status', '==', filters.status);
      // For location and keyword, filter client-side after fetch
      const snapshot = await ref.orderBy('createdAt', 'desc').limit(100).get();
      let listings = [];
      snapshot.forEach(doc => {
        listings.push({ id: doc.id, ...doc.data() });
      });
      // Client-side filter for keyword and location
      if (filters.keyword) {
        const kw = filters.keyword.toLowerCase();
        listings = listings.filter(l =>
          (l.title && l.title.toLowerCase().includes(kw)) ||
          (l.description && l.description.toLowerCase().includes(kw))
        );
      }
      if (filters.location) {
        const loc = filters.location.toLowerCase();
        listings = listings.filter(l =>
          (l.district && l.district.toLowerCase().includes(loc)) ||
          (l.town && l.town.toLowerCase().includes(loc)) ||
          (l.area && l.area.toLowerCase().includes(loc))
        );
      }
      return listings;
    }

    async function renderListings(filters = {}) {
      const tbody = document.getElementById('listingsTableBody');
      tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>';
      const listings = await fetchListings(filters);
      if (!listings.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No listings found.</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      for (const l of listings) {
        // Fetch agent/store info
        let agentName = l.contactInfo || '';
        let storeName = '';
        if (l.userId) {
          const storeSnap = await db.collection('stores').where('userId', '==', l.userId).limit(1).get();
          if (!storeSnap.empty) {
            const store = storeSnap.docs[0].data();
            storeName = store.name;
          }
        }
        tbody.innerHTML += `
          <tr>
            <td>${l.title || ''}</td>
            <td>${l.listingType || ''}</td>
            <td>${l.status ? `<span class="badge bg-success">${l.status}</span>` : ''}</td>
            <td>${l.askingPrice ? 'USh ' + Number(l.askingPrice).toLocaleString() : ''}</td>
            <td>${l.district || ''}${l.town ? ', ' + l.town : ''}${l.area ? ', ' + l.area : ''}</td>
            <td>${storeName || agentName}</td>
            <td>${l.createdAt && l.createdAt.toDate ? l.createdAt.toDate().toLocaleDateString() : ''}</td>
            <td>
              <a href="/details.html?id=${l.id}" class="btn btn-sm btn-outline-primary">View</a>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteListing('${l.id}')">Delete</button>
            </td>
          </tr>
        `;
      }
    }

    // Delete listing
    async function deleteListing(id) {
      if (confirm('Are you sure you want to delete this listing?')) {
        await db.collection('listings').doc(id).delete();
        alert('Listing deleted.');
        renderListings(getFilters());
      }
    }

    function getFilters() {
      return {
        keyword: document.getElementById('searchKeyword').value.trim(),
        type: document.getElementById('filterType').value,
        status: document.getElementById('filterStatus').value,
        location: document.getElementById('filterLocation').value.trim()
      };
    }

    document.getElementById('filterForm').addEventListener('submit', function(e) {
      e.preventDefault();
      renderListings(getFilters());
    });

    document.addEventListener('DOMContentLoaded', function() {
      renderListings();
    });
    </script>
</body>
</html>
