<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Analytics | Starlet Properties</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <link rel="stylesheet" href="/starlet-2/css/style.css">
</head>
<body class="admin-panel">
    <!-- Admin Sidebar -->
    <nav class="admin-sidebar">
        <div class="sidebar-brand mb-4"><span class="brand-star">Star</span><span class="brand-let">Let</span> Admin</div>
        <div class="nav flex-column">
            <a href="dashboard.html" class="nav-link"><i class="bi bi-speedometer2"></i> Dashboard</a>
            <a href="listings.html" class="nav-link"><i class="bi bi-list-ul"></i> Listings</a>
            <a href="users.html" class="nav-link"><i class="bi bi-people"></i> Users</a>
            <a href="stores.html" class="nav-link"><i class="bi bi-shop"></i> Stores</a>
            <a href="official-store.html" class="nav-link"><i class="bi bi-patch-check"></i> Official Store</a>
            <a href="analytics.html" class="nav-link active"><i class="bi bi-bar-chart"></i> Analytics</a>
            <a href="messages.html" class="nav-link"><i class="bi bi-chat-dots"></i> Messages</a>
            <a href="reviews.html" class="nav-link"><i class="bi bi-star"></i> Reviews</a>
            <a href="settings.html" class="nav-link"><i class="bi bi-gear"></i> Settings</a>
            <a href="#" class="logout-link"><i class="bi bi-box-arrow-right"></i> Logout</a>
        </div>
    </nav>
    <!-- Admin Navbar -->
    <nav class="admin-navbar">
        <div class="navbar-brand">
            <span class="brand-star">Star</span> <span class="brand-let">Let</span> Admin
        </div>
        <div class="profile-dropdown dropdown">
            <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="profile-avatar me-2"><img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Admin"></span>
                <span>Admin</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                <li><a class="dropdown-item" href="#">Profile</a></li>
                <li><a class="dropdown-item" href="#">Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item logout-link" href="#"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
            </ul>
        </div>
    </nav>
    <!-- Main Content -->
    <main style="min-height: 100vh;">
        <!-- Hero Section -->
        <section class="hero-section">
            <div class="container">
                <h2 class="hero-title">Analytics & Reports</h2>
                <p class="hero-subtitle">View platform statistics, trends, and performance reports</p>
            </div>
        </section>
        <!-- Add Generate Report Button -->
        <div class="mb-3 text-end">
            <button id="generateReportBtn" class="btn btn-primary">
                <i class="bi bi-file-earmark-pdf"></i> Generate Report (PDF)
            </button>
        </div>
        <div class="container my-5">
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card card-modern text-center p-3 h-100">
                        <div class="card-body">
                            <h5 class="card-title">Total Listings</h5>
                            <div class="fs-4 fw-bold" id="total-listings">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-modern text-center p-3 h-100">
                        <div class="card-body">
                            <h5 class="card-title">Total Users</h5>
                            <div class="fs-4 fw-bold" id="total-users">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-modern text-center p-3 h-100">
                        <div class="card-body">
                            <h5 class="card-title">Total Stores</h5>
                            <div class="fs-4 fw-bold" id="total-stores">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-modern text-center p-3 h-100">
                        <div class="card-body">
                            <h5 class="card-title">Pending Approvals</h5>
                            <div class="fs-4 fw-bold" id="pending-approvals">-</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">Listings Over Time (Property vs Vehicles)</div>
                        <div class="card-body">
                            <canvas id="listingsCompareChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">User Registrations</div>
                        <div class="card-body">
                            <canvas id="usersChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">Store Performance</div>
                        <div class="card-body">
                            <canvas id="storesChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">Top Agents/Stores</div>
                        <div class="card-body">
                            <ul id="topAgentsList" class="list-group"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header">Daily Views</div>
                        <div class="card-body">
                            <canvas id="dailyViewsChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <h4>About Starlet Properties</h4>
                    <p>Uganda's premier real estate and vehicle marketplace, connecting buyers and sellers across the country.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h4>Properties</h4>
                    <ul>
                        <li><a href="/properties.html?type=house_sale">Houses for Sale</a></li>
                        <li><a href="/properties.html?type=house_rent">Houses for Rent</a></li>
                        <li><a href="/properties.html?type=land_sale">Land for Sale</a></li>
                        <li><a href="/properties.html?type=land_rent">Land for Rent</a></li>
                        <li><a href="/properties.html?type=commercial">Commercial Property</a></li>
                        <li><a href="/properties.html?type=vacation_short_stay">Vacation & Short Stay</a></li>
                    </ul>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h4>Vehicles</h4>
                    <ul>
                        <li><a href="/vehicles.html?type=cars">Cars</a></li>
                        <li><a href="/vehicles.html?type=motorcycles">Motorcycles</a></li>
                        <li><a href="/vehicles.html?type=trucks">Trucks</a></li>
                        <li><a href="/vehicles.html?type=buses">Buses</a></li>
                        <li><a href="/vehicles.html?type=heavy_machinery">Heavy Machinery</a></li>
                        <li><a href="/vehicles.html?type=bicycles_ebikes">Bicycles & E-bikes</a></li>
                        <li><a href="/vehicles.html?type=boats_watercraft">Boats & Watercraft</a></li>
                    </ul>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h4>Company</h4>
                    <ul>
                        <li><a href="/about.html">About Us</a></li>
                        <li><a href="/contact.html">Contact</a></li>
                        <li><a href="/resources.html">Resources</a></li>
                        <li><a href="/stores.html">Our Stores</a></li>
                        <li><a href="/privacy.html">Privacy Policy</a></li>
                    </ul>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h4>Contact</h4>
                    <ul>
                        <li><a href="tel:+256123456789"><i class="bi bi-telephone"></i> +256 123 456 789</a></li>
                        <li><a href="mailto:info@starlet.co.ug"><i class="bi bi-envelope"></i> info@starlet.co.ug</a></li>
                        <li><a href="#"><i class="bi bi-geo-alt"></i> Kampala, Uganda</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-0">&copy; 2024 Starlet Properties. All rights reserved.</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="/terms.html" class="me-3">Terms of Service</a>
                        <a href="/privacy.html">Privacy Policy</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="../../js/admin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Add jsPDF and html2canvas CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase Initialization (only if not already set by admin.js) -->
    <script>
      if (typeof firebase !== 'undefined' && typeof db === 'undefined') {
        const firebaseConfig = {
          apiKey: "AIzaSyDH1sMk2NwceMAEfvH07azxaoPXpOI1Sek",
          authDomain: "starlet-properties-41509.firebaseapp.com",
          projectId: "starlet-properties-41509",
          storageBucket: "starlet-properties-41509.appspot.com",
          messagingSenderId: "393372988481",
          appId: "1:393372988481:web:c92584d7408296457b02c0",
          measurementId: "G-F02K9SP07C"
        };
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        window.db = firebase.firestore();
        window.auth = firebase.auth();
      }
    </script>
    <script>
      // --- Admin Analytics (Schema-Driven) ---
      document.addEventListener('DOMContentLoaded', function() {
        // Wait for Firebase to be initialized (db/auth set)
        function waitForFirebaseInit(retries = 10) {
          if (typeof db !== 'undefined' && db && typeof auth !== 'undefined' && auth) {
            requireAdminUser().then(() => {
              fetchAndRenderStats();
              fetchAndRenderCharts();
            });
          } else if (retries > 0) {
            setTimeout(() => waitForFirebaseInit(retries - 1), 150);
          } else {
            showToast('Error: Firebase not initialized', 'danger');
          }
        }
        waitForFirebaseInit();
      });

      // Fetch and display stats
      async function fetchAndRenderStats() {
        try {
          // Listings
          const listingsSnap = await db.collection('listings').get();
          const totalListings = listingsSnap.size;
          const pendingApprovals = listingsSnap.docs.filter(doc => doc.data().adminVerification?.status === 'pending').length;
          document.getElementById('total-listings').textContent = totalListings;
          document.getElementById('pending-approvals').textContent = pendingApprovals;
          // Users
          const usersSnap = await db.collection('users').get();
          document.getElementById('total-users').textContent = usersSnap.size;
          // Stores
          const storesSnap = await db.collection('stores').get();
          document.getElementById('total-stores').textContent = storesSnap.size;
        } catch (err) {
          showToast('Error loading stats: ' + err.message, 'danger');
        }
      }

      // Fetch and render charts
      async function fetchAndRenderCharts() {
        // --- Listings Over Time: Property vs Vehicles ---
        const propertyTypes = ['house_sale', 'house_rent', 'land_sale', 'land_rent', 'vacation_short_stay'];
        const vehicleTypes = ['vehicle_sale', 'motorcycle_sale', 'heavy_machinery_sale', 'bicycle_ebike_sale', 'boat_watercraft_sale'];
        const listingsSnap = await db.collection('listings').orderBy('createdAt').get();
        const listingsByMonthCategory = {};
        listingsSnap.forEach(doc => {
            const d = doc.data();
            let date = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;
            if (!date) return;
            const key = `${date.getFullYear()}-${date.getMonth()+1}`;
            if (!listingsByMonthCategory[key]) listingsByMonthCategory[key] = { Property: 0, Vehicles: 0 };
            if (propertyTypes.includes(d.listingType)) {
                listingsByMonthCategory[key].Property++;
            } else if (vehicleTypes.includes(d.listingType)) {
                listingsByMonthCategory[key].Vehicles++;
            }
        });
        renderCompareLineChart('listingsCompareChart', listingsByMonthCategory, ['Property', 'Vehicles']);

        // --- User Registrations by Role ---
        const usersSnap = await db.collection('users').orderBy('createdAt').get();
        const usersByMonthRole = {};
        usersSnap.forEach(doc => {
            const d = doc.data();
            let date = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;
            if (!date) return;
            const key = `${date.getFullYear()}-${date.getMonth()+1}`;
            if (!usersByMonthRole[key]) usersByMonthRole[key] = {};
            usersByMonthRole[key][d.role] = (usersByMonthRole[key][d.role] || 0) + 1;
        });
        renderStackedLineChart('usersChart', usersByMonthRole, 'Users');

        // --- Stores by Agent Tier ---
        const storesSnap = await db.collection('stores').orderBy('createdAt').get();
        const storesByMonthTier = {};
        storesSnap.forEach(doc => {
            const d = doc.data();
            let date = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;
            if (!date) return;
            const key = `${date.getFullYear()}-${date.getMonth()+1}`;
            if (!storesByMonthTier[key]) storesByMonthTier[key] = {};
            storesByMonthTier[key][d.agentTier] = (storesByMonthTier[key][d.agentTier] || 0) + 1;
        });
        renderStackedLineChart('storesChart', storesByMonthTier, 'Stores');

        // --- Top Agents/Stores (by listings count) ---
        const agentCounts = {};
        listingsSnap.forEach(doc => {
            const d = doc.data();
            const agent = d.agentId || d.storeId || 'Unknown';
            agentCounts[agent] = (agentCounts[agent] || 0) + 1;
        });
        const sortedAgents = Object.entries(agentCounts).sort((a,b) => b[1]-a[1]).slice(0,8);
        await renderTopAgentsList(sortedAgents);

        // --- Daily Views Chart ---
        const analyticsSnap = await db.collection('analytics').where('type', 'in', [
            'view', 'listing_view', 'vehicle_view', 'motorcycle_view', 'heavy_machinery_view', 'bicycle_ebike_view', 'boat_watercraft_view', 'vacation_short_stay_view'
        ]).orderBy('createdAt').get();
        const viewsByDay = {};
        analyticsSnap.forEach(doc => {
            const d = doc.data();
            let date = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;
            if (!date) return;
            const key = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
            viewsByDay[key] = (viewsByDay[key] || 0) + 1;
        });
        renderDailyViewsChart('dailyViewsChart', viewsByDay);
      }

      function renderCompareLineChart(canvasId, dataObj, categories) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = Object.keys(dataObj);
        const datasets = categories.map((cat, i) => ({
            label: cat,
            data: labels.map(l => dataObj[l][cat] || 0),
            borderColor: `hsl(${i*40},70%,50%)`,
            backgroundColor: `hsla(${i*40},70%,50%,0.1)`,
            fill: false,
            tension: 0.3
        }));
        new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: { responsive: true, plugins: { legend: { display: true } } }
        });
      }

      function renderStackedLineChart(canvasId, dataObj, label) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = Object.keys(dataObj);
        const allKeys = Array.from(new Set(labels.flatMap(l => Object.keys(dataObj[l]))));
        const datasets = allKeys.map((k, i) => ({
          label: k,
          data: labels.map(l => dataObj[l][k] || 0),
          borderColor: `hsl(${i * 40},70%,50%)`,
          backgroundColor: `hsla(${i * 40},70%,50%,0.1)`,
          fill: true,
          tension: 0.3
        }));
        new Chart(ctx, {
          type: 'line',
          data: { labels, datasets },
          options: { responsive: true, plugins: { legend: { display: true } } }
        });
      }

      function renderDailyViewsChart(canvasId, dataObj) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = Object.keys(dataObj);
        const data = labels.map(l => dataObj[l] || 0);
        new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Daily Views',
                    data,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13,110,253,0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true } } }
        });
      }

      // Helper to fetch names for agent/store IDs
      async function fetchAgentStoreNames(ids) {
        const names = {};
        // Try to fetch from users (agents)
        if (ids.length === 0) return names;
        // Firestore 'in' queries are limited to 10
        const batchSize = 10;
        for (let i = 0; i < ids.length; i += batchSize) {
          const batchIds = ids.slice(i, i + batchSize);
          const usersSnap = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', batchIds).get();
          usersSnap.forEach(doc => {
            names[doc.id] = doc.data().displayName || doc.data().name || doc.data().email || doc.id;
          });
          const storesSnap = await db.collection('stores').where(firebase.firestore.FieldPath.documentId(), 'in', batchIds).get();
          storesSnap.forEach(doc => {
            names[doc.id] = doc.data().name || doc.id;
          });
        }
        ids.forEach(id => {
          if (!names[id]) names[id] = id;
        });
        return names;
      }

      async function renderTopAgentsList(sortedAgents) {
        const topIds = sortedAgents.map(x => x[0]);
        const namesMap = await fetchAgentStoreNames(topIds);
        const list = document.getElementById('topAgentsList');
        list.innerHTML = '';
        sortedAgents.forEach(([id, count]) => {
          const name = namesMap[id] || id;
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.textContent = name;
          const badge = document.createElement('span');
          badge.className = 'badge bg-primary rounded-pill';
          badge.textContent = count;
          li.appendChild(badge);
          list.appendChild(li);
        });
      }

      document.getElementById('generateReportBtn').addEventListener('click', async function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Title
        doc.setFontSize(18);
        doc.text('Starlet Analytics Report', 10, 15);

        // Add summary stats
        doc.setFontSize(12);
        doc.text('Total Listings: ' + document.getElementById('total-listings').textContent, 10, 30);
        doc.text('Total Users: ' + document.getElementById('total-users').textContent, 10, 38);
        doc.text('Total Stores: ' + document.getElementById('total-stores').textContent, 10, 46);
        doc.text('Pending Approvals: ' + document.getElementById('pending-approvals').textContent, 10, 54);

        // Helper to add chart as image
        async function addChartImage(canvasId, y) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return y;
          const imgData = canvas.toDataURL('image/png');
          doc.addImage(imgData, 'PNG', 10, y, 180, 60);
          return y + 65;
        }

        let y = 65;
        y = await addChartImage('listingsCompareChart', y);
        y = await addChartImage('usersChart', y);
        y = await addChartImage('storesChart', y);
        y = await addChartImage('dailyViewsChart', y);

        // Add Top Agents/Stores
        doc.setFontSize(14);
        doc.text('Top Agents/Stores:', 10, y + 10);
        doc.setFontSize(12);
        const list = document.getElementById('topAgentsList');
        if (list) {
          Array.from(list.children).forEach((li, i) => {
            doc.text('- ' + li.textContent, 12, y + 18 + i * 8);
          });
          y += 18 + list.children.length * 8;
        }

        doc.save('starlet-analytics-report.pdf');
      });
    </script>
</body>
</html>
