<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="img-src 'self' data: https:;">
    <title>Admin - Analytics | Starlet Properties</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="icon" type="image/x-icon" href="../../favicon.ico">
</head>
<body class="admin-panel">
      <!-- Admin Sidebar -->
  <div class="admin-sidebar" id="adminSidebar">
    <div class="sidebar-header d-flex align-items-center justify-content-between p-3">
      <div class="sidebar-brand">
        <span class="brand-star">Star</span><span class="brand-let">Let</span> Admin
      </div>
      <button type="button" class="btn-close btn-close-white d-lg-none" id="sidebarCloseBtn" aria-label="Close sidebar"></button>
    </div>
    <div class="sidebar-content p-3">
      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">
            <i class="bi-speedometer2"></i>
            <span class="nav-text">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="listings.html" class="nav-link">
            <i class="bi-list-ul"></i>
            <span class="nav-text">Listings</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="users.html" class="nav-link">
            <i class="bi-people"></i>
            <span class="nav-text">Users</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="stores.html" class="nav-link">
            <i class="bi-shop"></i>
            <span class="nav-text">Stores</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="official-store.html" class="nav-link">
            <i class="bi-patch-check"></i>
            <span class="nav-text">Official Store</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="analytics.html" class="nav-link active">
            <i class="bi-bar-chart"></i>
            <span class="nav-text">Analytics</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="messages.html" class="nav-link">
            <i class="bi-chat-dots"></i>
            <span class="nav-text">Messages</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="reviews.html" class="nav-link">
            <i class="bi-star"></i>
            <span class="nav-text">Reviews</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="settings.html" class="nav-link">
            <i class="bi-gear"></i>
            <span class="nav-text">Settings</span>
          </a>
        </li>
        <li class="nav-item mt-auto">
          <a href="#" class="logout-link nav-link">
            <i class="bi bi-box-arrow-right"></i>
            <span class="nav-text">Logout</span>
          </a>
        </li>
      </ul>
    </div>
  </div>
  <!-- Admin Navbar -->
  <nav class="admin-navbar d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <!-- Sidebar Toggle Button -->
      <button class="btn btn-outline-primary sidebar-toggle me-3" type="button" id="sidebarToggle" aria-label="Toggle sidebar">
        <i class="bi bi-list" id="sidebarToggleIcon"></i>
      </button>
      <div class="navbar-brand">
        <span class="brand-star">Star</span> <span class="brand-let">Let</span> Admin
      </div>
    </div>
    <div class="d-flex align-items-center">
      <!-- Notifications -->
      <div class="position-relative me-3">
        <button class="btn btn-outline-secondary btn-sm" id="notificationsBtn" title="Notifications">
          <i class="bi bi-bell"></i>
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="font-size: 0.6rem; display: none;">0</span>
        </button>
      </div>
      <!-- Profile Dropdown -->
      <div class="profile-dropdown dropdown">
        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="profile-avatar me-2">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzBkNmVmZCIvPgo8dGV4dCB4PSIxNiIgeT0iMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BPC90ZXh0Pgo8L3N2Zz4K" alt="Admin">
          </span>
          <span id="adminName">Admin</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
          <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
          <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item logout-link" href="#"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <nav class="admin-navbar d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <!-- Sidebar Toggle Button -->
      <button class="btn btn-outline-primary sidebar-toggle me-3" type="button" id="sidebarToggle" aria-label="Toggle sidebar">
        <i class="bi bi-list" id="sidebarToggleIcon"></i>
      </button>
      <div class="navbar-brand">
        <span class="brand-star">Star</span> <span class="brand-let">Let</span> Admin
      </div>
    </div>
    <div class="d-flex align-items-center">
      <!-- Notifications -->
      <div class="position-relative me-3">
        <button class="btn btn-outline-secondary btn-sm" id="notificationsBtn" title="Notifications">
          <i class="bi bi-bell"></i>
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="font-size: 0.6rem; display: none;">0</span>
        </button>
      </div>
      <!-- Profile Dropdown -->
      <div class="profile-dropdown dropdown">
        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="profile-avatar me-2">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzBkNmVmZCIvPgo8dGV4dCB4PSIxNiIgeT0iMjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BPC90ZXh0Pgo8L3N2Zz4K" alt="Admin">
          </span>
          <span id="adminName">Admin</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
          <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
          <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item logout-link" href="#"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>
    <!-- Main Content -->
    <main style="min-height: 100vh;">
        <!-- Hero Section -->
        <section class="hero-section">
            <div class="container">
                <h2 class="hero-title">Analytics & Reports</h2>
                <p class="hero-subtitle">View platform statistics, trends, and performance reports</p>
            </div>
        </section>
        <!-- Add Generate Report Button -->
        <div class="mb-3 text-end">
            <button id="generateReportBtn" class="btn btn-primary">
                <i class="bi bi-file-earmark-pdf"></i> Generate Report (PDF)
            </button>
        </div>
        <div class="container my-5">
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card card-modern text-center p-3 h-100">
                        <div class="card-body">
                            <h5 class="card-title">Total Listings</h5>
                            <div class="fs-4 fw-bold" id="total-listings">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-modern text-center p-3 h-100">
                        <div class="card-body">
                            <h5 class="card-title">Total Users</h5>
                            <div class="fs-4 fw-bold" id="total-users">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-modern text-center p-3 h-100">
                        <div class="card-body">
                            <h5 class="card-title">Total Stores</h5>
                            <div class="fs-4 fw-bold" id="total-stores">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-modern text-center p-3 h-100">
                        <div class="card-body">
                            <h5 class="card-title">Pending Approvals</h5>
                            <div class="fs-4 fw-bold" id="pending-approvals">-</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">Listings Over Time (Property vs Vehicles)</div>
                        <div class="card-body">
                            <canvas id="listingsCompareChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">User Registrations</div>
                        <div class="card-body">
                            <canvas id="usersChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">Store Performance</div>
                        <div class="card-body">
                            <canvas id="storesChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header">Top Agents/Stores</div>
                        <div class="card-body">
                            <ul id="topAgentsList" class="list-group"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header">Daily Views</div>
                        <div class="card-body">
                            <canvas id="dailyViewsChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <h4>About Starlet Properties</h4>
                    <p>Uganda's premier real estate and vehicle marketplace, connecting buyers and sellers across the country.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h4>Properties</h4>
                    <ul>
                        <li><a href="/properties.html?type=house_sale">Houses for Sale</a></li>
                        <li><a href="/properties.html?type=house_rent">Houses for Rent</a></li>
                        <li><a href="/properties.html?type=land_sale">Land for Sale</a></li>
                        <li><a href="/properties.html?type=land_rent">Land for Rent</a></li>
                        <li><a href="/properties.html?type=commercial">Commercial Property</a></li>
                        <li><a href="/properties.html?type=vacation_short_stay">Vacation & Short Stay</a></li>
                    </ul>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h4>Vehicles</h4>
                    <ul>
                        <li><a href="/vehicles.html?type=cars">Cars</a></li>
                        <li><a href="/vehicles.html?type=motorcycles">Motorcycles</a></li>
                        <li><a href="/vehicles.html?type=trucks">Trucks</a></li>
                        <li><a href="/vehicles.html?type=buses">Buses</a></li>
                        <li><a href="/vehicles.html?type=heavy_machinery">Heavy Machinery</a></li>
                        <li><a href="/vehicles.html?type=bicycles_ebikes">Bicycles & E-bikes</a></li>
                        <li><a href="/vehicles.html?type=boats_watercraft">Boats & Watercraft</a></li>
                    </ul>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h4>Company</h4>
                    <ul>
                        <li><a href="/about.html">About Us</a></li>
                        <li><a href="/contact.html">Contact</a></li>
                        <li><a href="/resources.html">Resources</a></li>
                        <li><a href="/stores.html">Our Stores</a></li>
                        <li><a href="/privacy.html">Privacy Policy</a></li>
                    </ul>
                </div>
                <div class="col-lg-2 col-md-6 mb-4">
                    <h4>Contact</h4>
                    <ul>
                        <li><a href="tel:+256123456789"><i class="bi bi-telephone"></i> +256 123 456 789</a></li>
                        <li><a href="mailto:info@starlet.co.ug"><i class="bi bi-envelope"></i> info@starlet.co.ug</a></li>
                        <li><a href="#"><i class="bi bi-geo-alt"></i> Kampala, Uganda</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-0">&copy; 2024 Starlet Properties. All rights reserved.</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="/terms.html" class="me-3">Terms of Service</a>
                        <a href="/privacy.html">Privacy Policy</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Config -->
    <script src="../../assets/js/firebase-config.js"></script>
    <script src="../../js/admin.js"></script>
    <script src="../../js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Add jsPDF and html2canvas CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase is now initialized by firebase-config.js -->
    <script>
      // --- Admin Analytics (Schema-Driven) ---
      document.addEventListener('DOMContentLoaded', function() {
        // Wait for Firebase to be initialized (db/auth set)
        function waitForFirebaseInit(retries = 10) {
          if (typeof db !== 'undefined' && db && typeof auth !== 'undefined' && auth) {
            requireAdminUser().then(() => {
              fetchAndRenderStats();
              fetchAndRenderCharts();
            }
        // Setup sidebar toggle functionality
        setupSidebarToggle();
      });
      
      
      // Setup sidebar toggle functionality
      function setupSidebarToggle() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
        const sidebar = document.getElementById('adminSidebar');
        const adminPanel = document.querySelector('.admin-panel');
        const toggleIcon = document.getElementById('sidebarToggleIcon');
        
        // Get saved sidebar state
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        
        // Initialize sidebar state
        if (sidebarCollapsed) {
          sidebar.classList.add('collapsed');
          adminPanel.classList.add('sidebar-collapsed');
          sidebarToggle.classList.add('active');
        }
        
        // Toggle sidebar
        sidebarToggle.addEventListener('click', () => {
          const isCollapsed = sidebar.classList.contains('collapsed');
          
          if (isCollapsed) {
            // Show sidebar
            sidebar.classList.remove('collapsed');
            adminPanel.classList.remove('sidebar-collapsed');
            sidebarToggle.classList.remove('active');
            localStorage.setItem('sidebarCollapsed', 'false');
          } else {
            // Hide sidebar
            sidebar.classList.add('collapsed');
            adminPanel.classList.add('sidebar-collapsed');
            sidebarToggle.classList.add('active');
            localStorage.setItem('sidebarCollapsed', 'true');
          }
        });
        
        // Close sidebar on mobile
        sidebarCloseBtn.addEventListener('click', () => {
          sidebar.classList.remove('show');
        });
        
        // Handle mobile sidebar behavior
        function handleMobileSidebar() {
          if (window.innerWidth <= 768) {
            sidebar.classList.remove('collapsed');
            sidebar.classList.add('show');
          } else {
            sidebar.classList.remove('show');
            // Restore desktop state
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (sidebarCollapsed) {
              sidebar.classList.add('collapsed');
              adminPanel.classList.add('sidebar-collapsed');
              sidebarToggle.classList.add('active');
            } else {
              sidebar.classList.remove('collapsed');
              adminPanel.classList.remove('sidebar-collapsed');
              sidebarToggle.classList.remove('active');
            }
          }
        }
        
        // Handle window resize
        window.addEventListener('resize', handleMobileSidebar);
        
        // Initial mobile check
        handleMobileSidebar();
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
          if (window.innerWidth <= 768) {
            if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
              sidebar.classList.remove('show');
            }
          }
        });
      }
          } else if (retries > 0) {
            setTimeout(() => waitForFirebaseInit(retries - 1), 150);
          } else {
            showToast('Error: Firebase not initialized', 'danger');
          }
        }
        waitForFirebaseInit();
        // Enforce authentication on this page
        enforceAuth('../../auth/login.html');
        // Setup My Listings link logic
        setupMyListingsLink('#myListingsLink', '../../auth/login.html', '../../stores/agent-stores/dashboard.html', '../../stores/agent-stores/create.html');
      });

      // Fetch and display stats
      async function fetchAndRenderStats() {
        try {
          // Listings
          const listingsSnap = await db.collection('listings').get();
          const totalListings = listingsSnap.size;
          const pendingApprovals = listingsSnap.docs.filter(doc => doc.data().adminVerification?.status === 'pending').length;
          document.getElementById('total-listings').textContent = totalListings;
          document.getElementById('pending-approvals').textContent = pendingApprovals;
          // Users
          const usersSnap = await db.collection('users').get();
          document.getElementById('total-users').textContent = usersSnap.size;
          // Stores
          const storesSnap = await db.collection('stores').get();
          document.getElementById('total-stores').textContent = storesSnap.size;
        } catch (err) {
          showToast('Error loading stats: ' + err.message, 'danger');
        }
      }

      // Fetch and render charts
      async function fetchAndRenderCharts() {
        try {
          // --- Listings Over Time: Property vs Vehicles ---
          const propertyTypes = ['house_sale', 'house_rent', 'land_sale', 'land_rent', 'vacation_short_stay'];
          const vehicleTypes = ['vehicle_sale', 'motorcycle_sale', 'heavy_machinery_sale', 'bicycle_ebike_sale', 'boat_watercraft_sale'];
          const listingsSnap = await db.collection('listings').orderBy('createdAt').get();
        const listingsByMonthCategory = {};
        listingsSnap.forEach(doc => {
            const d = doc.data();
            let date = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;
            if (!date) return;
            const key = `${date.getFullYear()}-${date.getMonth()+1}`;
            if (!listingsByMonthCategory[key]) listingsByMonthCategory[key] = { Property: 0, Vehicles: 0 };
            if (propertyTypes.includes(d.listingType)) {
                listingsByMonthCategory[key].Property++;
            } else if (vehicleTypes.includes(d.listingType)) {
                listingsByMonthCategory[key].Vehicles++;
            }
        });
        renderCompareLineChart('listingsCompareChart', listingsByMonthCategory, ['Property', 'Vehicles']);

        // --- User Registrations by Role ---
        const usersSnap = await db.collection('users').orderBy('createdAt').get();
        const usersByMonthRole = {};
        usersSnap.forEach(doc => {
            const d = doc.data();
            let date = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;
            if (!date) return;
            const key = `${date.getFullYear()}-${date.getMonth()+1}`;
            if (!usersByMonthRole[key]) usersByMonthRole[key] = {};
            usersByMonthRole[key][d.role] = (usersByMonthRole[key][d.role] || 0) + 1;
        });
        renderStackedLineChart('usersChart', usersByMonthRole, 'Users');

        // --- Stores by Agent Tier ---
        const storesSnap = await db.collection('stores').orderBy('createdAt').get();
        const storesByMonthTier = {};
        storesSnap.forEach(doc => {
            const d = doc.data();
            let date = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;
            if (!date) return;
            const key = `${date.getFullYear()}-${date.getMonth()+1}`;
            if (!storesByMonthTier[key]) storesByMonthTier[key] = {};
            storesByMonthTier[key][d.agentTier] = (storesByMonthTier[key][d.agentTier] || 0) + 1;
        });
        renderStackedLineChart('storesChart', storesByMonthTier, 'Stores');

        // --- Top Agents/Stores (by listings count) ---
        const agentCounts = {};
        listingsSnap.forEach(doc => {
            const d = doc.data();
            const agent = d.agentId || d.storeId || 'Unknown';
            agentCounts[agent] = (agentCounts[agent] || 0) + 1;
        });
        const sortedAgents = Object.entries(agentCounts).sort((a,b) => b[1]-a[1]).slice(0,8);
        await renderTopAgentsList(sortedAgents);

        // --- Daily Views Chart ---
        const analyticsSnap = await db.collection('analytics').where('type', 'in', [
            'view', 'listing_view', 'vehicle_view', 'motorcycle_view', 'heavy_machinery_view', 'bicycle_ebike_view', 'boat_watercraft_view', 'vacation_short_stay_view'
        ]).orderBy('createdAt').get();
        const viewsByDay = {};
        analyticsSnap.forEach(doc => {
            const d = doc.data();
            let date = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;
            if (!date) return;
            const key = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
            viewsByDay[key] = (viewsByDay[key] || 0) + 1;
        });
        renderDailyViewsChart('dailyViewsChart', viewsByDay);
        } catch (err) {
          console.error('Error loading charts:', err);
          showToast('Error loading charts: ' + err.message, 'danger');
        }
      }

      function renderCompareLineChart(canvasId, dataObj, categories) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = Object.keys(dataObj);
        const datasets = categories.map((cat, i) => ({
            label: cat,
            data: labels.map(l => dataObj[l][cat] || 0),
            borderColor: `hsl(${i*40},70%,50%)`,
            backgroundColor: `hsla(${i*40},70%,50%,0.1)`,
            fill: false,
            tension: 0.3
        }));
        new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: { responsive: true, plugins: { legend: { display: true } } }
        });
      }

      function renderStackedLineChart(canvasId, dataObj, label) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = Object.keys(dataObj);
        const allKeys = Array.from(new Set(labels.flatMap(l => Object.keys(dataObj[l]))));
        const datasets = allKeys.map((k, i) => ({
          label: k,
          data: labels.map(l => dataObj[l][k] || 0),
          borderColor: `hsl(${i * 40},70%,50%)`,
          backgroundColor: `hsla(${i * 40},70%,50%,0.1)`,
          fill: true,
          tension: 0.3
        }));
        new Chart(ctx, {
          type: 'line',
          data: { labels, datasets },
          options: { responsive: true, plugins: { legend: { display: true } } }
        });
      }

      function renderDailyViewsChart(canvasId, dataObj) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = Object.keys(dataObj);
        const data = labels.map(l => dataObj[l] || 0);
        new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Daily Views',
                    data,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13,110,253,0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true } } }
        });
      }

      // Helper to fetch names for agent/store IDs
      async function fetchAgentStoreNames(ids) {
        const names = {};
        // Try to fetch from users (agents)
        if (ids.length === 0) return names;
        // Firestore 'in' queries are limited to 10
        const batchSize = 10;
        for (let i = 0; i < ids.length; i += batchSize) {
          const batchIds = ids.slice(i, i + batchSize);
          const usersSnap = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', batchIds).get();
          usersSnap.forEach(doc => {
            // Use UserService to get display name with fallbacks
            if (window.userService) {
              names[doc.id] = window.userService.getDisplayName(doc.data());
            } else {
              names[doc.id] = doc.data().displayName || doc.data().name || doc.data().email || doc.id;
            }
          });
          const storesSnap = await db.collection('stores').where(firebase.firestore.FieldPath.documentId(), 'in', batchIds).get();
          storesSnap.forEach(doc => {
            names[doc.id] = doc.data().name || doc.id;
          });
        }
        ids.forEach(id => {
          if (!names[id]) names[id] = id;
        });
        return names;
      }

      async function renderTopAgentsList(sortedAgents) {
        const topIds = sortedAgents.map(x => x[0]);
        const namesMap = await fetchAgentStoreNames(topIds);
        const list = document.getElementById('topAgentsList');
        list.innerHTML = '';
        sortedAgents.forEach(([id, count]) => {
          const name = namesMap[id] || id;
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.textContent = name;
          const badge = document.createElement('span');
          badge.className = 'badge bg-primary rounded-pill';
          badge.textContent = count;
          li.appendChild(badge);
          list.appendChild(li);
        });
      }

      document.getElementById('generateReportBtn').addEventListener('click', async function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Title
        doc.setFontSize(18);
        doc.text('Starlet Analytics Report', 10, 15);

        // Add summary stats
        doc.setFontSize(12);
        doc.text('Total Listings: ' + document.getElementById('total-listings').textContent, 10, 30);
        doc.text('Total Users: ' + document.getElementById('total-users').textContent, 10, 38);
        doc.text('Total Stores: ' + document.getElementById('total-stores').textContent, 10, 46);
        doc.text('Pending Approvals: ' + document.getElementById('pending-approvals').textContent, 10, 54);

        // Helper to add chart as image
        async function addChartImage(canvasId, y) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return y;
          const imgData = canvas.toDataURL('image/png');
          doc.addImage(imgData, 'PNG', 10, y, 180, 60);
          return y + 65;
        }

        let y = 65;
        y = await addChartImage('listingsCompareChart', y);
        y = await addChartImage('usersChart', y);
        y = await addChartImage('storesChart', y);
        y = await addChartImage('dailyViewsChart', y);

        // Add Top Agents/Stores
        doc.setFontSize(14);
        doc.text('Top Agents/Stores:', 10, y + 10);
        doc.setFontSize(12);
        const list = document.getElementById('topAgentsList');
        if (list) {
          Array.from(list.children).forEach((li, i) => {
            doc.text('- ' + li.textContent, 12, y + 18 + i * 8);
          });
          y += 18 + list.children.length * 8;
        }

        doc.save('starlet-analytics-report.pdf');
      });
    </script>
</body>
</html>
