<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Stores Dashboard - Starlet Properties</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="../../css/style.css">
</head>
<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom shadow-sm bg-white">
    <div class="container">
      <a class="navbar-brand fw-bold" href="../../index.html">
        <span class="brand-star">Star</span> <span class="brand-let">Let</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="../../index.html"><i class="bi bi-house-door"></i> Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./index.html"><i class="bi bi-shop"></i> Stores</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./create.html"><i class="bi bi-plus-circle"></i> Create Store</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <section class="container py-5">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4">
      <div>
        <h2 class="fw-bold mb-1">My Stores Dashboard</h2>
        <p class="text-muted mb-0">Manage your stores and listings in one place.</p>
      </div>
      <a href="add-listing.html" class="btn btn-lg btn-primary mt-3 mt-md-0 shadow-sm"><i class="bi bi-plus-circle"></i> Add Listing</a>
    </div>
    <div class="row g-4" id="dashboardStoresList">
      <!-- Store cards will be injected here by JS -->
    </div>
  </section>

  <footer class="footer mt-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 mb-4">
          <h4>About Starlet Properties</h4>
          <p>Uganda's premier real estate and vehicle marketplace, connecting buyers and sellers across the country.</p>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Properties</h4>
          <ul>
            <li><a href="../properties/index.html?type=house_sale">Houses for Sale</a></li>
            <li><a href="../properties/index.html?type=house_rent">Houses for Rent</a></li>
            <li><a href="../properties/index.html?type=land_sale">Land for Sale</a></li>
            <li><a href="../properties/index.html?type=land_rent">Land for Rent</a></li>
            <li><a href="../properties/index.html?type=commercial">Commercial Property</a></li>
            <li><a href="../properties/index.html?type=vacation_short_stay">Vacation & Short Stay</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Vehicles</h4>
          <ul>
            <li><a href="../vehicles/index.html?type=cars">Cars</a></li>
            <li><a href="../vehicles/index.html?type=motorcycles">Motorcycles</a></li>
            <li><a href="../vehicles/index.html?type=trucks">Trucks</a></li>
            <li><a href="../vehicles/index.html?type=buses">Buses</a></li>
            <li><a href="../vehicles/index.html?type=heavy_machinery">Heavy Machinery</a></li>
            <li><a href="../vehicles/index.html?type=bicycles_ebikes">Bicycles & E-bikes</a></li>
            <li><a href="../vehicles/index.html?type=boats_watercraft">Boats & Watercraft</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Company</h4>
          <ul>
            <li><a href="../about/index.html">About Us</a></li>
            <li><a href="../about/contact.html">Contact</a></li>
            <li><a href="../about/resources.html">Resources</a></li>
            <li><a href="./index.html">Our Stores</a></li>
            <li><a href="../legal/privacy.html">Privacy Policy</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Contact</h4>
          <ul>
            <li><a href="tel:+256123456789"><i class="bi bi-telephone"></i> +256 123 456 789</a></li>
            <li><a href="mailto:info@starlet.co.ug"><i class="bi bi-envelope"></i> info@starlet.co.ug</a></li>
            <li><a href="#"><i class="bi bi-geo-alt"></i> Kampala, Uganda</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer>

  <style>
    .store-card-modern {
      background: #fff;
      border-radius: 1.25rem;
      box-shadow: 0 2px 12px 0 rgba(0,0,0,0.07);
      padding: 2rem 2rem 1.5rem 2rem;
      min-height: 320px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: box-shadow 0.2s;
      border: 1px solid #f0f0f0;
    }
    .store-card-modern:hover {
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.12);
      border-color: #e0e0e0;
    }
    .store-card-modern .rounded-circle {
      border: 3px solid #e9ecef;
    }
    .store-card-modern .badge {
      font-size: 0.95em;
      font-weight: 500;
      background: #f5f7fa;
      border: 1px solid #e9ecef;
      margin-left: 0.5em;
    }
    .store-card-modern .btn {
      min-width: 110px;
    }
    .store-card-modern .stats-row span {
      font-size: 1.05em;
      color: #555;
      opacity: 0.9;
    }
    .store-card-modern .rating-stars i {
      font-size: 1.1rem;
      margin-right: 1px;
    }
    .store-card-modern .store-status-badge {
      font-size: 0.9em;
      font-weight: 600;
      border-radius: 0.5em;
      padding: 0.2em 0.7em;
      margin-left: 0.5em;
    }
    .store-card-modern .store-status-badge.verified {
      background: #e6f7e6;
      color: #1a7f37;
      border: 1px solid #b6e2b6;
    }
    .store-card-modern .store-status-badge.pending {
      background: #fffbe6;
      color: #bfa100;
      border: 1px solid #ffe58f;
    }
    .store-card-modern .store-status-badge.rejected {
      background: #fff0f0;
      color: #d32f2f;
      border: 1px solid #ffcdd2;
    }
    .store-card-modern .store-status-badge.default {
      background: #f0f0f0;
      color: #888;
      border: 1px solid #e0e0e0;
    }
    .store-card-modern .listings-section {
      background: #f8f9fa;
      border-radius: 0.75rem;
      padding: 1.2rem 1rem;
      margin-top: 1rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .store-card-modern .list-group-item {
      border: none;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.03);
    }
    @media (max-width: 768px) {
      .store-card-modern {
        padding: 1.2rem 0.7rem 1rem 0.7rem;
      }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="../../assets/js/firebase-config.js"></script>
  <script>
// --- Store Management Dashboard ---
function renderDashboardStores(listings) {
  const container = document.getElementById('dashboardStoresList');
  container.innerHTML = '';
  if (!listings.length) {
    container.innerHTML = '<div class="col-12 text-center text-muted py-5">You have not created any stores yet.</div>';
    return;
  }
  listings.forEach((store, idx) => {
    const card = document.createElement('div');
    card.className = 'col-md-6 col-lg-4 mb-4';
    // Store profile
    const agentTier = store.agentTier || 'silver';
    const verification = store.verificationStatus?.status || 'pending';
    const subscription = store.subscriptionStatus || 'active';
    const year = store.createdAt ? new Date(store.createdAt.seconds ? store.createdAt.seconds * 1000 : store.createdAt).getFullYear() : '';
    // Stats
    const listingsCount = store.listingsCount || 0;
    const reviewCount = store.reviewCount || 0;
    const avgRating = store.averageRating || 0;
    const recentReviews = store.recentReviews || [];
    // Agent profile (dummy, to be fetched if needed)
    // Analytics (dummy, to be fetched if needed)
    // Card inner HTML
    card.innerHTML = `
      <div class="store-card-modern d-flex flex-column shadow-sm border-0 rounded-4 p-3 bg-white h-100 gap-2">
        <div class="d-flex align-items-center gap-3 mb-2">
          <img src="${store.logo || 'https://via.placeholder.com/90?text=Logo'}" alt="${store.name}" class="rounded-circle border border-2" style="width:64px;height:64px;object-fit:cover;">
          <div class="flex-grow-1">
            <span class="fw-semibold text-dark small">${store.name}</span>
            <span class="badge bg-light text-secondary border ms-2 px-2 py-1 small text-uppercase">${agentTier}</span>
            <span class="store-status-badge ${verification}">${verification.charAt(0).toUpperCase() + verification.slice(1)}</span>
            <span class="badge bg-info ms-2">${subscription.charAt(0).toUpperCase() + subscription.slice(1)}</span>
            <div class="d-flex align-items-center gap-1 mt-1">
              <span class="rating-stars">${'★'.repeat(Math.round(avgRating))}${'☆'.repeat(5-Math.round(avgRating))}</span>
              <span class="text-muted small ms-1">${avgRating.toFixed(1)}</span>
            </div>
          </div>
        </div>
        <div class="text-muted small mb-2" style="min-height:2.2em;">${store.description || ''}</div>
        <div class="d-flex align-items-center gap-3 mb-2 stats-row">
          <span class="text-secondary small"><i class="bi bi-list-ul"></i> ${listingsCount} Listings</span>
          <span class="text-secondary small"><i class="bi bi-graph-up"></i> ${reviewCount} Reviews</span>
          <span class="text-secondary small"><i class="bi bi-calendar3"></i> ${year}</span>
        </div>
        <div class="mb-2">
          <strong>Recent Reviews:</strong>
          ${recentReviews.length ? recentReviews.map(r => `<div class='border rounded p-2 mb-1'><span class='text-warning'>${'★'.repeat(r.rating)}${'☆'.repeat(5-r.rating)}</span> <span class='text-muted small'>${r.comment || ''}</span><br><span class='text-muted small'>${r.createdAt ? new Date(r.createdAt.seconds ? r.createdAt.seconds * 1000 : r.createdAt).toLocaleDateString() : ''}</span></div>`).join('') : '<span class="text-muted small">No reviews yet.</span>'}
        </div>
        <div class="d-flex gap-2 flex-wrap mb-2">
          <a href="details.html?id=${store.id || store._id}" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i> View</a>
          <button class="btn btn-sm btn-outline-success" onclick="editStore('${store.id || store._id}')"><i class="bi bi-pencil"></i> Edit</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteStore('${store.id || store._id}', '${store.name}')"><i class="bi bi-trash"></i> Delete</button>
          <button class="btn btn-sm btn-primary" onclick="manageListings('${store.id || store._id}', '${store.name}')"><i class="bi bi-list-task"></i> Manage Listings</button>
        </div>
        <div id="listingsSection-${store.id || store._id}" style="display:none;"></div>
      </div>
    `;
    container.appendChild(card);
  });
}

// Edit Store (placeholder)
function editStore(storeId) {
  alert('Edit store: ' + storeId + '\n(To implement: open edit modal or page)');
}
// Delete Store with confirmation
async function deleteStore(storeId, storeName) {
  if (!confirm(`Are you sure you want to delete the store "${storeName}"? This cannot be undone.`)) return;
  try {
    await window.firebaseDB.collection('stores').doc(storeId).delete();
    alert('Store deleted.');
    loadUserStores();
  } catch (err) {
    alert('Error deleting store.');
    console.error('Delete store error:', err);
  }
}
// Manage Listings: Show all listings for this store
async function manageListings(storeId, storeName) {
  const section = document.getElementById('listingsSection-' + storeId);
  if (!section) return;
  if (section.style.display === 'block') {
    section.style.display = 'none';
    section.innerHTML = '';
    return;
  }
  section.style.display = 'block';
  section.innerHTML = '<div class="text-center py-3"><div class="spinner-border"></div> Loading listings...</div>';
  try {
    const snap = await window.firebaseDB.collection('listings').where('storeId', '==', storeId).get();
    let html = `<div class='mb-2 d-flex justify-content-between align-items-center'><strong>Listings for ${storeName}</strong><button class='btn btn-sm btn-success' onclick='addListing("${storeId}")'><i class='bi bi-plus-circle'></i> Add Listing</button></div>`;
    if (snap.empty) {
      html += '<div class="text-muted">No listings found for this store.</div>';
    } else {
      html += '<ul class="list-group mb-2">';
      snap.forEach(doc => {
        const l = doc.data();
        html += `<li class='list-group-item d-flex justify-content-between align-items-center'>
          <span>${l.title || 'Untitled'} <span class='badge bg-light text-secondary ms-2'>${l.status || ''}</span></span>
          <span>
            <button class='btn btn-sm btn-outline-success' onclick='editListing("${doc.id}")'><i class='bi bi-pencil'></i></button>
            <button class='btn btn-sm btn-outline-danger' onclick='deleteListing("${doc.id}", "${l.title || 'Untitled'}", "${storeId}")'><i class='bi bi-trash'></i></button>
          </span>
        </li>`;
      });
      html += '</ul>';
    }
    section.innerHTML = html;
  } catch (err) {
    section.innerHTML = '<div class="text-danger">Error loading listings.</div>';
    console.error('Error loading listings:', err);
  }
}
// Add Listing Modal
const addListingModalHtml = `
<div class="modal fade" id="addListingModal" tabindex="-1" aria-labelledby="addListingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addListingModalLabel">Add Listing</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addListingForm">
          <input type="hidden" id="addListingStoreId">
          <div class="mb-3">
            <label for="listingTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="listingTitle" required>
          </div>
          <div class="mb-3">
            <label for="listingDescription" class="form-label">Description</label>
            <textarea class="form-control" id="listingDescription" rows="3" required></textarea>
          </div>
          <div class="mb-3">
            <label for="listingPrice" class="form-label">Price (UGX)</label>
            <input type="number" class="form-control" id="listingPrice" required min="0">
          </div>
          <div class="mb-3">
            <label for="listingType" class="form-label">Type</label>
            <select class="form-select" id="listingType" required>
              <option value="">Select type</option>
              <option value="house_sale">House for Sale</option>
              <option value="house_rent">House for Rent</option>
              <option value="land_sale">Land for Sale</option>
              <option value="land_rent">Land for Rent</option>
              <option value="vehicle_sale">Vehicle for Sale</option>
              <option value="motorcycle_sale">Motorcycle for Sale</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary w-100">Add Listing</button>
        </form>
      </div>
    </div>
  </div>
</div>`;
if (!document.getElementById('addListingModal')) {
  document.body.insertAdjacentHTML('beforeend', addListingModalHtml);
}

// Add Listing (show modal)
function addListing(storeId) {
  document.getElementById('addListingStoreId').value = storeId;
  document.getElementById('addListingForm').reset();
  const modal = new bootstrap.Modal(document.getElementById('addListingModal'));
  modal.show();
}
// Handle Add Listing form submit
if (!window._addListingFormHandlerAttached) {
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('addListingForm');
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const user = window.firebaseAuth.currentUser;
        if (!user) {
          alert('You must be logged in.');
          return;
        }
        const storeId = document.getElementById('addListingStoreId').value;
        const title = document.getElementById('listingTitle').value;
        const description = document.getElementById('listingDescription').value;
        const price = parseInt(document.getElementById('listingPrice').value, 10);
        const type = document.getElementById('listingType').value;
        try {
          await window.firebaseDB.collection('listings').add({
            title,
            description,
            price,
            type,
            storeId,
            agentId: user.uid,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          bootstrap.Modal.getInstance(document.getElementById('addListingModal')).hide();
          alert('Listing added!');
          manageListings(storeId, '');
        } catch (err) {
          alert('Error adding listing: ' + err.message);
        }
      });
    }
  });
  window._addListingFormHandlerAttached = true;
}
// Edit Listing (placeholder)
function editListing(listingId) {
  alert('Edit listing: ' + listingId + '\n(To implement: open edit listing modal or page)');
}
// Delete Listing with confirmation
async function deleteListing(listingId, title, storeId) {
  if (!confirm(`Are you sure you want to delete the listing "${title}"? This cannot be undone.`)) return;
  try {
    await window.firebaseDB.collection('listings').doc(listingId).delete();
    alert('Listing deleted.');
    manageListings(storeId, '');
  } catch (err) {
    alert('Error deleting listing.');
    console.error('Delete listing error:', err);
  }
}

async function loadUserStores() {
  if (!window.firebaseAuth || !window.firebaseDB) {
    setTimeout(loadUserStores, 300);
    return;
  }
  window.firebaseAuth.onAuthStateChanged(async function(user) {
    if (!user) {
      document.getElementById('dashboardStoresList').innerHTML = '<div class="col-12 text-center text-muted py-5">Please <a href="../auth/login.html">log in</a> to view your stores.</div>';
      return;
    }
    // Query Firestore for stores where agentId == user.uid
    try {
      const snap = await window.firebaseDB.collection('stores').where('agentId', '==', user.uid).get();
      const stores = [];
      snap.forEach(doc => {
        const data = doc.data();
        data.id = doc.id;
        stores.push(data);
      });
      renderDashboardStores(stores);
    } catch (err) {
      document.getElementById('dashboardStoresList').innerHTML = '<div class="col-12 text-center text-danger py-5">Error loading your stores.</div>';
      console.error('Error loading user stores:', err);
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  loadUserStores();
});
  </script>
</body>
</html> 