<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Stores Dashboard - Starlet Properties</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
      <a class="navbar-brand" href="../../index.html">
        <span class="brand-star">Star</span> <span class="brand-let">Let</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="../../index.html"><i class="bi bi-house-door"></i> Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./index.html"><i class="bi bi-shop"></i> Stores</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./create.html"><i class="bi bi-plus-circle"></i> Create Store</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <section class="container py-5">
    <h2 class="mb-4">My Stores Dashboard</h2>
    <div class="row" id="dashboardStoresList">
      <!-- Store cards will be injected here by JS -->
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 mb-4">
          <h4>About Starlet Properties</h4>
          <p>Uganda's premier real estate and vehicle marketplace, connecting buyers and sellers across the country.</p>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Properties</h4>
          <ul>
            <li><a href="../properties/index.html?type=house_sale">Houses for Sale</a></li>
            <li><a href="../properties/index.html?type=house_rent">Houses for Rent</a></li>
            <li><a href="../properties/index.html?type=land_sale">Land for Sale</a></li>
            <li><a href="../properties/index.html?type=land_rent">Land for Rent</a></li>
            <li><a href="../properties/index.html?type=commercial">Commercial Property</a></li>
            <li><a href="../properties/index.html?type=vacation_short_stay">Vacation & Short Stay</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Vehicles</h4>
          <ul>
            <li><a href="../vehicles/index.html?type=cars">Cars</a></li>
            <li><a href="../vehicles/index.html?type=motorcycles">Motorcycles</a></li>
            <li><a href="../vehicles/index.html?type=trucks">Trucks</a></li>
            <li><a href="../vehicles/index.html?type=buses">Buses</a></li>
            <li><a href="../vehicles/index.html?type=heavy_machinery">Heavy Machinery</a></li>
            <li><a href="../vehicles/index.html?type=bicycles_ebikes">Bicycles & E-bikes</a></li>
            <li><a href="../vehicles/index.html?type=boats_watercraft">Boats & Watercraft</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Company</h4>
          <ul>
            <li><a href="../about/index.html">About Us</a></li>
            <li><a href="../about/contact.html">Contact</a></li>
            <li><a href="../about/resources.html">Resources</a></li>
            <li><a href="./index.html">Our Stores</a></li>
            <li><a href="../legal/privacy.html">Privacy Policy</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4">
          <h4>Contact</h4>
          <ul>
            <li><a href="tel:+256123456789"><i class="bi bi-telephone"></i> +256 123 456 789</a></li>
            <li><a href="mailto:info@starlet.co.ug"><i class="bi bi-envelope"></i> info@starlet.co.ug</a></li>
            <li><a href="#"><i class="bi bi-geo-alt"></i> Kampala, Uganda</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="../../assets/js/firebase-config.js"></script>
  <script>
// --- Store Management Dashboard ---
function renderDashboardStores(listings) {
  const container = document.getElementById('dashboardStoresList');
  container.innerHTML = '';
  if (!listings.length) {
    container.innerHTML = '<div class="col-12 text-center text-muted py-5">You have not created any stores yet.</div>';
    return;
  }
  listings.forEach((store, idx) => {
    const card = document.createElement('div');
    card.className = 'col-md-6 col-lg-4 mb-4';
    // Star rating HTML
    const fullStars = Math.floor(store.averageRating || 0);
    const halfStar = (store.averageRating || 0) % 1 >= 0.25 && (store.averageRating || 0) % 1 < 0.75;
    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
    let starsHtml = '';
    for (let i = 0; i < fullStars; i++) starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
    if (halfStar) starsHtml += '<i class="bi bi-star-half text-warning"></i>';
    for (let i = 0; i < emptyStars; i++) starsHtml += '<i class="bi bi-star text-warning"></i>';
    // Verification badge
    const verifiedBadge = store.verificationStatus && store.verificationStatus.status === 'verified'
      ? '<i class="bi bi-patch-check-fill text-primary" title="Verified"></i>' : '';
    // Store stats
    const statsHtml = `
      <div class="d-flex align-items-center gap-3 mb-2 stats-row">
        <span class="text-secondary small"><i class="bi bi-list-ul"></i> ${store.listingsCount || 0} Listings</span>
        <span class="text-secondary small"><i class="bi bi-graph-up"></i> ${store.reviewCount || 0} Reviews</span>
        <span class="text-secondary small"><i class="bi bi-calendar3"></i> ${store.createdAt ? new Date(store.createdAt.seconds ? store.createdAt.seconds * 1000 : store.createdAt).getFullYear() : ''}</span>
      </div>`;
    // Card inner HTML
    card.innerHTML = `
      <div class="store-card-modern d-flex flex-column shadow-sm border-0 rounded-4 p-3 bg-white h-100 gap-2">
        <div class="d-flex align-items-center gap-3 mb-2">
          <img src="${store.logo || 'https://via.placeholder.com/90?text=Logo'}" alt="${store.name}" class="rounded-circle border border-2" style="width:64px;height:64px;object-fit:cover;">
          <div class="flex-grow-1">
            <span class="fw-semibold text-dark small">${store.name}</span> ${verifiedBadge}
            <span class="badge bg-light text-secondary border ms-2 px-2 py-1 small">${store.agentTier || ''}</span>
            <div class="d-flex align-items-center gap-1 mt-1">
              <span class="rating-stars">${starsHtml}</span>
              <span class="text-muted small ms-1">${(store.averageRating || 0).toFixed(1)}</span>
            </div>
          </div>
        </div>
        <div class="text-muted small mb-2" style="min-height:2.2em;">${store.description || ''}</div>
        ${statsHtml}
        <div class="d-flex gap-2 flex-wrap mb-2">
          <a href="details.html?id=${store.id || store._id}" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i> View</a>
          <button class="btn btn-sm btn-outline-success" onclick="editStore('${store.id || store._id}')"><i class="bi bi-pencil"></i> Edit</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteStore('${store.id || store._id}', '${store.name}')"><i class="bi bi-trash"></i> Delete</button>
          <button class="btn btn-sm btn-primary" onclick="manageListings('${store.id || store._id}', '${store.name}')"><i class="bi bi-list-task"></i> Manage Listings</button>
        </div>
        <div id="listingsSection-${store.id || store._id}" style="display:none;"></div>
      </div>
    `;
    container.appendChild(card);
  });
}

// Edit Store (placeholder)
function editStore(storeId) {
  alert('Edit store: ' + storeId + '\n(To implement: open edit modal or page)');
}
// Delete Store with confirmation
async function deleteStore(storeId, storeName) {
  if (!confirm(`Are you sure you want to delete the store "${storeName}"? This cannot be undone.`)) return;
  try {
    await window.firebaseDB.collection('stores').doc(storeId).delete();
    alert('Store deleted.');
    loadUserStores();
  } catch (err) {
    alert('Error deleting store.');
    console.error('Delete store error:', err);
  }
}
// Manage Listings: Show all listings for this store
async function manageListings(storeId, storeName) {
  const section = document.getElementById('listingsSection-' + storeId);
  if (!section) return;
  if (section.style.display === 'block') {
    section.style.display = 'none';
    section.innerHTML = '';
    return;
  }
  section.style.display = 'block';
  section.innerHTML = '<div class="text-center py-3"><div class="spinner-border"></div> Loading listings...</div>';
  try {
    const snap = await window.firebaseDB.collection('listings').where('storeId', '==', storeId).get();
    let html = `<div class='mb-2 d-flex justify-content-between align-items-center'><strong>Listings for ${storeName}</strong><button class='btn btn-sm btn-success' onclick='addListing("${storeId}")'><i class='bi bi-plus-circle'></i> Add Listing</button></div>`;
    if (snap.empty) {
      html += '<div class="text-muted">No listings found for this store.</div>';
    } else {
      html += '<ul class="list-group mb-2">';
      snap.forEach(doc => {
        const l = doc.data();
        html += `<li class='list-group-item d-flex justify-content-between align-items-center'>
          <span>${l.title || 'Untitled'} <span class='badge bg-light text-secondary ms-2'>${l.status || ''}</span></span>
          <span>
            <button class='btn btn-sm btn-outline-success' onclick='editListing("${doc.id}")'><i class='bi bi-pencil'></i></button>
            <button class='btn btn-sm btn-outline-danger' onclick='deleteListing("${doc.id}", "${l.title || 'Untitled'}", "${storeId}")'><i class='bi bi-trash'></i></button>
          </span>
        </li>`;
      });
      html += '</ul>';
    }
    section.innerHTML = html;
  } catch (err) {
    section.innerHTML = '<div class="text-danger">Error loading listings.</div>';
    console.error('Error loading listings:', err);
  }
}
// Add Listing (placeholder)
function addListing(storeId) {
  alert('Add listing for store: ' + storeId + '\n(To implement: open add listing modal or page)');
}
// Edit Listing (placeholder)
function editListing(listingId) {
  alert('Edit listing: ' + listingId + '\n(To implement: open edit listing modal or page)');
}
// Delete Listing with confirmation
async function deleteListing(listingId, title, storeId) {
  if (!confirm(`Are you sure you want to delete the listing "${title}"? This cannot be undone.`)) return;
  try {
    await window.firebaseDB.collection('listings').doc(listingId).delete();
    alert('Listing deleted.');
    manageListings(storeId, '');
  } catch (err) {
    alert('Error deleting listing.');
    console.error('Delete listing error:', err);
  }
}

async function loadUserStores() {
  if (!window.firebaseAuth || !window.firebaseDB) {
    setTimeout(loadUserStores, 300);
    return;
  }
  window.firebaseAuth.onAuthStateChanged(async function(user) {
    if (!user) {
      document.getElementById('dashboardStoresList').innerHTML = '<div class="col-12 text-center text-muted py-5">Please <a href="../auth/login.html">log in</a> to view your stores.</div>';
      return;
    }
    // Query Firestore for stores where agentId == user.uid
    try {
      const snap = await window.firebaseDB.collection('stores').where('agentId', '==', user.uid).get();
      const stores = [];
      snap.forEach(doc => {
        const data = doc.data();
        data.id = doc.id;
        stores.push(data);
      });
      renderDashboardStores(stores);
    } catch (err) {
      document.getElementById('dashboardStoresList').innerHTML = '<div class="col-12 text-center text-danger py-5">Error loading your stores.</div>';
      console.error('Error loading user stores:', err);
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  loadUserStores();
});
  </script>
</body>
</html> 