<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Premium Services</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    .tier-card {
      box-shadow: 0 2px 12px rgba(0,0,0,0.07), 0 1.5px 4px rgba(0,0,0,0.04);
      transition: transform 0.2s, box-shadow 0.2s;
      border: 2px solid transparent;
      background: #fff;
      position: relative;
    }
    .tier-card:hover {
      transform: translateY(-4px) scale(1.03);
      box-shadow: 0 6px 24px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.08);
      z-index: 2;
    }
    .tier-header.silver { color: #6c757d; font-weight: 600; font-size: 1.2rem; }
    .tier-header.gold { color: #bfa100; font-weight: 700; font-size: 1.3rem; }
    .tier-header.diamond { color: #007bff; font-weight: 700; font-size: 1.3rem; }
    .tier-card.current {
      border: 3px solid #198754;
      box-shadow: 0 8px 32px rgba(25,135,84,0.15);
    }
    .tier-card .checkmark {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 1.5rem;
      color: #198754;
    }
    /* Ensure modal is above navbar */
    .modal-backdrop { z-index: 1050 !important; }
    .modal { z-index: 1060 !important; }
    .modal-dialog { margin-top: 10vh; }
  </style>
</head>
<body class="admin-panel">
  <aside class="admin-sidebar">
    <div class="sidebar-brand"><span class="brand-star">★</span> Starlet <span class="brand-let">Let</span></div>
    <nav class="nav flex-column">
      <a class="nav-link" href="profile.html"><i class="bi bi-person"></i> Store Profile</a>
      <a class="nav-link" href="dashboard.html"><i class="bi bi-house"></i> Dashboard</a>
      <a class="nav-link" href="edit-profile.html"><i class="bi bi-pencil"></i> Edit Profile</a>
      <a class="nav-link" href="add-listing.html"><i class="bi bi-plus"></i> Add Listing</a>
      <a class="nav-link" href="analytics.html"><i class="bi bi-bar-chart"></i> Analytics</a>
      <a class="nav-link active" href="premium.html"><i class="bi bi-gem"></i> Premium Services</a>
      <a class="nav-link" href="messages.html"><i class="bi bi-chat-dots"></i> Messages</a>
      <a class="logout-link" href="#"><i class="bi bi-box-arrow-right"></i> Logout</a>
    </nav>
  </aside>
  <nav class="admin-navbar">
    <div class="navbar-brand"><span class="brand-star">★</span> Premium Services</div>
  </nav>
  <main class="container" style="margin-top: 80px;">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card p-4 mt-4">
          <h3 class="mb-3">Agent Tier Subscription</h3>
          <!-- Current Tier Status -->
          <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
            <i class="bi bi-person-badge me-2"></i>
            <div>
              <strong>Current Tier:</strong> <span class="badge bg-warning text-dark">Gold</span><br>
              <strong>Subscription Ends:</strong> <span id="tierExpiry">2025-08-31</span>
              <button class="btn btn-outline-primary btn-sm ms-3" data-bs-toggle="modal" data-bs-target="#upgradeModal">Upgrade/Renew</button>
            </div>
          </div>
          <!-- Tiers Overview -->
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <div class="tier-card text-center p-3 border border-secondary rounded" id="silverCard">
                <div class="tier-header silver mb-2"><i class="bi bi-star"></i> Silver</div>
                <ul class="tier-content list-unstyled">
                  <li>Basic analytics</li>
                  <li>Standard support</li>
                  <li>Up to 10 listings</li>
                </ul>
                <span class="badge bg-secondary">UGX 30,000/mo</span>
              </div>
            </div>
            <div class="col-md-4">
              <div class="tier-card text-center p-3 border border-warning rounded border-3" id="goldCard">
                <div class="tier-header gold mb-2"><i class="bi bi-gem"></i> Gold</div>
                <ul class="tier-content list-unstyled">
                  <li>Advanced analytics</li>
                  <li>Priority support</li>
                  <li>Up to 50 listings</li>
                  <li>Featured ad slots</li>
                </ul>
                <span class="badge bg-warning text-dark">UGX 70,000/mo</span>
              </div>
            </div>
            <div class="col-md-4">
              <div class="tier-card text-center p-3 border border-primary rounded border-3" id="diamondCard">
                <div class="tier-header diamond mb-2"><i class="bi bi-diamond"></i> Diamond</div>
                <ul class="tier-content list-unstyled">
                  <li>All Gold features</li>
                  <li>Unlimited listings</li>
                  <li>Store branding</li>
                  <li>Dedicated account manager</li>
                </ul>
                <span class="badge bg-primary">UGX 150,000/mo</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Upgrade/Renew Modal -->
    <div class="modal fade" id="upgradeModal" tabindex="-1" aria-labelledby="upgradeModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="upgradeModalLabel">Upgrade or Renew Subscription</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="upgradeForm">
              <div class="mb-3">
                <label for="tierSelect" class="form-label">Choose Tier</label>
                <select class="form-select" id="tierSelect">
                  <option value="Silver">Silver - UGX 30,000/mo</option>
                  <option value="Gold" selected>Gold - UGX 70,000/mo</option>
                  <option value="Diamond">Diamond - UGX 150,000/mo</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="months" class="form-label">Months</label>
                <input type="number" class="form-control" id="months" value="1" min="1" max="12">
              </div>
              <div class="mb-3">
                <label class="form-label">Total</label>
                <div id="totalAmount" class="fw-bold">UGX 70,000</div>
              </div>
              <button type="submit" class="btn btn-primary w-100">Confirm & Pay</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="/assets/js/firebase-config.js"></script>
  <script>
    // --- Firestore Integration ---
    let currentUser = null;
    let agentTier = 'Gold'; // fallback
    let agentExpiry = '2025-08-31'; // fallback
    const tierPrices = { Silver: 30000, Gold: 70000, Diamond: 150000 };
    const tierSelect = document.getElementById('tierSelect');
    const monthsInput = document.getElementById('months');
    const totalAmount = document.getElementById('totalAmount');
    const tierExpiry = document.getElementById('tierExpiry');
    const silverCard = document.getElementById('silverCard');
    const goldCard = document.getElementById('goldCard');
    const diamondCard = document.getElementById('diamondCard');

    function updateTotal() {
      const tier = tierSelect.value;
      const months = parseInt(monthsInput.value) || 1;
      totalAmount.textContent = 'UGX ' + (tierPrices[tier] * months).toLocaleString();
    }
    if (tierSelect && monthsInput) {
      tierSelect.addEventListener('change', updateTotal);
      monthsInput.addEventListener('input', updateTotal);
    }
    updateTotal();

    // --- Auth and Firestore fetch ---
    function highlightCurrentTier(tier) {
      [silverCard, goldCard, diamondCard].forEach(card => {
        card.classList.remove('current');
        const check = card.querySelector('.checkmark');
        if (check) check.remove();
      });
      if (tier === 'Silver') {
        silverCard.classList.add('current');
        silverCard.insertAdjacentHTML('beforeend', '<span class="checkmark"><i class="bi bi-check-circle-fill"></i></span>');
      } else if (tier === 'Gold') {
        goldCard.classList.add('current');
        goldCard.insertAdjacentHTML('beforeend', '<span class="checkmark"><i class="bi bi-check-circle-fill"></i></span>');
      } else if (tier === 'Diamond') {
        diamondCard.classList.add('current');
        diamondCard.insertAdjacentHTML('beforeend', '<span class="checkmark"><i class="bi bi-check-circle-fill"></i></span>');
      }
    }

    function showTierStatus(tier, expiry) {
      document.querySelector('.alert-info .badge').textContent = tier;
      tierExpiry.textContent = expiry;
      highlightCurrentTier(tier);
      tierSelect.value = tier;
      updateTotal();
    }

    function fetchAgentTier() {
      if (!firebase.auth().currentUser) return;
      const uid = firebase.auth().currentUser.uid;
      firebase.firestore().collection('agentTiers').doc(uid).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          agentTier = data.tier || 'Silver';
          agentExpiry = data.expiry || '2025-08-31';
        }
        showTierStatus(agentTier, agentExpiry);
      }).catch(() => {
        showTierStatus(agentTier, agentExpiry);
      });
    }

    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = '/pages/auth/login.html';
        return;
      }
      currentUser = user;
      fetchAgentTier();
    });

    // --- Upgrade/Renew logic ---
    document.getElementById('upgradeForm').onsubmit = function(e) {
      e.preventDefault();
      if (!currentUser) return alert('Not authenticated.');
      const tier = tierSelect.value;
      const months = parseInt(monthsInput.value) || 1;
      const now = new Date();
      let expiry = agentExpiry;
      // If upgrading, start from now; if renewing, extend from current expiry
      if (tier !== agentTier || new Date(agentExpiry) < now) {
        // New tier or expired: start from now
        const newExpiry = new Date(now.setMonth(now.getMonth() + months));
        expiry = newExpiry.toISOString().slice(0,10);
      } else {
        // Renew: extend from current expiry
        const newExpiry = new Date(agentExpiry);
        newExpiry.setMonth(newExpiry.getMonth() + months);
        expiry = newExpiry.toISOString().slice(0,10);
      }
      firebase.firestore().collection('agentTiers').doc(currentUser.uid).set({
        tier,
        expiry
      }).then(() => {
        agentTier = tier;
        agentExpiry = expiry;
        showTierStatus(agentTier, agentExpiry);
        alert('Subscription updated!');
        const modal = bootstrap.Modal.getInstance(document.getElementById('upgradeModal'));
        if (modal) modal.hide();
      }).catch(() => {
        alert('Failed to update subscription.');
      });
    };
  </script>
</body>
</html> 