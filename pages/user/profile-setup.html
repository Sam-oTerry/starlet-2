<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Profile - Starlet Properties</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --accent-gold: #ffd700;
            --accent-cyan: #00ffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        .profile-setup-container {
            max-width: 800px;
            margin: 2rem auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .setup-header {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
        }

        .setup-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .setup-header h1 {
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .setup-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .progress-container {
            background: white;
            padding: 2rem;
            border-bottom: 1px solid #e9ecef;
        }

        .progress-step {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-step:last-child {
            margin-bottom: 0;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-color);
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 1rem;
            transition: all 0.3s ease;
        }

        .step-number.active {
            background: var(--primary-color);
            color: white;
        }

        .step-number.completed {
            background: var(--success-color);
            color: white;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.25rem;
        }

        .step-description {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        .form-container {
            padding: 2rem;
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: #fafbfc;
        }

        .form-section h3 {
            color: var(--dark-color);
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .form-section h3 i {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }

        .form-label {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(13, 110, 253, 0.3);
        }

        .btn-secondary {
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
        }

        .avatar-upload {
            text-align: center;
            padding: 2rem;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-upload:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }

        .avatar-upload i {
            font-size: 3rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem;
            border: 3px solid var(--primary-color);
            display: none;
        }

        .alert {
            border-radius: 10px;
            border: none;
        }

        .alert-success {
            background: linear-gradient(135deg, var(--success-color), #146c43);
            color: white;
        }

        .alert-danger {
            background: linear-gradient(135deg, var(--danger-color), #b02a37);
            color: white;
        }

        .loading-spinner {
            display: none;
        }

        .loading-spinner.show {
            display: inline-block;
        }

        @media (max-width: 768px) {
            .profile-setup-container {
                margin: 1rem;
                border-radius: 15px;
            }
            
            .setup-header {
                padding: 2rem 1rem;
            }
            
            .setup-header h1 {
                font-size: 2rem;
            }
            
            .form-container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="profile-setup-container">
                         <!-- Header -->
             <div class="setup-header">
                 <h1><i class="bi bi-person-plus me-3"></i>Complete Your Profile</h1>
                 <p>Welcome! Let's complete your profile to unlock all features</p>
             </div>

            <!-- Progress Indicator -->
            <div class="progress-container">
                <div class="progress-step">
                    <div class="step-number active" id="step1Number">1</div>
                    <div class="step-content">
                        <div class="step-title">Basic Information</div>
                        <div class="step-description">Personal details and contact information</div>
                    </div>
                </div>
                <div class="progress-step">
                    <div class="step-number" id="step2Number">2</div>
                    <div class="step-content">
                        <div class="step-title">Preferences</div>
                        <div class="step-description">Your interests and preferences</div>
                    </div>
                </div>
                <div class="progress-step">
                    <div class="step-number" id="step3Number">3</div>
                    <div class="step-content">
                        <div class="step-title">Verification</div>
                        <div class="step-description">Verify your information</div>
                    </div>
                </div>
            </div>

            <!-- Form Container -->
            <div class="form-container">
                <form id="profileSetupForm">
                    <!-- Step 1: Basic Information -->
                    <div id="step1" class="form-step">
                        <div class="form-section">
                            <h3><i class="bi bi-person-circle"></i>Personal Information</h3>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="firstName" class="form-label">First Name *</label>
                                    <input type="text" class="form-control" id="firstName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="lastName" class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" id="lastName" required>
                                </div>
                            </div>
                                                         <div class="row">
                                 <div class="col-md-6 mb-3">
                                     <label for="phone" class="form-label">Phone Number *</label>
                                     <input type="tel" class="form-control" id="phone" required>
                                     <div class="invalid-feedback">
                                         Please enter a valid phone number.
                                     </div>
                                 </div>
                                 <div class="col-md-6 mb-3">
                                     <label for="email" class="form-label">Email Address *</label>
                                     <input type="email" class="form-control" id="email" required readonly>
                                 </div>
                             </div>
                            <div class="mb-3">
                                <label for="dateOfBirth" class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="dateOfBirth">
                            </div>
                        </div>

                        <div class="form-section">
                            <h3><i class="bi bi-geo-alt"></i>Location Information</h3>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="district" class="form-label">District *</label>
                                    <select class="form-select" id="district" required>
                                        <option value="">Select District</option>
                                        <option value="Kampala">Kampala</option>
                                        <option value="Gulu">Gulu</option>
                                        <option value="Mbarara">Mbarara</option>
                                        <option value="Arua">Arua</option>
                                        <option value="Mbale">Mbale</option>
                                        <option value="Jinja">Jinja</option>
                                        <option value="Entebbe">Entebbe</option>
                                        <option value="Lira">Lira</option>
                                        <option value="Soroti">Soroti</option>
                                        <option value="Kabale">Kabale</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="neighborhood" class="form-label">Neighborhood</label>
                                    <input type="text" class="form-control" id="neighborhood" placeholder="Enter your neighborhood">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="address" class="form-label">Full Address</label>
                                <textarea class="form-control" id="address" rows="3" placeholder="Enter your complete address"></textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3><i class="bi bi-camera"></i>Profile Photo</h3>
                            <div class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
                                <img id="avatarPreview" class="avatar-preview" alt="Profile Preview">
                                <i class="bi bi-camera" id="avatarIcon"></i>
                                <p class="mb-0">Click to upload profile photo</p>
                                <small class="text-muted">Recommended: Square image, max 5MB</small>
                                <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Preferences -->
                    <div id="step2" class="form-step" style="display: none;">
                        <div class="form-section">
                            <h3><i class="bi bi-heart"></i>Interests & Preferences</h3>
                            <div class="mb-3">
                                <label class="form-label">What are you looking for? *</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="interestBuy" value="buy">
                                            <label class="form-check-label" for="interestBuy">
                                                Buy Property
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="interestRent" value="rent">
                                            <label class="form-check-label" for="interestRent">
                                                Rent Property
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="interestSell" value="sell">
                                            <label class="form-check-label" for="interestSell">
                                                Sell Property
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="interestVehicle" value="vehicle">
                                            <label class="form-check-label" for="interestVehicle">
                                                Buy/Sell Vehicles
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="interestInvest" value="invest">
                                            <label class="form-check-label" for="interestInvest">
                                                Investment Opportunities
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="interestAgent" value="agent">
                                            <label class="form-check-label" for="interestAgent">
                                                Become an Agent
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3><i class="bi bi-gear"></i>Communication Preferences</h3>
                            <div class="mb-3">
                                <label class="form-label">How would you like to be contacted? *</label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="contactEmail" value="email" checked>
                                    <label class="form-check-label" for="contactEmail">
                                        Email
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="contactPhone" value="phone" checked>
                                    <label class="form-check-label" for="contactPhone">
                                        Phone/SMS
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="contactWhatsApp" value="whatsapp">
                                    <label class="form-check-label" for="contactWhatsApp">
                                        WhatsApp
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Notification Preferences</label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="notifyNewListings" value="new_listings" checked>
                                    <label class="form-check-label" for="notifyNewListings">
                                        New listings matching your criteria
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="notifyPriceChanges" value="price_changes" checked>
                                    <label class="form-check-label" for="notifyPriceChanges">
                                        Price changes on saved listings
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="notifyMessages" value="messages" checked>
                                    <label class="form-check-label" for="notifyMessages">
                                        New messages and inquiries
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Verification -->
                    <div id="step3" class="form-step" style="display: none;">
                        <div class="form-section">
                            <h3><i class="bi bi-shield-check"></i>Profile Summary</h3>
                            <div id="profileSummary" class="alert alert-info">
                                <!-- Summary will be populated here -->
                            </div>
                        </div>

                        <div class="form-section">
                            <h3><i class="bi bi-check-circle"></i>Terms & Conditions</h3>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                <label class="form-check-label" for="agreeTerms">
                                    I agree to the <a href="../legal/terms.html" target="_blank">Terms of Service</a> and <a href="../legal/privacy.html" target="_blank">Privacy Policy</a> *
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="agreeMarketing">
                                <label class="form-check-label" for="agreeMarketing">
                                    I agree to receive marketing communications and updates from Starlet Properties
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                            <i class="bi bi-arrow-left me-2"></i>Previous
                        </button>
                        <button type="button" class="btn btn-primary" id="nextBtn">
                            Next<i class="bi bi-arrow-right ms-2"></i>
                        </button>
                        <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                            <span class="loading-spinner me-2">
                                <i class="bi bi-arrow-clockwise spin"></i>
                            </span>
                            Complete Profile
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-success text-white border-0">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle me-2"></i>Profile Completed!
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <i class="bi bi-emoji-smile text-success" style="font-size: 4rem;"></i>
                                         <h4 class="mt-3 mb-3">Profile Completed Successfully!</h4>
                     <p class="text-muted mb-4">
                         Your profile is now complete. You can now access all features including creating listings, 
                         saving properties, and receiving personalized recommendations.
                     </p>
                    <div class="d-grid gap-2">
                        <a href="../../index.html" class="btn btn-primary">
                            <i class="bi bi-house me-2"></i>Go to Homepage
                        </a>
                        <a href="../dashboard/listings/add.html" class="btn btn-outline-primary">
                            <i class="bi bi-plus-circle me-2"></i>Start Listing
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
         <script src="../../assets/js/firebase-config.js"></script>

    <script>
        let currentStep = 1;
        let totalSteps = 3;
        let userData = {};
        let avatarFile = null;

                          // Initialize the page
         document.addEventListener('DOMContentLoaded', function() {
             console.log('DOM loaded, initializing profile setup...');
             // Wait for Firebase to be initialized
             if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                 console.log('Firebase already initialized, proceeding...');
                 initializePage();
             } else {
                 console.log('Firebase not ready, waiting...');
                 // Wait a bit for Firebase to initialize
                 setTimeout(() => {
                     if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                         console.log('Firebase initialized after delay, proceeding...');
                         initializePage();
                     } else {
                         console.error('Firebase not initialized after timeout');
                         showError('Failed to initialize application. Please refresh the page.');
                     }
                 }, 2000);
             }
         });

         function initializePage() {
             setupEventListeners();
             loadUserData();
         }

        function setupEventListeners() {
            // Navigation buttons
            document.getElementById('nextBtn').addEventListener('click', nextStep);
            document.getElementById('prevBtn').addEventListener('click', prevStep);
            document.getElementById('submitBtn').addEventListener('click', submitProfile);

            // Avatar upload
            document.getElementById('avatarInput').addEventListener('change', handleAvatarUpload);

            // Form validation
            document.getElementById('profileSetupForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitProfile();
            });
        }

                 async function loadUserData() {
             if (typeof firebase === 'undefined' || !firebase.auth) {
                 console.error('Firebase not available');
                 return;
             }
             
             const user = firebase.auth().currentUser;
             if (!user) {
                 console.error('No authenticated user found - this should not happen');
                 return;
             }
             
             console.log('Loading data for user:', user.email);
             
             // Always populate email from auth first
             if (user.email) {
                 document.getElementById('email').value = user.email;
             }
             
             // Show loading state
             const formContainer = document.querySelector('.form-container');
             const loadingDiv = document.createElement('div');
             loadingDiv.className = 'alert alert-info text-center';
             loadingDiv.innerHTML = '<i class="bi bi-arrow-clockwise spin me-2"></i>Loading your profile data...';
             formContainer.insertBefore(loadingDiv, formContainer.firstChild);
             
             try {
                 // Get user data from Firestore
                 const db = firebase.firestore();
                 const userDoc = await db.collection('users').doc(user.uid).get();
                 
                 if (userDoc.exists) {
                     const userData = userDoc.data();
                     
                     // Check if profile is already completed
                     if (userData.profileCompleted) {
                         // Profile is complete - redirect to homepage or show message
                         loadingDiv.className = 'alert alert-success text-center';
                         loadingDiv.innerHTML = '<i class="bi bi-check-circle me-2"></i>Your profile is already complete! Redirecting...';
                         
                         setTimeout(() => {
                             window.location.href = '../../index.html';
                         }, 2000);
                         return;
                     }
                     
                     // Pre-populate form fields with existing data
                     if (userData.firstName) {
                         document.getElementById('firstName').value = userData.firstName;
                     }
                     if (userData.lastName) {
                         document.getElementById('lastName').value = userData.lastName;
                     }
                     if (userData.phone) {
                         document.getElementById('phone').value = userData.phone;
                     }
                     if (userData.dateOfBirth) {
                         document.getElementById('dateOfBirth').value = userData.dateOfBirth;
                     }
                     if (userData.district) {
                         document.getElementById('district').value = userData.district;
                     }
                     if (userData.neighborhood) {
                         document.getElementById('neighborhood').value = userData.neighborhood;
                     }
                     if (userData.address) {
                         document.getElementById('address').value = userData.address;
                     }
                     
                     // Pre-populate interests
                     if (userData.interests && Array.isArray(userData.interests)) {
                         userData.interests.forEach(interest => {
                             const checkbox = document.getElementById(`interest${interest.charAt(0).toUpperCase() + interest.slice(1)}`);
                             if (checkbox) {
                                 checkbox.checked = true;
                             }
                         });
                     }
                     
                     // Pre-populate contact preferences
                     if (userData.contactPreferences && Array.isArray(userData.contactPreferences)) {
                         userData.contactPreferences.forEach(pref => {
                             const checkbox = document.getElementById(`contact${pref.charAt(0).toUpperCase() + pref.slice(1)}`);
                             if (checkbox) {
                                 checkbox.checked = true;
                             }
                         });
                     }
                     
                     // Pre-populate notification preferences
                     if (userData.notificationPreferences && Array.isArray(userData.notificationPreferences)) {
                         userData.notificationPreferences.forEach(pref => {
                             const checkbox = document.getElementById(`notify${pref.charAt(0).toUpperCase() + pref.slice(1).replace(/_([a-z])/g, (g) => g[1].toUpperCase())}`);
                             if (checkbox) {
                                 checkbox.checked = true;
                             }
                         });
                     }
                     
                     // Pre-populate marketing consent
                     if (userData.marketingConsent !== undefined) {
                         document.getElementById('agreeMarketing').checked = userData.marketingConsent;
                     }
                     
                     // Load avatar if exists
                     if (userData.avatarURL) {
                         const preview = document.getElementById('avatarPreview');
                         const icon = document.getElementById('avatarIcon');
                         preview.src = userData.avatarURL;
                         preview.style.display = 'block';
                         icon.style.display = 'none';
                     }
                 }
                 
             } catch (error) {
                 console.error('Error loading user data:', error);
                 // Continue with empty form if there's an error
             } finally {
                 // Remove loading indicator
                 if (loadingDiv.parentNode) {
                     loadingDiv.remove();
                 }
             }
         }

        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    currentStep++;
                    updateStepDisplay();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        function updateStepDisplay() {
            // Hide all steps
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById(`step${i}`).style.display = 'none';
                document.getElementById(`step${i}Number`).className = 'step-number';
            }

            // Show current step
            document.getElementById(`step${currentStep}`).style.display = 'block';
            document.getElementById(`step${currentStep}Number`).className = 'step-number active';

            // Update completed steps
            for (let i = 1; i < currentStep; i++) {
                document.getElementById(`step${i}Number`).className = 'step-number completed';
            }

            // Update buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');

            prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
            nextBtn.style.display = currentStep < totalSteps ? 'block' : 'none';
            submitBtn.style.display = currentStep === totalSteps ? 'block' : 'none';

            // Update button text
            if (currentStep === totalSteps) {
                nextBtn.style.display = 'none';
            }

            // Generate summary for step 3
            if (currentStep === 3) {
                generateProfileSummary();
            }
        }

        function validateCurrentStep() {
            const currentStepElement = document.getElementById(`step${currentStep}`);
            const requiredFields = currentStepElement.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

                         // Additional validation for step 1
             if (currentStep === 1) {
                 const phone = document.getElementById('phone').value;
                 if (!phone.trim()) {
                     document.getElementById('phone').classList.add('is-invalid');
                     isValid = false;
                 } else if (!isValidPhone(phone)) {
                     document.getElementById('phone').classList.add('is-invalid');
                     isValid = false;
                 } else {
                     document.getElementById('phone').classList.remove('is-invalid');
                 }
             }

            // Additional validation for step 2
            if (currentStep === 2) {
                const interests = document.querySelectorAll('input[id^="interest"]:checked');
                if (interests.length === 0) {
                    showError('Please select at least one interest');
                    isValid = false;
                }
            }

            return isValid;
        }

        function isValidPhone(phone) {
            const phoneRegex = /^(\+256|256)?[0-9]{9}$/;
            return phoneRegex.test(phone.replace(/\s/g, ''));
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showError('File size must be less than 5MB');
                    return;
                }

                avatarFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('avatarPreview');
                    const icon = document.getElementById('avatarIcon');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    icon.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function generateProfileSummary() {
            const summary = document.getElementById('profileSummary');
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phone = document.getElementById('phone').value;
            const district = document.getElementById('district').value;
            const interests = Array.from(document.querySelectorAll('input[id^="interest"]:checked'))
                .map(cb => cb.value);

            summary.innerHTML = `
                <h6 class="mb-3">Profile Summary:</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Name:</strong> ${firstName} ${lastName}</p>
                        <p><strong>Phone:</strong> ${phone}</p>
                        <p><strong>District:</strong> ${district}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Interests:</strong> ${interests.join(', ')}</p>
                        <p><strong>Profile Photo:</strong> ${avatarFile ? 'Uploaded' : 'Not uploaded'}</p>
                    </div>
                </div>
            `;
        }

        async function submitProfile() {
            if (!validateCurrentStep()) {
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const spinner = submitBtn.querySelector('.loading-spinner');
            
            submitBtn.disabled = true;
            spinner.classList.add('show');

                         try {
                 if (typeof firebase === 'undefined' || !firebase.auth) {
                     throw new Error('Firebase not available');
                 }
                 
                 const user = firebase.auth().currentUser;
                 if (!user) {
                     throw new Error('User not authenticated - this should not happen');
                 }

                // Collect form data
                const profileData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    dateOfBirth: document.getElementById('dateOfBirth').value,
                    district: document.getElementById('district').value,
                    neighborhood: document.getElementById('neighborhood').value,
                    address: document.getElementById('address').value,
                    interests: Array.from(document.querySelectorAll('input[id^="interest"]:checked'))
                        .map(cb => cb.value),
                    contactPreferences: Array.from(document.querySelectorAll('input[id^="contact"]:checked'))
                        .map(cb => cb.value),
                    notificationPreferences: Array.from(document.querySelectorAll('input[id^="notify"]:checked'))
                        .map(cb => cb.value),
                    marketingConsent: document.getElementById('agreeMarketing').checked,
                    profileCompleted: true,
                    completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Upload avatar if selected
                if (avatarFile) {
                    const storageRef = firebase.storage().ref();
                    const avatarRef = storageRef.child(`avatars/${user.uid}/${avatarFile.name}`);
                    const snapshot = await avatarRef.put(avatarFile);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    profileData.avatarURL = downloadURL;
                }

                // Save to Firestore
                const db = firebase.firestore();
                await db.collection('users').doc(user.uid).set(profileData, { merge: true });

                // Show success modal
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();

                // Mark welcome as shown
                localStorage.setItem(`welcomeShown_${user.uid}`, 'true');

            } catch (error) {
                console.error('Error saving profile:', error);
                showError('Failed to save profile. Please try again.');
            } finally {
                submitBtn.disabled = false;
                spinner.classList.remove('show');
            }
        }

        function showError(message) {
            // Create and show error alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const formContainer = document.querySelector('.form-container');
            formContainer.insertBefore(alertDiv, formContainer.firstChild);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Add spinning animation for loading
        const style = document.createElement('style');
        style.textContent = `
            .spin {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
