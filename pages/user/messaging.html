<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messaging - Starlet Properties</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="../../css/style.css">
  <style>
    html, body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      height: 100%;
      width: 100vw;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      background: linear-gradient(135deg, #e3f0ff 0%, #f8f9fa 100%) !important;
    }
    
    .chat-container {
      background: #f4f6fb;
      min-height: 60vh;
      max-height: 80vh;
      height: 70vh;
      width: 100%;
      margin: 0 auto 2rem auto;
      display: flex;
      flex-direction: row;
      box-shadow: 0 8px 32px rgba(13,110,253,0.10), 0 1.5px 8px rgba(0,0,0,0.04);
      border-radius: 1.2rem;
      border: 1.5px solid #e3e6ee;
      overflow: hidden;
      transition: box-shadow 0.2s, border-radius 0.2s;
    }
    
    .chat-sidebar { 
      background: linear-gradient(135deg, #f8fafc 80%, #e3f0ff 100%);
      border-radius: 1.2rem;
      box-shadow: 0 4px 24px rgba(13,110,253,0.10), 0 1.5px 8px rgba(0,0,0,0.04);
      border: 1.5px solid #e3e6ee;
      min-width: 0;
      max-width: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
      opacity: 1;
      transition: all 0.3s, transform 0.35s cubic-bezier(.4,0,.2,1), opacity 0.25s;
      z-index: 2;
      max-height: 100%;
      overflow-y: auto;
    }
    
    .chat-listing { 
      padding: 1rem; 
      border-bottom: 1px solid #eee; 
      cursor: pointer; 
      transition: all 0.2s; 
      display: flex; 
      align-items: center; 
      gap: 1rem; 
      position: relative;
      border-radius: 0.7rem;
      margin: 0.5rem 0.7rem;
      background: #f8f9fa;
    }
    
    .chat-listing.active, .chat-listing:hover { 
      background: #e3f0ff; 
      box-shadow: 0 2px 8px rgba(13,110,253,0.08);
      transform: translateY(-2px) scale(1.01);
    }
    
    .chat-listing-title { 
      font-weight: 800;
      font-size: 1.08em;
      color: #03254c;
      margin-bottom: 0.1rem;
    }
    
    .chat-listing-agent { 
      font-size: 0.97em;
      color: #6c757d;
      font-weight: 600;
    }
    
    .chat-listing .unread-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
    }
    
    .chat-main {
      background: linear-gradient(135deg, #f4f6fb 80%, #e3f0ff 100%), #fff;
      z-index: 11;
      position: relative;
      box-shadow: 0 6px 32px rgba(13,110,253,0.10), 0 1.5px 8px rgba(0,0,0,0.04);
      border-radius: 1.3rem;
      margin-bottom: 48px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
      height: 100%;
    }
    
    .chat-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #fff;
      border-bottom: 1px solid #e3e6ee;
      padding: 1.1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1.2rem;
      min-height: 72px;
      box-shadow: 0 4px 16px rgba(13,110,253,0.06);
      border-radius: 1.3rem 1.3rem 0 0;
    }
    
    .chat-header .back-btn {
      display: none;
      background: none;
      border: none;
      font-size: 1.7rem;
      color: #03254c;
      margin-right: 0.7rem;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.2s;
    }
    
    .chat-header .back-btn:active, .chat-header .back-btn:focus {
      background: #e3f0ff;
    }
    
    @media (max-width: 900px) {
      .chat-header .back-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
    }
    
    .chat-header .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ffd70033;
      box-shadow: 0 1px 4px rgba(13,110,253,0.04);
    }
    
    .chat-header .info { 
      flex: 1; 
    }
    
    .chat-header .info h5 { 
      font-weight: 900;
      margin-bottom: 0.1rem;
      color: #03254c;
      font-size: 1.25rem;
      letter-spacing: 0.01em;
    }
    
    .chat-header .info p { 
      color: #6c757d;
      font-size: 1.01rem;
      margin-bottom: 0;
      font-weight: 500;
    }
    
    .chat-header .actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .chat-messages { 
      flex: 1; 
      padding: 1.2rem 0.7rem 1.2rem 0.7rem; 
      background: #ece5dd; 
      overflow-y: auto; 
      display: flex; 
      flex-direction: column; 
      gap: 0.5rem;
    }
    
    .chat-message { 
      display: flex; 
      align-items: flex-end; 
      gap: 0.5rem; 
      margin-bottom: 0.2rem; 
      position: relative;
      transition: background 0.2s;
    }
    
    .chat-message.sent {
      flex-direction: row-reverse;
    }
    
    .chat-message.sent .bubble {
      background: linear-gradient(135deg, #25d366 80%, #dcf8c6 100%);
      color: #222;
      border-bottom-left-radius: 1.2rem;
      border-bottom-right-radius: 0.3rem;
      box-shadow: 0 2px 8px rgba(37,211,102,0.08);
    }
    
    .chat-message.received .bubble {
      background: #fff;
      color: #222;
      border-bottom-left-radius: 0.3rem;
      border-bottom-right-radius: 1.2rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    
    .chat-message .avatar { 
      width: 32px; 
      height: 32px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 1.5px solid #25d36633;
      box-shadow: 0 1px 4px rgba(37,211,102,0.08);
    }
    
    .chat-message .bubble { 
      max-width: 75vw; 
      padding: 0.7rem 1.1rem; 
      border-radius: 1.2rem; 
      background: #fff; 
      color: #222; 
      font-size: 1.05em; 
      position: relative; 
      word-wrap: break-word;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      border-bottom-left-radius: 0.3rem;
      margin-bottom: 2px;
      min-width: 60px;
      transition: background 0.2s;
    }
    
    .chat-message.sent .bubble { 
      background: linear-gradient(135deg, #25d366 80%, #dcf8c6 100%); 
      color: #222; 
    }
    
    .chat-message .meta { 
      font-size: 0.78em;
      color: #adb5bd;
      font-weight: 500;
      margin-top: 0.2rem; 
      text-align: right; 
      display: block; 
      position: absolute; 
      right: 10px; 
      bottom: 2px; 
      opacity: 0.8;
    }
    
    .chat-message.sent .meta {
      right: 16px;
      color: #34b7f1;
    }
    
    .chat-input-bar { 
      background: #fff;
      border-top: 1px solid #e3e6ee;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: flex-end;
      gap: 0.7rem;
      border-radius: 0 0 1.3rem 1.3rem;
      box-shadow: 0 -4px 16px rgba(13,110,253,0.06);
      position: sticky;
      bottom: 0;
      z-index: 10;
      margin-bottom: 12px;
    }
    
    .chat-input-bar textarea { 
      flex: 1; 
      resize: none; 
      border-radius: 1.2rem; 
      border: 1.5px solid #e3e6ee; 
      padding: 0.8rem 1.2rem; 
      font-size: 1.08em; 
      background: #f8f9fa; 
      min-height: 40px;
      max-height: 120px;
      box-shadow: none;
      transition: border-color 0.2s;
    }
    
    .chat-input-bar textarea:focus {
      border-color: #0d6efd;
      background: #fff;
      outline: none;
    }
    
    .chat-input-bar button { 
      border-radius: 50%; 
      width: 44px; 
      height: 44px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 1.35rem; 
      color: #03254c; 
      background: #e3f0ff; 
      border: none; 
      box-shadow: 0 1px 4px rgba(13,110,253,0.04); 
      transition: background 0.2s, color 0.2s;
    }
    
    .chat-input-bar button:hover, .chat-input-bar button:focus {
      background: #0d6efd;
      color: #fff;
    }
    
    .chat-input-bar .attachment-btn {
      background: #f8f9fa;
      border: 1px solid #ddd;
      color: #6c757d;
    }
    
    .chat-input-bar .attachment-btn:hover {
      background: #e9ecef;
      color: #495057;
    }
    
    .chat-input-bar .send-btn {
      background: #0d6efd;
      border: 1px solid #0d6efd;
      color: white;
    }
    
    .chat-input-bar .send-btn:hover {
      background: #0b5ed7;
      border-color: #0b5ed7;
    }
    
    .chat-input-bar .send-btn:disabled {
      background: #6c757d;
      border-color: #6c757d;
      cursor: not-allowed;
    }
    
    /* File upload styles */
    .file-upload-container {
      position: relative;
      display: inline-block;
    }
    
    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-preview {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
      border: 1px solid #e9ecef;
    }
    
    .file-preview .file-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: white;
      border-radius: 0.25rem;
      margin-bottom: 0.5rem;
    }
    
    .file-preview .file-item:last-child {
      margin-bottom: 0;
    }
    
    .file-preview .file-icon {
      font-size: 1.5rem;
      color: #6c757d;
    }
    
    .file-preview .file-info {
      flex: 1;
      min-width: 0;
    }
    
    .file-preview .file-name {
      font-size: 0.9rem;
      font-weight: 500;
      color: #495057;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .file-preview .file-size {
      font-size: 0.8rem;
      color: #6c757d;
    }
    
    .file-preview .remove-file {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
    }
    
    .file-preview .remove-file:hover {
      background: #f8d7da;
    }
    
    /* Media message styles */
    .chat-message .media-content {
      margin-top: 0.5rem;
      border-radius: 0.5rem;
      overflow: hidden;
      max-width: 300px;
    }
    
    .chat-message .media-content img {
      width: 100%;
      height: auto;
      object-fit: cover;
    }
    
    .chat-message .media-content video {
      width: 100%;
      height: auto;
    }
    
    .chat-message .media-content .file-download {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 0.25rem;
      text-decoration: none;
      color: #495057;
      transition: background 0.2s ease;
    }
    
    .chat-message .media-content .file-download:hover {
      background: #e9ecef;
      text-decoration: none;
    }
    
    .chat-message .media-content .file-download i {
      font-size: 1.2rem;
    }
    
    .typing-indicator {
      padding: 0.5rem 1rem;
      color: #34b7f1;
      font-style: italic;
      font-size: 0.98em;
      min-height: 24px;
      display: flex;
      align-items: center;
      gap: 0.3em;
      letter-spacing: 0.02em;
      animation: fadeIn 0.3s;
    }
    .typing-ellipsis {
      display: inline-block;
      width: 1.2em;
      text-align: left;
    }
    .typing-ellipsis span {
      display: inline-block;
      width: 0.2em;
      height: 0.2em;
      margin-right: 0.1em;
      background: #34b7f1;
      border-radius: 50%;
      opacity: 0.5;
      animation: typing-bounce 1.2s infinite both;
    }
    .typing-ellipsis span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-ellipsis span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes typing-bounce {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1.2); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .message-status {
      display: inline-block;
      margin-left: 0.5rem;
    }
    
    .message-status.sent {
      color: #6c757d;
    }
    
    .message-status.delivered {
      color: #0d6efd;
    }
    
    .message-status.read {
      color: #198754;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }
    
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    /* Loading animation styles */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    
    .star-loading {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .star {
      width: 20px;
      height: 20px;
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      animation: starJump 1.5s ease-in-out infinite;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
    }
    
    .star:nth-child(2) {
      animation-delay: 0.2s;
      background: linear-gradient(45deg, #00d4ff, #4ed4ff);
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.5), 0 0 20px rgba(0, 212, 255, 0.3);
    }
    
    .star:nth-child(3) {
      animation-delay: 0.4s;
      background: linear-gradient(45deg, #03254c, #1e3a8a);
      box-shadow: 0 0 10px rgba(3, 37, 76, 0.5), 0 0 20px rgba(3, 37, 76, 0.3);
    }
    
    @keyframes starJump {
      0%, 100% {
        transform: translateY(0) scale(1);
      }
      50% {
        transform: translateY(-15px) scale(1.1);
      }
    }
    
    .loading-text {
      color: #6c757d;
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    /* Floating Support Button */
    .floating-support-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      border: none;
      border-radius: 50%;
      box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
      color: #03254c;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
    }
    
    .floating-support-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 25px rgba(255, 215, 0, 0.6);
      background: linear-gradient(135deg, #ffed4e, #ffd700);
    }
    
    .floating-support-btn:active {
      transform: scale(0.95);
    }
    
    .floating-support-btn.clicked {
      animation: supportClick 0.3s ease;
    }
    
    @keyframes supportClick {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(0.8);
      }
      100% {
        transform: scale(1);
      }
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
      }
      50% {
        box-shadow: 0 4px 20px rgba(255, 215, 0, 0.8);
      }
      100% {
        box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
      }
    }
    
    .floating-support-btn .tooltip {
      position: absolute;
      right: 70px;
      top: 50%;
      transform: translateY(-50%);
      background: #03254c;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .floating-support-btn .tooltip::after {
      content: '';
      position: absolute;
      right: -5px;
      top: 50%;
      transform: translateY(-50%);
      border-left: 5px solid #03254c;
      border-top: 5px solid transparent;
      border-bottom: 5px solid transparent;
    }
    
    .floating-support-btn:hover .tooltip {
      opacity: 1;
    }
    
    @media (max-width: 768px) {
      .floating-support-btn {
        bottom: 20px;
        right: 20px;
        width: 55px;
        height: 55px;
        font-size: 1.3rem;
      }
      
      .floating-support-btn .tooltip {
        display: none;
      }
    }
    
    @media (max-width: 900px) { 
      .chat-container { 
        flex-direction: column; 
        height: auto; 
      } 
      .chat-sidebar { 
        width: 100%; 
        height: 180px; 
        border-right: none; 
        border-bottom: 1px solid #eee; 
        display: flex; 
        flex-direction: row; 
        overflow-x: auto; 
        overflow-y: hidden; 
      } 
      .chat-listing { 
        flex: 1 0 220px; 
        border-bottom: none; 
        border-right: 1px solid #eee; 
      } 
      .chat-main { 
        min-height: 400px; 
      } 
    }
    
    @media (max-width: 600px) { 
      .chat-header { 
        flex-direction: column; 
        align-items: flex-start; 
        gap: 0.5rem; 
      } 
      .chat-messages { 
        padding: 0.7rem; 
      } 
      .chat-input-bar { 
        padding: 0.5rem; 
      } 
    }
    
    /* Unread message badge (WhatsApp style) */
    #unreadMessagesBadge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #dc3545 !important;
      color: #fff !important;
      font-size: 0.85rem !important;
      font-weight: 700;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      line-height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
      box-shadow: 0 2px 8px rgba(220,53,69,0.15);
      z-index: 2;
      border: 2px solid #fff;
    }

    #unreadMessagesBadge.d-none {
      display: none !important;
    }
    
    /* Responsive chat container margin and padding */
    .chat-outer {
      flex: 1 1 auto;
      min-height: 0;
      width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background: transparent;
      padding: 12px 0 0 0;
      padding-top: calc(12px + env(safe-area-inset-top));
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    @media (max-width: 900px) {
      .chat-outer {
        padding: 4px 0 0 0;
      }
    }
    @media (max-width: 600px) {
      .chat-outer {
        padding: 2px 0 0 0;
      }
    }
    .chat-container {
      margin: 0 auto 0 auto;
      width: 100%;
      max-width: 1200px;
      min-height: 0;
      height: 100%;
      box-sizing: border-box;
      padding: 0 16px 40px 16px;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 32px;
      background: none;
      border-radius: 0;
      box-shadow: none;
      align-items: stretch;
      padding-bottom: calc(40px + env(safe-area-inset-bottom));
      padding-left: calc(16px + env(safe-area-inset-left));
      padding-right: calc(16px + env(safe-area-inset-right));
    }
    @media (max-width: 1100px) {
      .chat-container {
        padding: 0 4px 20px 4px;
        gap: 16px;
        grid-template-columns: 200px 1fr;
      }
    }
    @media (max-width: 900px) {
      .chat-outer {
        padding: 4px 0 0 0;
      }
      .chat-container {
     display: flex;
        flex-direction: column;
        gap: 0;
        padding: 0 0px 12px 0px;
      }
      .chat-sidebar, .chat-main {
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(13,110,253,0.06);
        border: 1.5px solid #e3e6ee;
        margin-bottom: 12px;
      }
      .chat-sidebar {
        min-width: 0;
        max-width: 100vw;
        margin-bottom: 12px;
        height: auto;
      }
      .chat-main {
        min-width: 0;
        width: 100%;
        margin-bottom: 0;
      }
      .chat-header, .chat-input-bar {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      .chat-header {
        min-height: 60px;
      }
      .chat-listing {
        padding: 0.7rem 0.7rem;
        margin: 0.3rem 0.2rem;
      }
      .chat-messages {
        padding: 0.5rem 0.2rem 0.5rem 0.2rem;
      }
    }
    @media (max-width: 600px) {
      .chat-outer {
        padding: 2px 0 0 0;
      }
      .chat-container {
        padding: 0 0px 6px 0px;
      }
      .chat-sidebar, .chat-main {
        border-radius: 0.7rem;
        margin-bottom: 8px;
      }
      .chat-header, .chat-input-bar {
        padding-left: 0.7rem;
        padding-right: 0.7rem;
      }
      .chat-header {
        min-height: 48px;
      }
      .chat-listing {
        padding: 0.5rem 0.4rem;
        margin: 0.2rem 0.1rem;
      }
      .chat-messages {
        padding: 0.2rem 0.05rem 0.2rem 0.05rem;
      }
    }
    html, body {
     overflow: hidden;
      height: 100dvh;
    }
    .footer {
      /* Remove sticky so chat can scroll over footer if needed */
      position: static;
      width: 100%;
      z-index: 1;
      margin-top: 10px;
   }
  </style>
  <style>
/* --- Layout Fix: Prevent chat from overlapping footer --- */
html, body {
  height: 100%;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
body {
  flex: 1 1 auto;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
main.chat-outer {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  min-height: 0;
}
.chat-container {
  flex: 1 1 auto !important;
  display: flex !important;
  flex-direction: row !important;
  min-height: 0 !important;
  height: 100% !important;
  max-height: none !important;
  margin-bottom: 0 !important;
}
.chat-main {
  flex: 1 1 auto !important;
  display: flex !important;
  flex-direction: column !important;
  min-height: 0 !important;
  height: 100% !important;
}
.chat-messages {
  flex: 1 1 auto !important;
  overflow-y: auto !important;
  min-height: 0 !important;
  padding-bottom: 2.5rem !important; /* Add enough padding so last message is above the footer */
}
/* Remove fixed heights from .chat-container and .chat-messages */
.chat-container,
.chat-messages {
  height: auto !important;
  max-height: none !important;
}
/* --- End Layout Fix --- */
</style>
<!-- Removed min-height: 80vh for .chat-container and .chat-main to prevent footer overlap -->

</style>
<style>
@media (min-width: 900px) {
  .chat-container {
    min-height: 80vh !important;
  }
  .chat-main {
    min-height: 80vh !important;
  }
}
</style>
<style>
.chat-outer {
  min-height: 400px;
}
</style>
</head>
<body>
    <!-- Navbar (copied from index.html) -->
    <nav class="navbar navbar-expand-lg navbar-custom modern-navbar shadow-sm py-3 sticky-top w-100">
  <div class="d-flex flex-row align-items-center justify-content-between w-100 px-3 px-md-4">
    <!-- Brand Left -->
    <a class="navbar-brand d-flex align-items-center gap-2 me-4 py-0" href="../../index.html">
      <span class="brand-star">Star</span> <span class="brand-let">Let</span>
    </a>
    <!-- Toggler for mobile -->
    <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse flex-grow-1" id="navbarNav">
      <ul class="navbar-nav d-flex align-items-center gap-2 ms-auto mb-2 mb-lg-0 w-100 justify-content-end">
        <li class="nav-item">
          <a class="nav-link icon-circle" href="../user/saved.html" title="Saved" aria-label="Saved">
            <i class="bi bi-bookmark"></i>
          </a>
        </li>
        <li class="nav-item position-relative">
          <a class="nav-link icon-circle position-relative" href="../user/messaging.html" title="Messages" aria-label="Messages" id="messagesNavLink">
            <i class="bi bi-chat-dots"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="unreadMessagesBadge">0</span>
          </a>
        </li>
        <li class="nav-item position-relative" id="nav-notification-bell">
          <a class="nav-link icon-circle position-relative" href="../user/notifications.html" title="Notifications" aria-label="Notifications">
            <i class="bi bi-bell"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="notification-badge">0</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link icon-circle" id="myListingsLink" href="../stores/index.html" title="My Listings" aria-label="My Listings">
            <i class="bi bi-card-list"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link icon-circle" id="profileLink" href="#" title="Profile" aria-label="Profile">
            <i class="bi bi-person"></i>
          </a>
        </li>
        <li class="vr mx-3 d-none d-lg-block" style="height: 32px; opacity: 0.15;"></li>
        <li class="nav-item ms-lg-2">
          <a class="btn btn-warning fw-bold px-4 rounded-pill shadow-sm" href="../dashboard/listings/add.html" style="color: #fff;">SELL</a>
        </li>
        <li class="nav-item ms-lg-2" id="authButtonContainer">
          <a class="btn btn-outline-primary fw-bold px-4 rounded-pill shadow-sm" id="authButton" href="../auth/login.html">Login / Signup</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<style>
.navbar-custom.modern-navbar {
  background: #03254c !important;
  border-bottom: 3px solid #ffd700;
  box-shadow: 0 2px 12px rgba(0,0,0,0.04) !important;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
  z-index: 1030;
  position: sticky;
  top: 0;
  width: 100%;
}
.navbar-custom .navbar-brand {
  font-weight: 800;
  font-size: 1.7rem;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 0.2em;
  margin-right: 0 !important;
  padding-right: 0 !important;
  padding-top: 0.1rem;
  padding-bottom: 0.1rem;
}
.navbar-custom .navbar-nav {
  display: flex;
  align-items: center;
  gap: 0.4rem !important;
  margin-left: 0 !important;
  margin-right: 0 !important;
  padding-left: 0 !important;
  padding-right: 0 !important;
}
.icon-circle {
  background: #fff;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  display: flex !important;
  align-items: center;
  justify-content: center;
  font-size: 1.35rem;
  color: #03254c;
  box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  margin: 0 2px;
  transition: background 0.2s, color 0.2s;
  position: relative;
}
.icon-circle:hover, .icon-circle:focus {
  background: #e3f0ff;
  color: var(--primary-color);
  text-decoration: none;
  box-shadow: 0 2px 8px rgba(13,110,253,0.08);
}
.navbar-custom .btn-warning {
  background: var(--accent-gold) !important;
  border: none;
  color: #fff !important;
  font-weight: 700;
  font-size: 1.1rem;
  box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  border-radius: 50px;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
}
.navbar-custom .btn-warning:hover {
  background: #ffd700cc !important;
  color: #03254c !important;
}
.navbar-custom .btn-outline-primary {
  border-radius: 50px;
  font-weight: 700;
  font-size: 1.1rem;
  box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
}
.vr {
  border-left: 2px solid #fff;
  opacity: 0.15;
  height: 32px;
}
@media (max-width: 991.98px) {
  .navbar-custom .navbar-brand {
    font-size: 1.4rem;
  }
  .navbar-custom .navbar-nav {
    gap: 0.5rem !important;
  }
  .vr {
    display: none !important;
  }
  .navbar-custom .btn-warning,
  .navbar-custom .btn-outline-primary {
    padding-top: 0.4rem;
    padding-bottom: 0.4rem;
    font-size: 1rem;
  }
  .navbar-custom.modern-navbar {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
  }
}
@media (max-width: 575.98px) {
  .navbar-custom .navbar-brand {
    font-size: 1.1rem;
    padding-left: 0.2rem;
  }
  .navbar-custom.modern-navbar {
    padding-left: 0.2rem;
    padding-right: 0.2rem;
  }
}
</style>
<!-- Main Chat Container -->
<main class="chat-outer">
  <div class="chat-container">
    <!-- Sidebar -->
    <div id="chatSidebar" class="chat-sidebar">
      <div class="sidebar-header" style="padding: 1.2rem 1.2rem 0.5rem 1.2rem; background: none;">
        <h3 style="font-weight: 900; font-size: 1.35rem; margin: 0 0 0.5rem 0; color: #03254c; letter-spacing: 0.01em;">Conversations</h3>
        <div class="sidebar-search" style="margin-bottom: 1rem;">
          <input type="text" class="form-control" placeholder="Search..." style="border-radius: 2rem; font-size: 1em; padding: 0.5em 1.2em; box-shadow: 0 1px 4px rgba(13,110,253,0.04); border: 1.2px solid #e3e6ee;">
        </div>
      </div>
      <div id="chatSidebarList"></div>
    </div>
    <!-- Main Chat Area -->
    <div class="chat-main">
      <!-- Chat Header -->
      <div id="chatHeader" class="chat-header">
        <button class="back-btn" id="backToSidebar" title="Back to conversations" style="display:none;"><i class="bi bi-arrow-left"></i></button>
        <img src="${selectedConversation.agentAvatar || 'https://via.placeholder.com/48x48/0d6efd/ffffff?text=A'}" class="avatar">
        <div class="info">
          <h5>${selectedConversation.agentName || 'Agent'}</h5>
          <p>${selectedConversation.listingTitle || 'Listing'}</p>
        </div>
        <div id="typingIndicator" class="typing-indicator" style="display:none;"></div>
      </div>
      <!-- Chat Messages -->
      <div id="chatMessages" class="chat-messages"></div>
      <!-- Chat Input Bar -->
      <form id="chatInputForm" class="chat-input-bar" autocomplete="off">
        <textarea id="chatInput" class="form-control" placeholder="Type a message..." rows="1" required></textarea>
        <button type="button" id="attachmentBtn" class="btn attachment-btn" title="Attach file"><i class="bi bi-paperclip"></i></button>
        <input type="file" id="fileInput" class="file-input" multiple style="display:none;">
        <div id="filePreview" class="file-preview" style="display:none;"></div>
        <button type="submit" class="btn send-btn" disabled><i class="bi bi-send"></i></button>
      </form>
    </div>
  </div>
  <!-- Floating Support Button -->
  <button id="floatingSupportBtn" class="floating-support-btn" title="Chat with Support">
    <i class="bi bi-headset"></i>
    <span class="tooltip">Chat with Support</span>
  </button>
  <!-- Chat with Admin Button (hidden, for programmatic use) -->
  <button id="chatWithAdminBtn" style="display:none;"></button>
</main>
<!-- Footer (modern, from index.html, with correct relative links) -->
<footer class="footer mt-5">
  <div class="container">
    <div class="row">
      <div class="col-lg-4 mb-4">
        <h4>About Starlet Properties</h4>
        <p>Uganda's premier real estate and vehicle marketplace, connecting buyers and sellers across the country.</p>
        <div class="social-links">
          <a href="#"><i class="fab fa-facebook"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
          <a href="#"><i class="fab fa-linkedin"></i></a>
        </div>
      </div>
      <div class="col-lg-2 col-md-6 mb-4">
        <h4>Properties</h4>
        <ul>
          <li><a href="../properties/index.html?type=house_sale">Houses for Sale</a></li>
          <li><a href="../properties/index.html?type=house_rent">Houses for Rent</a></li>
          <li><a href="../properties/index.html?type=land_sale">Land for Sale</a></li>
          <li><a href="../properties/index.html?type=land_rent">Land for Rent</a></li>
          <li><a href="../properties/index.html?type=commercial">Commercial Property</a></li>
          <li><a href="../properties/index.html?type=vacation_short_stay">Vacation & Short Stay</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-md-6 mb-4">
        <h4>Vehicles</h4>
        <ul>
          <li><a href="../vehicles/index.html?type=cars">Cars</a></li>
          <li><a href="../vehicles/index.html?type=motorcycles">Motorcycles</a></li>
          <li><a href="../vehicles/index.html?type=trucks">Trucks</a></li>
          <li><a href="../vehicles/index.html?type=buses">Buses</a></li>
          <li><a href="../vehicles/index.html?type=heavy_machinery">Heavy Machinery</a></li>
          <li><a href="../vehicles/index.html?type=bicycles_ebikes">Bicycles & E-bikes</a></li>
          <li><a href="../vehicles/index.html?type=boats_watercraft">Boats & Watercraft</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-md-6 mb-4">
        <h4>Company</h4>
        <ul>
          <li><a href="../about/index.html">About Us</a></li>
          <li><a href="../about/contact.html">Contact</a></li>
          <li><a href="../about/resources.html">Resources</a></li>
          <li><a href="../stores/index.html">Our Stores</a></li>
          <li><a href="../legal/privacy.html">Privacy Policy</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-md-6 mb-4">
        <h4>Contact</h4>
        <ul>
          <li><a href="tel:+256123456789"><i class="bi bi-telephone"></i> +256 123 456 789</a></li>
          <li><a href="mailto:info@starlet.co.ug"><i class="bi bi-envelope"></i> info@starlet.co.ug</a></li>
          <li><a href="#"><i class="bi bi-geo-alt"></i> Kampala, Uganda</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="row">
        <div class="col-md-6">
          <p class="mb-0">&copy; 2024 Starlet Properties. All rights reserved.</p>
        </div>
        <div class="col-md-6 text-md-end">
          <a href="../legal/terms.html" class="me-3">Terms of Service</a>
          <a href="../legal/privacy.html">Privacy Policy</a>
        </div>
      </div>
    </div>
  </div>
</footer>

<style>
/* WhatsApp-like Modern Chat UI Enhancements */
body {
  background: linear-gradient(135deg, #e3f0ff 0%, #f8f9fa 100%) !important;
}

.chat-container {
  box-shadow: 0 8px 32px rgba(13,110,253,0.08), 0 1.5px 8px rgba(0,0,0,0.04);
  border-radius: 1.5rem;
  overflow: hidden;
  background: #f4f6fb;
  min-height: 60vh;
  max-height: 70vh;
  margin-bottom: 2rem;
  height: 60vh;
  display: flex;
  flex-direction: row;
  width: 100%;
  margin-left: 0;
  margin-right: 0;
}

.chat-sidebar {
  background: #fff;
  border-right: 1px solid #e3e6ee;
  padding: 0;
  min-width: 300px;
  max-width: 340px;
  box-shadow: 2px 0 8px rgba(13,110,253,0.03);
  overflow-y: auto;
  transition: all 0.3s;
}

.chat-listing {
  border-radius: 0.8rem;
  margin: 0.5rem 0.7rem;
  padding: 0.7rem 1rem;
  background: #f8f9fa;
  transition: background 0.2s, box-shadow 0.2s;
  box-shadow: 0 1px 4px rgba(13,110,253,0.03);
}
.chat-listing.active, .chat-listing:hover {
  background: #e3f0ff;
  box-shadow: 0 2px 8px rgba(13,110,253,0.08);
}

.chat-main {
  background: #f4f6fb;
  display: flex;
  flex-direction: column;
  border-radius: 0 1.5rem 1.5rem 0;
  overflow: hidden;
  flex: 1;
  min-width: 0;
}

.chat-header {
  background: #fff;
  border-bottom: 1px solid #e3e6ee;
  padding: 1.2rem 1.5rem;
  display: flex;
  align-items: center;
  gap: 1.2rem;
  min-height: 80px;
  box-shadow: 0 2px 8px rgba(13,110,253,0.03);
}

.chat-header .avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #ffd70033;
}

.chat-header .info h5 {
  font-weight: 900;
  margin-bottom: 0.1rem;
  color: #03254c;
  font-size: 1.25rem;
  letter-spacing: 0.01em;
}

.chat-header .info p {
  color: #6c757d;
  font-size: 1.01rem;
  margin-bottom: 0;
  font-weight: 500;
}

.chat-messages {
  flex: 1 1 0%;
  padding: 1.2rem 0.7rem 1.2rem 0.7rem;
  background: #ece5dd;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  height: 100%;
}

.chat-message {
  display: flex;
  align-items: flex-end;
  gap: 0.5rem;
  margin-bottom: 0.2rem;
  position: relative;
}

.chat-message.sent {
  flex-direction: row-reverse;
}

.chat-message .avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
  border: 1.5px solid #25d36633;
  box-shadow: 0 1px 4px rgba(37,211,102,0.08);
}

.chat-message .bubble {
  max-width: 75vw;
  padding: 0.7rem 1.1rem;
  border-radius: 1.2rem;
  background: #fff;
  color: #222;
  font-size: 1.05em;
  position: relative;
  word-wrap: break-word;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  border-bottom-left-radius: 0.3rem;
  margin-bottom: 2px;
  min-width: 60px;
  transition: background 0.2s;
}

.chat-message.sent .bubble {
  background: linear-gradient(135deg, #25d366 80%, #dcf8c6 100%);
  color: #222;
  border-bottom-left-radius: 1.2rem;
  border-bottom-right-radius: 0.3rem;
  box-shadow: 0 2px 8px rgba(37,211,102,0.08);
}

.chat-message.received .bubble {
  background: #fff;
  color: #222;
  border-bottom-left-radius: 0.3rem;
  border-bottom-right-radius: 1.2rem;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}

.chat-message .meta {
  font-size: 0.78em;
  color: #adb5bd;
  font-weight: 500;
  margin-top: 0.2rem; 
  text-align: right; 
  display: block; 
  position: absolute;
  right: 10px; 
  bottom: 2px; 
  opacity: 0.8;
}

.chat-message.sent .meta {
  right: 16px;
  color: #34b7f1;
}

.chat-message .bubble .media-content {
  margin-top: 0.4rem;
  border-radius: 0.5rem;
  overflow: hidden;
  max-width: 250px;
}

.chat-message .bubble .media-content img,
.chat-message .bubble .media-content video {
  width: 100%;
  height: auto;
  object-fit: cover;
  border-radius: 0.5rem;
}

.chat-input-bar {
  background: #fff;
  border-top: 1px solid #e3e6ee;
  padding: 1rem 1.5rem;
  display: flex;
  align-items: flex-end;
  gap: 0.7rem;
  border-radius: 0 0 1.5rem 1.5rem;
  box-shadow: 0 -2px 8px rgba(13,110,253,0.03);
  position: sticky;
  bottom: 0;
  z-index: 10;
  margin-bottom: 12px;
}

.chat-input-bar textarea {
  flex: 1;
  resize: none;
  border-radius: 1.2rem;
  border: 1.5px solid #e3e6ee;
  padding: 0.8rem 1.2rem;
  font-size: 1.08em;
  background: #f8f9fa;
  min-height: 40px;
  max-height: 120px;
  box-shadow: none;
  transition: border-color 0.2s;
}

.chat-input-bar textarea:focus {
  border-color: #0d6efd;
  background: #fff;
  outline: none;
}

.chat-input-bar .btn {
  border-radius: 50%;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.35rem;
  color: #03254c;
  background: #e3f0ff;
  border: none;
  box-shadow: 0 1px 4px rgba(13,110,253,0.04);
  transition: background 0.2s, color 0.2s;
}

.chat-input-bar .btn:hover, .chat-input-bar .btn:focus {
  background: #0d6efd;
  color: #fff;
}

@media (max-width: 1200px) {
  .chat-container {
    max-height: 80vh;
    height: 70vh;
  }
  .chat-sidebar {
    min-width: 220px;
    max-width: 260px;
  }
}
@media (max-width: 900px) {
  .chat-container {
    flex-direction: column;
    min-height: 60vh;
    max-height: none;
    height: auto;
    border-radius: 0;
    margin-left: 0;
    margin-right: 0;
    width: 100vw;
  }
  .chat-sidebar {
    max-width: 100vw;
    min-width: 0;
    border-right: none;
    border-bottom: 1px solid #e3e6ee;
    box-shadow: none;
    height: 120px;
    overflow-x: auto;
    overflow-y: hidden;
    display: flex;
    flex-direction: row;
  }
  .chat-listing {
    flex: 1 0 180px;
    border-bottom: none;
    border-right: 1px solid #eee;
    min-width: 160px;
    max-width: 220px;
    margin: 0.5rem 0.3rem;
  }
  .chat-main {
    border-radius: 0;
    min-height: 300px;
  }
  .chat-messages {
    padding: 0.5rem 0.2rem 0.5rem 0.2rem;
  }
}
@media (max-width: 600px) {
  .chat-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
    padding: 1rem 0.4rem;
  }
  .chat-messages {
    padding: 0.2rem 0.05rem 0.2rem 0.05rem;
  }
  .chat-message .bubble {
    font-size: 0.95em;
    padding: 0.5rem 0.5rem;
    max-width: 90vw;
  }
  .chat-sidebar {
    height: 80px;
    font-size: 0.92em;
  }
  .chat-listing {
    min-width: 120px;
    max-width: 160px;
    margin: 0.3rem 0.1rem;
    padding: 0.5rem 0.5rem;
  }
  .chat-message .avatar {
    width: 24px;
    height: 24px;
  }
  .chat-container {
    border-radius: 0;
    margin-left: 0;
    margin-right: 0;
    width: 100vw;
    min-width: 100vw;
    max-width: 100vw;
  }
  .chat-main {
    border-radius: 0;
  }
}
@media (max-width: 400px) {
  .chat-message .bubble {
    font-size: 0.88em;
    padding: 0.3rem 0.3rem;
    max-width: 98vw;
  }
  .chat-header {
    padding: 0.5rem 0.1rem;
  }
}
    .chat-message.reply-highlight {
      animation: replyHighlight 1.2s;
      background: #e3f0ff !important;
      box-shadow: 0 0 0 2px #25d36633;
    }
    @keyframes replyHighlight {
      0% { background: #d4f8e8; }
      60% { background: #e3f0ff; }
      100% { background: inherit; }
    }
    .chat-message .reply-context {
      background: #e3f0ff;
      border-left: 3px solid #25d366;
      padding: 0.2em 0.7em;
      border-radius: 0.5em;
      font-size: 0.93em;
      color: #03254c;
      margin-bottom: 0.3em;
      margin-right: 1.5em;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      box-shadow: 0 1px 4px rgba(37,211,102,0.08);
      cursor: pointer;
      transition: box-shadow 0.2s;
    }
    .chat-message .reply-context:hover {
      box-shadow: 0 0 0 2px #25d36666;
    }
</style>
<!-- Add Firebase SDKs before main.js -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
<script src="../../assets/js/firebase-config.js"></script>
<script src="../../js/main.js"></script>
    <script>
    // Enforce authentication on this page
    enforceAuth('/pages/auth/login.html');
    // Setup My Listings link logic
    document.addEventListener('DOMContentLoaded', function() {
        setupMyListingsLink('#myListingsLink', '/pages/auth/login.html', '../../stores/agent-stores/dashboard.html', '../../stores/agent-stores/create.html');
    });
    // Initialize variables
    window.currentUser = null;
    let messaging;
    let conversations = [];
    let selectedConversation = null;
    let unsubscribeMessages = null;
    let typingTimeout;
    let selectedFiles = [];
    let uploadProgress = {};
    let totalUnreadCount = 0;
    let unreadMessagesListener = null;

    const db = firebase.firestore();

    // Show loading spinner while checking auth
    document.body.insertAdjacentHTML('beforeend', '<div id="authLoading" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:2000;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;"><div class="loading-container"><div class="star-loading"><div class="star"></div><div class="star"></div><div class="star"></div></div><div class="loading-text">Loading messaging...</div></div></div>');

    // Initialize file handling elements
    const attachmentBtn = document.getElementById('attachmentBtn');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    
    // Disable attachment button by default
    if (attachmentBtn) {
      attachmentBtn.disabled = true;
    }

    // Enhanced authentication with better user experience
    firebase.auth().onAuthStateChanged(async user => {
      if (!user) {
        console.log('No user logged in, redirecting to login');
        window.location.href = '/pages/auth/login.html';
        return;
      }
      
      // Set current user with enhanced info
      window.currentUser = {
        id: user.uid,
        name: user.displayName || user.email?.split('@')[0] || 'User',
        avatar: user.photoURL || `https://via.placeholder.com/36x36/0d6efd/ffffff?text=${user.email?.charAt(0).toUpperCase() || 'U'}`,
        email: user.email
      };
      
      console.log('User authenticated:', window.currentUser.email);
      
      // Update page title
      document.title = `Messaging - ${window.currentUser.name} | Starlet Properties`;
      
      // Initialize messaging notifications
      try {
        messaging = firebase.messaging();
        const permissionBtn = document.createElement('button');
        permissionBtn.className = 'btn btn-sm btn-outline-primary';
        permissionBtn.innerHTML = '<i class="bi bi-bell"></i> Enable Notifications';
        permissionBtn.onclick = async () => {
          try {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
              const token = await messaging.getToken({ vapidKey: 'YOUR_PUBLIC_VAPID_KEY' });
              await db.collection('users').doc(window.currentUser.id).update({ 
                fcmToken: token,
                notificationSettings: {
                  enabled: true,
                  lastUpdated: new Date()
                }
              });
              permissionBtn.innerHTML = '<i class="bi bi-bell-fill"></i> Notifications Enabled';
              permissionBtn.className = 'btn btn-sm btn-success';
              showToast('Notifications enabled successfully!', 'success');
            }
          } catch (err) { 
            console.warn('FCM permission denied or error', err); 
            showToast('Failed to enable notifications', 'error');
          }
        };
        
        // Add notification button to chat header
        const headerActions = document.createElement('div');
        headerActions.className = 'actions';
        headerActions.appendChild(permissionBtn);
        document.querySelector('.chat-header').appendChild(headerActions);
      } catch (err) { 
        console.warn('FCM not available', err); 
      }
      
      // Add logout button to navbar
      const nav = document.querySelector('.navbar-nav');
      if (nav && !document.getElementById('logoutBtn')) {
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.innerHTML = '<a class="nav-link" href="#" id="logoutBtn" title="Logout"><i class="bi bi-box-arrow-right"></i></a>';
        nav.appendChild(li);
        document.getElementById('logoutBtn').onclick = function(e) {
          e.preventDefault();
          if (confirm('Are you sure you want to logout?')) {
          firebase.auth().signOut();
            showToast('Logging out...', 'info');
          }
        };
      }
      
      // Remove loading screen
      document.getElementById('authLoading').remove();
      
      // Load conversations and handle initial state
      await loadConversations();
      const listingId = getQueryParam('listingId');
      if (listingId) {
        await startConversationForListing(listingId);
      } else if (conversations.length) {
        selectConversation(conversations[0]);
      }
      
      // Set up auto-refresh for conversations
      setInterval(() => {
        if (window.currentUser) {
          loadConversations();
        }
      }, 30000); // Refresh every 30 seconds
      
      // Start listening for unread messages
      startUnreadMessagesListener();
    });

    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function loadConversations() {
      if (!window.currentUser) return;
      const sidebarList = document.getElementById('chatSidebarList');
      if (sidebarList) sidebarList.innerHTML = '<div class="text-center w-100 py-4"><div class="loading-container"><div class="star-loading"><div class="star"></div><div class="star"></div><div class="star"></div></div><div class="loading-text">Loading conversations...</div></div></div>';
      try {
        const convSnap = await db.collection('conversations')
          .where('participants', 'array-contains', window.currentUser.id)
          .orderBy('lastMessageAt', 'desc')
          .limit(20).get();
        
        conversations = [];
        convSnap.forEach(doc => {
          conversations.push({ id: doc.id, ...doc.data() });
        });
        
        if (conversations.length === 0) {
          if (sidebarList) sidebarList.innerHTML = '<div class="text-center w-100 py-4 text-muted">No conversations yet.</div>';
          return;
        }
        
        if (sidebarList) sidebarList.innerHTML = conversations.map((conv, idx) => {
          const unreadCount = conv.unreadCount || 0;
          const lastMessageTime = conv.lastMessageAt ? new Date(conv.lastMessageAt.seconds ? conv.lastMessageAt.seconds * 1000 : conv.lastMessageAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
          
          return `
          <div class="chat-listing${selectedConversation && selectedConversation.id === conv.id ? ' active' : ''}" data-idx="${idx}">
              <img src="${conv.agentAvatar || conv.listerAvatar || 'https://via.placeholder.com/40x40/0d6efd/ffffff?text=A'}" class="rounded-circle" width="40" height="40" alt="Agent">
              <div style="flex: 1; min-width: 0;">
              <div class="chat-listing-title">${conv.listingTitle || 'Listing'}</div>
                <div class="chat-listing-agent">${conv.agentName || conv.listerName || 'Agent'}</div>
                <div class="small text-muted d-flex justify-content-between align-items-center">
                  <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${conv.lastMessage ? conv.lastMessage.slice(0, 25) : 'No messages yet'}</span>
                  <span class="ms-2">${lastMessageTime}</span>
            </div>
          </div>
              ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
            </div>
          `;
        }).join('');
        
        document.querySelectorAll('.chat-listing').forEach(el => {
          el.onclick = () => selectConversation(conversations[parseInt(el.dataset.idx)]);
        });
        
      } catch (err) {
        console.error('Error loading conversations:', err);
        if (sidebarList) sidebarList.innerHTML = '<div class="text-danger text-center">Failed to load conversations. Please try again.</div>';
      }
    }

    // Start listening for unread messages
    function startUnreadMessagesListener() {
      if (!db || !window.currentUser) return;
      // Listen to conversations where current user is a participant
      unreadMessagesListener = db.collection('conversations')
        .where('participants', 'array-contains', window.currentUser.id)
        .onSnapshot(async snap => {
          let totalUnread = 0;
          // For each conversation, count unread messages not sent by the current user
          for (const doc of snap.docs) {
            const convId = doc.id;
            const messagesSnap = await db.collection('conversations').doc(convId)
              .collection('messages')
              .where('read', '==', false)
              .where('senderId', '!=', window.currentUser.id)
              .get();
            totalUnread += messagesSnap.size;
          }
          updateUnreadBadge(totalUnread);
        });
    }

    // Update the unread messages badge
    function updateUnreadBadge(count) {
      const badge = document.getElementById('unreadMessagesBadge');
      if (!badge) return;
      totalUnreadCount = count;
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count.toString();
        badge.classList.remove('d-none');
      } else {
        badge.classList.add('d-none');
      }
    }

    // Clear unread badge when messages page is opened
    function clearUnreadBadge() {
      updateUnreadBadge(0);
    }

    async function selectConversation(conv) {
      selectedConversation = conv;
      
      // Enable input when conversation is selected
      const chatInput = document.getElementById('chatInput');
      const sendButton = document.querySelector('.send-btn');
      const attachmentBtn = document.getElementById('attachmentBtn');
      
      chatInput.disabled = false;
      sendButton.disabled = false;
      attachmentBtn.disabled = false;
      chatInput.placeholder = `Message ${conv.agentName || conv.listerName || 'Agent'}...`;
      
      renderChatHeader();
      loadMessages();
      loadConversations(); // to update active state
      
      // Mark all unread messages as read
      try {
        const msgsSnap = await db.collection('conversations').doc(conv.id)
          .collection('messages')
          .where('read', '==', false)
          .where('senderId', '!=', window.currentUser.id)
          .get();
        
        if (!msgsSnap.empty) {
      const batch = db.batch();
      msgsSnap.forEach(doc => batch.update(doc.ref, { read: true }));
      await batch.commit();
          
          // Update conversation unread count
          await db.collection('conversations').doc(conv.id).update({
            unreadCount: 0
          });
          
          // Clear unread badge when conversation is opened
          clearUnreadBadge();
        }
      } catch (err) {
        console.error('Error marking messages as read:', err);
      }
      
      showToast(`Selected conversation with ${conv.agentName || conv.listerName || 'Agent'}`, 'info');
    }

    function renderChatHeader() {
      const header = document.getElementById('chatHeader');
      if (!selectedConversation) {
        header.innerHTML = '<span class="text-muted">Select a conversation</span>';
        return;
      }
      header.innerHTML = `
        <button class="back-btn" id="backToSidebar" title="Back to conversations" style="display:none;"><i class="bi bi-arrow-left"></i></button>
        <img src="${selectedConversation.agentAvatar || 'https://via.placeholder.com/48x48/0d6efd/ffffff?text=A'}" class="avatar">
        <div class="info">
          <h5>${selectedConversation.agentName || 'Agent'}</h5>
          <p>${selectedConversation.listingTitle || 'Listing'}</p>
        </div>
        <div id="typingIndicator" class="typing-indicator" style="display:none;"></div>
      `;
      // Show back button on mobile
      const backBtn = document.getElementById('backToSidebar');
      if (backBtn) {
        if (window.innerWidth <= 900) {
          backBtn.style.display = 'inline-flex';
          backBtn.onclick = function() {
            document.getElementById('chatSidebar').classList.add('open');
          };
        } else {
          backBtn.style.display = 'none';
        }
      }
      // Listen for typing indicator
      db.collection('conversations').doc(selectedConversation.id).onSnapshot(doc => {
        const data = doc.data();
        const otherId = selectedConversation.participants.find(id => id !== window.currentUser.id);
        const indicator = document.getElementById('typingIndicator');
        if (data && data['typing_' + otherId]) {
          indicator.innerHTML = `Typing <span class="typing-ellipsis"><span></span><span></span><span></span></span>`;
          indicator.style.display = 'flex';
        } else {
          indicator.innerHTML = '';
          indicator.style.display = 'none';
        }
      });
    }

    function renderMessages(messages) {
      const chat = document.getElementById('chatMessages');
      if (!chat) return;
      if (!messages.length) {
        chat.innerHTML = '<div class="text-center text-muted py-5">No messages yet. Say hello!</div>';
        return;
      }
      
      const filtered = messages.filter(msg => 
        msg.senderId === window.currentUser.id || 
        (selectedConversation && selectedConversation.participants && selectedConversation.participants.includes(window.currentUser.id))
      );
      
      chat.innerHTML = filtered.map((msg, idx) => {
        const messageTime = new Date(msg.createdAt.seconds ? msg.createdAt.seconds * 1000 : msg.createdAt);
        const timeString = messageTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const dateString = messageTime.toLocaleDateString();
        const isToday = new Date().toDateString() === messageTime.toDateString();
        
        let statusIcon = '';
        if (msg.senderId === window.currentUser.id) {
          if (msg.read) {
            statusIcon = '<i class="bi bi-check2-all text-success"></i>';
          } else if (msg.delivered) {
            statusIcon = '<i class="bi bi-check2 text-primary"></i>';
          } else {
            statusIcon = '<i class="bi bi-clock text-muted"></i>';
          }
        }
        
        let mediaContent = '';
        if (msg.files && msg.files.length > 0) {
          mediaContent = msg.files.map(file => {
            if (file.type.startsWith('image/')) {
              return `<img src="${file.url}" alt="${file.name}" style="max-width: 100%; border-radius: 0.5rem;">`;
            } else if (file.type.startsWith('video/')) {
              return `<video controls style="max-width: 100%; border-radius: 0.5rem;"><source src="${file.url}" type="${file.type}">Your browser does not support the video tag.</video>`;
            } else {
              return `<a href="${file.url}" class="file-download" target="_blank" download="${file.name}">\n            <i class="${getFileIcon(file.type)}"></i>\n            <div>\n              <div style="font-weight: 500;">${file.name}</div>\n              <div style="font-size: 0.8rem; color: #6c757d;">${formatFileSize(file.size)}</div>\n            </div>\n          </a>`;
            }
          }).join('');
        }
        
        let replyContext = '';
        if (msg.replyTo) {
          // Add a data attribute for reply index
          replyContext = `<div class="reply-context" data-reply-idx="${msg.replyTo.idx ?? ''}" onclick="scrollToReply(this)">${msg.replyTo.text ? msg.replyTo.text : '[Media]'}</div>`;
        }
        
        // Reply button
        const replyBtn = `<button class="reply-btn" title="Reply" onclick="event.stopPropagation();handleReply(${idx});"><i class="bi bi-reply"></i></button>`;
        // Add fade-in class to the last message
        const fadeClass = idx === filtered.length - 1 ? ' fade-in' : '';
        // Fix avatar src: do not use /pages/user/${...}
        const avatarSrc = msg.senderAvatar && !msg.senderAvatar.startsWith('http') ? msg.senderAvatar : (msg.senderAvatar || 'https://via.placeholder.com/36x36/0d6efd/ffffff?text=U');
        return `
        <div class="chat-message${msg.senderId === window.currentUser.id ? ' sent' : ' received'}${fadeClass}">
          <img src="${avatarSrc}" class="avatar">
          <div style="position:relative;">
            <div class="bubble">
              ${replyContext}
              ${msg.text ? `<div>${msg.text}</div>` : ''}
              ${mediaContent ? `<div class="media-content">${mediaContent}</div>` : ''}
              <span class="meta">
                ${isToday ? timeString : dateString + ' ' + timeString}
                ${statusIcon}
              </span>
              ${replyBtn}
            </div>
          </div>
        </div>
        `;
      }).join('');
      chat.scrollTop = chat.scrollHeight;
      enableSwipeToReply();
    }

    function listenForMessages(convId) {
      if (unsubscribeMessages) unsubscribeMessages();
      unsubscribeMessages = db.collection('conversations').doc(convId)
        .collection('messages').orderBy('createdAt')
        .onSnapshot(snap => {
          const messages = [];
          snap.forEach(doc => messages.push(doc.data()));
          renderMessages(messages);
        });
    }

    async function loadMessages() {
      if (!selectedConversation) return;
      listenForMessages(selectedConversation.id);
    }

    document.getElementById('chatInputForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      
      if (!text && selectedFiles.length === 0) return;
      if (!selectedConversation) return;
      
      // Clear input and files immediately for better UX
      input.value = '';
      const filesToSend = [...selectedFiles];
      selectedFiles = [];
      updateFilePreview();
      updateSendButtonState();
      
      // Reset textarea height
      input.style.height = 'auto';
      
      try {
        // Upload files first if any
        const uploadedFiles = [];
        if (filesToSend.length > 0) {
          showToast('Uploading files...', 'info');
          
          for (const file of filesToSend) {
            try {
              const fileUrl = await uploadFile(file);
              uploadedFiles.push({
                name: file.name,
                type: file.type,
                size: file.size,
                url: fileUrl
              });
            } catch (err) {
              console.error('Error uploading file:', err);
              showToast(`Failed to upload ${file.name}`, 'error');
            }
          }
        }
        
        // Create message object
      const msg = {
          text: text || '',
        senderId: window.currentUser.id,
        senderName: window.currentUser.name,
        senderAvatar: window.currentUser.avatar,
          createdAt: new Date(),
          read: false,
          delivered: false
        };
        
        // Add files to message if any were uploaded
        if (uploadedFiles.length > 0) {
          msg.files = uploadedFiles;
          msg.hasMedia = true;
        }
        
        // Add message to Firestore
        const messageRef = await db.collection('conversations').doc(selectedConversation.id)
          .collection('messages').add(msg);
        
        // Update conversation metadata
        const lastMessageText = text || (uploadedFiles.length > 0 ? `Sent ${uploadedFiles.length} file${uploadedFiles.length > 1 ? 's' : ''}` : '');
        await db.collection('conversations').doc(selectedConversation.id).update({
          lastMessage: lastMessageText,
          lastMessageAt: new Date(),
          unreadCount: firebase.firestore.FieldValue.increment(1)
        });
        
        // Mark as delivered after a short delay
        setTimeout(async () => {
          try {
            await messageRef.update({ delivered: true });
      } catch (err) {
            console.error('Error marking message as delivered:', err);
          }
        }, 1000);
        
        showToast('Message sent', 'success');
        
      } catch (err) {
        console.error('Error sending message:', err);
        showToast('Failed to send message. Please try again.', 'error');
        // Restore the message text if sending failed
        input.value = text;
      }
    });
    
    // Upload file to Firebase Storage
    async function uploadFile(file) {
      const storage = firebase.storage();
      const storageRef = storage.ref();
      const fileRef = storageRef.child(`chat-files/${window.currentUser.id}/${Date.now()}-${file.name}`);
      
      const snapshot = await fileRef.put(file);
      const downloadURL = await snapshot.ref.getDownloadURL();
      
      return downloadURL;
    }
    
    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
      toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
      toast.innerHTML = `
        <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
        ${message}
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Start a new conversation if listingId is provided
    async function startConversationForListing(listingId) {
      // Fetch listing info
      const listingDoc = await db.collection('listings').doc(listingId).get();
      if (!listingDoc.exists) return;
      const listing = listingDoc.data();
      // Use listerId from query param if present, otherwise fallback to agentId/createdBy/sellerId/ownerId
      const url = new URL(window.location.href);
      let listerId = url.searchParams.get('listerId') || listing.agentId || listing.createdBy || listing.sellerId || listing.ownerId || (listing.agent && listing.agent.id);
      if (!listerId) {
        alert('Could not determine the seller/lister for this property.');
        return;
      }
      // Prevent self-chat
      if (listerId === window.currentUser.id) {
        alert('You cannot chat with yourself about your own listing.');
        return;
      }
      // Fetch lister info for metadata
      let listerName = '', listerAvatar = '';
      try {
        const listerDoc = await db.collection('users').doc(listerId).get();
        if (listerDoc.exists) {
          const listerData = listerDoc.data();
          listerName = (listerData.firstName || '') + ' ' + (listerData.lastName || '');
          listerAvatar = listerData.avatar || listerData.profilePicture || listerData.photoURL || 'https://via.placeholder.com/40x40/0d6efd/ffffff?text=A';
        }
      } catch (err) {}
      // Find or create conversation for this listing and these participants
      const participants = [window.currentUser.id, listerId].sort();
      const convSnap = await db.collection('conversations')
        .where('listingId', '==', listingId)
        .where('participants', 'array-contains', window.currentUser.id)
        .get();
      let convId = null;
      let found = false;
      convSnap.forEach(doc => {
        const data = doc.data();
        // Ensure both participants and listingId match
        if (data.listingId === listingId &&
            Array.isArray(data.participants) &&
            data.participants.length === 2 &&
            data.participants.includes(window.currentUser.id) &&
            data.participants.includes(listerId)) {
          convId = doc.id;
          found = true;
        }
      });
      if (!found) {
        // Create new conversation document with all required metadata
        const convRef = await db.collection('conversations').add({
          listingId,
          participants,
          lastMessage: '',
          lastMessageAt: new Date(),
          listerId,
          listerName,
          listerAvatar,
          listingTitle: listing.title || 'Listing',
          listingImage: (listing.media && listing.media[0] && listing.media[0].url) || '',
          status: 'active'
        });
        convId = convRef.id;
      }
      // Load conversations and select this one
      await loadConversations();
      const conv = conversations.find(c => c.id === convId);
      if (conv) selectConversation(conv);
    }

    // Function to start conversation with admin
    async function startAdminConversation() {
      if (!window.currentUser) {
        showToast('Please log in to chat with support', 'error');
        return;
      }
      
      showToast('Connecting to support...', 'info');
      
      // Find admin user
      let adminId = null, adminName = 'Admin', adminAvatar = 'https://via.placeholder.com/40x40/0d6efd/ffffff?text=A';
      try {
        const adminSnap = await db.collection('users').where('role', '==', 'admin').limit(1).get();
        if (!adminSnap.empty) {
          const adminDoc = adminSnap.docs[0];
          adminId = adminDoc.id;
          const adminData = adminDoc.data();
          adminName = (adminData.firstName || '') + ' ' + (adminData.lastName || '') || 'Admin';
          adminAvatar = adminData.avatar || adminAvatar;
        }
      } catch (e) {
        console.error('Error finding admin user:', e);
      }
      
      if (!adminId) {
        showToast('Support team is currently unavailable. Please try again later.', 'error');
        return;
      }
      
      // Find or create conversation with admin
      let convId;
      const convSnap = await db.collection('conversations')
        .where('participants', 'array-contains', window.currentUser.id)
        .get();
      let found = false;
      convSnap.forEach(doc => {
        const data = doc.data();
        if (data.participants.includes(adminId) && !data.listingId) {
          convId = doc.id;
          found = true;
        }
      });
      
      if (!found) {
        const convRef = await db.collection('conversations').add({
          participants: [window.currentUser.id, adminId],
          agentId: adminId,
          agentName: adminName,
          agentAvatar: adminAvatar,
          listingTitle: 'Support Chat',
          lastMessage: '',
          lastMessageAt: new Date(),
          isSupportChat: true
        });
        convId = convRef.id;
        
        // Add welcome message for new support chats
        const welcomeMsg = {
          text: `Hello! Welcome to Starlet Properties support. I'm here to help you with any questions about our properties, vehicles, or services. How can I assist you today?`,
          senderId: adminId,
          senderName: adminName,
          senderAvatar: adminAvatar,
          createdAt: new Date(),
          read: false,
          delivered: true,
          isSystemMessage: true
        };
        
        try {
          await db.collection('conversations').doc(convId)
            .collection('messages').add(welcomeMsg);
          
          await db.collection('conversations').doc(convId).update({
            lastMessage: welcomeMsg.text,
            lastMessageAt: new Date()
          });
        } catch (err) {
          console.error('Error adding welcome message:', err);
        }
      }
      
      await loadConversations();
      const conv = conversations.find(c => c.id === convId);
      if (conv) {
        selectConversation(conv);
        showToast('Connected to support team!', 'success');
      } else {
        showToast('Failed to connect to support. Please try again.', 'error');
      }
    }

    // Add click handlers for admin chat buttons
    document.getElementById('chatWithAdminBtn').onclick = startAdminConversation;
    
    // Enhanced floating support button with click animation
    const floatingSupportBtn = document.getElementById('floatingSupportBtn');
    if (floatingSupportBtn) {
      floatingSupportBtn.onclick = function() {
        window.location.href = '/pages/user/messaging.html?support=1';
      };
    }
    
    // File handling functionality
    // Trigger file input when attachment button is clicked
    attachmentBtn.addEventListener('click', () => {
      fileInput.click();
    });
    
    // Handle file selection
    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;
      
      // Validate file types and sizes
      const validFiles = files.filter(file => {
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
          showToast(`File ${file.name} is too large. Maximum size is 10MB.`, 'error');
          return false;
        }
        return true;
      });
      
      if (validFiles.length === 0) return;
      
      // Add files to selected files array
      selectedFiles = selectedFiles.concat(validFiles);
      updateFilePreview();
      
      // Enable send button if there are files or text
      updateSendButtonState();
    });
    
    // Update file preview
    function updateFilePreview() {
      if (selectedFiles.length === 0) {
        filePreview.style.display = 'none';
        return;
      }
      
      filePreview.style.display = 'block';
      filePreview.innerHTML = selectedFiles.map((file, index) => {
        const fileIcon = getFileIcon(file.type);
        const fileSize = formatFileSize(file.size);
        
        return `
          <div class="file-item">
            <div class="file-icon">
              <i class="${fileIcon}"></i>
            </div>
            <div class="file-info">
              <div class="file-name">${file.name}</div>
              <div class="file-size">${fileSize}</div>
            </div>
            <button type="button" class="remove-file" onclick="removeFile(${index})">
              <i class="bi bi-x"></i>
            </button>
          </div>
        `;
      }).join('');
    }
    
    // Remove file from selection
    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updateFilePreview();
      updateSendButtonState();
    }
    
    // Get file icon based on type
    function getFileIcon(type) {
      if (type.startsWith('image/')) return 'bi bi-image';
      if (type.startsWith('video/')) return 'bi bi-camera-video';
      if (type.includes('pdf')) return 'bi bi-file-pdf';
      if (type.includes('word') || type.includes('document')) return 'bi bi-file-word';
      if (type.includes('excel') || type.includes('spreadsheet')) return 'bi bi-file-excel';
      if (type.includes('powerpoint') || type.includes('presentation')) return 'bi bi-file-ppt';
      if (type.includes('text')) return 'bi bi-file-text';
      return 'bi bi-file';
    }
    
    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Update send button state
    function updateSendButtonState() {
      const chatInput = document.getElementById('chatInput');
      const sendButton = document.querySelector('.send-btn');
      const hasText = chatInput.value.trim().length > 0;
      const hasFiles = selectedFiles.length > 0;
      
      sendButton.disabled = !(hasText || hasFiles);
    }
    
    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      updateSendButtonState();
    });

    // Typing indicator logic
    document.getElementById('chatInput').addEventListener('input', function() {
      if (!selectedConversation) return;
      db.collection('conversations').doc(selectedConversation.id).update({ ['typing_' + window.currentUser.id]: true });
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        db.collection('conversations').doc(selectedConversation.id).update({ ['typing_' + window.currentUser.id]: false });
      }, 2000);
    });

    // On page load, check for pending offer and send as first message if needed
    document.addEventListener('DOMContentLoaded', async function() {
      // Clear unread badge when messages page is opened
      clearUnreadBadge();
      
      // Add click handler for messages nav link
      const messagesNavLink = document.getElementById('messagesNavLink');
      if (messagesNavLink) {
        messagesNavLink.addEventListener('click', function(e) {
          // Clear unread badge when clicking the messages link
          clearUnreadBadge();
        });
      }
      
      const url = new URL(window.location.href);
      const makeOffer = url.searchParams.get('makeOffer');
      const pendingOfferRaw = localStorage.getItem('pendingOffer');
      let pendingOffer = null;
      if (makeOffer && pendingOfferRaw) {
        try {
          pendingOffer = JSON.parse(pendingOfferRaw);
        } catch (e) {}
      }
      if (makeOffer && pendingOffer && pendingOffer.listingId && pendingOffer.listerId && pendingOffer.offerAmount) {
        // Wait for auth and conversation to be ready
        const waitForConv = async () => {
          if (!window.currentUser) return setTimeout(waitForConv, 200);
          await startConversationForListing(pendingOffer.listingId);
          // Wait for selectedConversation to be set
          const waitForSelected = async () => {
            if (!selectedConversation) return setTimeout(waitForSelected, 200);
            // Send the offer as the first message
            const offerMsg = {
              text: `I would like to make an offer of UGX ${Number(pendingOffer.offerAmount).toLocaleString()}.`,
              senderId: window.currentUser.id,
              senderName: window.currentUser.name,
              senderAvatar: window.currentUser.avatar,
              createdAt: new Date(),
              isOffer: true,
              offerAmount: Number(pendingOffer.offerAmount)
            };
            try {
              await db.collection('conversations').doc(selectedConversation.id)
                .collection('messages').add(offerMsg);
              await db.collection('conversations').doc(selectedConversation.id).update({
                lastMessage: offerMsg.text,
                lastMessageAt: new Date()
              });
              localStorage.removeItem('pendingOffer');
            } catch (err) {
              alert('Failed to send offer. Please try again.');
            }
          };
          waitForSelected();
        };
        waitForConv();
      }
    });

    // On page load, if ?support=1, start chat with admin
    if (window.location.search.includes('support=1')) {
      document.addEventListener('DOMContentLoaded', function() {
        // Wait for user to be authenticated and conversations loaded
        const tryStartSupport = () => {
          if (window.currentUser && typeof startAdminConversation === 'function') {
            startAdminConversation();
          } else {
            setTimeout(tryStartSupport, 200);
          }
        };
        tryStartSupport();
      });
    }
  </script>
  <script>
// Enhanced My Listings logic (updated for agent-stores dashboard)
document.addEventListener('DOMContentLoaded', function() {
  var myListingsLink = document.getElementById('myListingsLink');
  if (!myListingsLink) return;
  myListingsLink.addEventListener('click', function(e) {
    if (!(window.firebase && firebase.auth && firebase.firestore)) return;
    var user = firebase.auth().currentUser;
    if (!user || user.isAnonymous) {
      window.location.href = '/pages/auth/login.html';
      return;
    }
    e.preventDefault();
    var db = firebase.firestore();
    db.collection('stores').where('ownerId', '==', user.uid).limit(1).get()
      .then(function(querySnapshot) {
        if (!querySnapshot.empty) {
          window.location.href = '/stores/agent-stores/dashboard.html';
        } else {
          db.collection('users').doc(user.uid).get().then(function(userDoc) {
            var userData = userDoc.exists ? userDoc.data() : {};
            if (userData.role === 'agent') {
              window.location.href = '/pages/stores/agent-stores/dashboard.html';
            } else {
              if (confirm('To list your properties, you need to create a store and select an agent tier. Would you like to get started?')) {
                window.location.href = '/pages/stores/agent-stores/create.html';
              }
            }
          });
        }
      })
      .catch(function(err) {
        alert('Error checking your store status: ' + err.message);
      });
  });
    });
  </script>
  <script>
// ... existing code ...
// Sidebar toggle for mobile
    document.addEventListener('DOMContentLoaded', function() {
      var sidebar = document.getElementById('chatSidebar');
      var toggle = document.getElementById('sidebarToggle');
      if (sidebar && toggle) {
        toggle.addEventListener('click', function(e) {
          e.stopPropagation();
          sidebar.classList.toggle('open');
        });
        // Close sidebar when clicking outside
        document.body.addEventListener('click', function(e) {
          if (window.innerWidth <= 900 && sidebar.classList.contains('open')) {
            if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
              sidebar.classList.remove('open');
            }
          }
        });
      }
    });
// ... existing code ...
  </script>
  <script>
// Scroll to replied message and highlight it
function scrollToReply(el) {
  const idx = el.getAttribute('data-reply-idx');
  if (!idx) return;
  const chat = document.getElementById('chatMessages');
  const allMsgs = chat ? Array.from(chat.getElementsByClassName('chat-message')) : [];
  const target = allMsgs[parseInt(idx)];
  if (target) {
    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
    target.classList.add('reply-highlight');
    setTimeout(() => target.classList.remove('reply-highlight'), 1200);
  }
}
  </script>
  <script>
// Handle reply button click
function handleReply(idx) {
  const chat = document.getElementById('chatMessages');
  const allMsgs = chat ? Array.from(chat.getElementsByClassName('chat-message')) : [];
  let text = '';
  if (allMsgs[idx]) {
    const bubble = allMsgs[idx].querySelector('.bubble');
    if (bubble) {
      const txt = bubble.innerText || '';
      text = txt.split('\n')[0];
    }
  }
  replyToMessage = { text, idx };
  showReplyPreview();
}
  </script>
  <script>
// Add swipe-to-reply on mobile
function enableSwipeToReply() {
  const chat = document.getElementById('chatMessages');
  if (!chat) return;
  const messages = chat.getElementsByClassName('chat-message');
  Array.from(messages).forEach((msgEl, idx) => {
    let startX = null;
    let moved = false;
    msgEl.addEventListener('touchstart', function(e) {
      if (e.touches.length === 1) {
        startX = e.touches[0].clientX;
        moved = false;
      }
    });
    msgEl.addEventListener('touchmove', function(e) {
      if (startX !== null && e.touches.length === 1) {
        const dx = e.touches[0].clientX - startX;
        if (dx > 40) {
          moved = true;
          msgEl.style.transform = 'translateX(30px)';
        }
      }
    });
    msgEl.addEventListener('touchend', function(e) {
      if (moved) {
        handleReply(idx);
        setTimeout(() => { msgEl.style.transform = ''; }, 200);
      } else {
        msgEl.style.transform = '';
      }
      startX = null;
      moved = false;
    });
    msgEl.addEventListener('touchcancel', function() {
      msgEl.style.transform = '';
      startX = null;
      moved = false;
    });
  });
}
// Call enableSwipeToReply after rendering messages
function renderMessages(messages) {
  const chat = document.getElementById('chatMessages');
  if (!chat) return;
  if (!messages.length) {
    chat.innerHTML = '<div class="text-center text-muted py-5">No messages yet. Say hello!</div>';
    return;
  }
  
  const filtered = messages.filter(msg => 
    msg.senderId === window.currentUser.id || 
    (selectedConversation && selectedConversation.participants && selectedConversation.participants.includes(window.currentUser.id))
  );
  
  chat.innerHTML = filtered.map((msg, idx) => {
    const messageTime = new Date(msg.createdAt.seconds ? msg.createdAt.seconds * 1000 : msg.createdAt);
    const timeString = messageTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const dateString = messageTime.toLocaleDateString();
    const isToday = new Date().toDateString() === messageTime.toDateString();
    
    let statusIcon = '';
    if (msg.senderId === window.currentUser.id) {
      if (msg.read) {
        statusIcon = '<i class="bi bi-check2-all text-success"></i>';
      } else if (msg.delivered) {
        statusIcon = '<i class="bi bi-check2 text-primary"></i>';
      } else {
        statusIcon = '<i class="bi bi-clock text-muted"></i>';
      }
    }
    
    let mediaContent = '';
    if (msg.files && msg.files.length > 0) {
      mediaContent = msg.files.map(file => {
        if (file.type.startsWith('image/')) {
          return `<img src="${file.url}" alt="${file.name}" style="max-width: 100%; border-radius: 0.5rem;">`;
        } else if (file.type.startsWith('video/')) {
          return `<video controls style="max-width: 100%; border-radius: 0.5rem;"><source src="${file.url}" type="${file.type}">Your browser does not support the video tag.</video>`;
        } else {
          return `<a href="${file.url}" class="file-download" target="_blank" download="${file.name}">\n            <i class="${getFileIcon(file.type)}"></i>\n            <div>\n              <div style="font-weight: 500;">${file.name}</div>\n              <div style="font-size: 0.8rem; color: #6c757d;">${formatFileSize(file.size)}</div>\n            </div>\n          </a>`;
        }
      }).join('');
    }
    
    let replyContext = '';
    if (msg.replyTo) {
      // Add a data attribute for reply index
      replyContext = `<div class="reply-context" data-reply-idx="${msg.replyTo.idx ?? ''}" onclick="scrollToReply(this)">${msg.replyTo.text ? msg.replyTo.text : '[Media]'}</div>`;
    }
    
    // Reply button
    const replyBtn = `<button class="reply-btn" title="Reply" onclick="event.stopPropagation();handleReply(${idx});"><i class="bi bi-reply"></i></button>`;
    // Add fade-in class to the last message
    const fadeClass = idx === filtered.length - 1 ? ' fade-in' : '';
    // Fix avatar src: do not use /pages/user/${...}
    const avatarSrc = msg.senderAvatar && !msg.senderAvatar.startsWith('http') ? msg.senderAvatar : (msg.senderAvatar || 'https://via.placeholder.com/36x36/0d6efd/ffffff?text=U');
    return `
    <div class="chat-message${msg.senderId === window.currentUser.id ? ' sent' : ' received'}${fadeClass}">
      <img src="${avatarSrc}" class="avatar">
      <div style="position:relative;">
        <div class="bubble">
          ${replyContext}
          ${msg.text ? `<div>${msg.text}</div>` : ''}
          ${mediaContent ? `<div class="media-content">${mediaContent}</div>` : ''}
          <span class="meta">
            ${isToday ? timeString : dateString + ' ' + timeString}
            ${statusIcon}
          </span>
          ${replyBtn}
        </div>
      </div>
    </div>
    `;
  }).join('');
  chat.scrollTop = chat.scrollHeight;
  enableSwipeToReply();
}
// ... existing code ...
  </script>
</body>
</html> 
